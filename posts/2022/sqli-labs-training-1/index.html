<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>sqli-labs 实验记录 #1</title><meta content="sqli-labs 实验记录 #1" name=title><meta content=一点点从这个世界上消失。 name=description><meta content=website property=og:type><meta content=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/ property=og:url><meta content="weakptr's blog" property=og:site_name><meta content="sqli-labs 实验记录 #1" property=og:title><meta content=一点点从这个世界上消失。 property=og:description><meta content=https://nnnewb.github.io/image/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/ property=twitter:url><meta content="sqli-labs 实验记录 #1" property=twitter:title><meta content=一点点从这个世界上消失。 property=twitter:description><meta content=https://nnnewb.github.io/image/favicon.ico property=twitter:image><link href=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/ rel=canonical><link rel="shortcut icon" href=https://nnnewb.github.io/image/favicon.ico type=image/x-icon><link href=https://nnnewb.github.io/css/reset.css rel=stylesheet><link href=https://nnnewb.github.io/css/pallete.css rel=stylesheet><link href=https://nnnewb.github.io/css/suCSS.css rel=stylesheet><link href=https://nnnewb.github.io/archive.css rel=stylesheet><link href=https://nnnewb.github.io/style.css rel=stylesheet><script defer src=https://nnnewb.github.io/js/script.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: false }
            ],
            // • rendering keys, e.g.:
            throwOnError: true
        });
    });</script><script src=https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js></script><script>document.addEventListener('DOMContentLoaded', function () {
        // 查找所有具有 'pre' 标签且类名为 'language-mermaid' 的元素
        const mermaidElements = document.getElementsByClassName('language-mermaid');
        for (let i = 0; i < mermaidElements.length; i++) {
            const el = mermaidElements.item(i);
            if (el.tagName === "PRE" && !el.classList.contains('mermaid')) {
                el.innerHTML = el.textContent;
                el.classList.add('mermaid');
            }
        }

        mermaid.initialize({ startOnLoad: true, theme: 'dark', });
    })</script><script>if (window.location.hostname.toLowerCase() !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?dbb9df33a2de52aede8bccd84a7493ad";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }</script><link href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Medium/result.css rel=stylesheet><link href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css rel=stylesheet><body><header><nav id=nav-bar><a href=/> 首页 </a>  /  <a href=/posts/> 文章 </a>  /  <a href=/categories/> 分类 </a>  /  <a href=/tags/> 标签 </a>  /  <a href=/search/> 搜索 </a>  /  <div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://nnnewb.github.io/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://nnnewb.github.io/click.ogg type=audio/ogg></audio></div></nav></header><main><h1>sqli-labs 实验记录 #1</h1><p class=author-line>作于：2022-05-09 17:14 ，预计阅读时间 8 分钟<article><h2 id=qian-yan>前言</h2><p>sqli-labs 是一个开源的 SQL 注入学习平台，最近更新已经是 2014 年了，也是个老项目。不过 sqli-labs 提供的靶场更大，包含 4 个难度级别，每个难度十几题，总共 65 题。<p>感觉会比 dvwa 难一大截，用来学 SQL 注入的玩法肯定是绰绰有余了。<p>本篇应该是 sqli-labs <em>Basic Challenges</em> 系列 WP 的开始。<h2 id=huan-jing-da-jian>环境搭建</h2><h3 id=bu-shu-fang-an>部署方案</h3><p>两种部署方式，一种是在虚拟机里安装 LAMP 环境（包管理或者别的什么一键安装都行），另一种就是 docker 容器化。显然容器化对靶场玩家更友好。所以我选择容器环境。<p>这里使用了一个原 sqli-labs 的分支，<a href=https://github.com/aljavier/sqli-labs>aljavier/sqli-labs</a>，省下自己写 docker-compose 和 dockerfile 找环境适配的时间。未来发现配置有问题再自己改改。<h3 id=xu-ni-ji-huan-jing-zhun-bei>虚拟机环境准备</h3><p>虚拟机系统选 Ubuntu 或者 Debian ，或者随你喜欢。安装 docker 和 docker-compose，具体步骤自己看文档。<p>可能还有些需要准备的东西，如果宿主机上没有的话可以考虑在虚拟机里安装，比如 <code>sqlmap</code> ，还有需要命令行直连 MySQL 的话可以再装个 <code>mycli</code>。其他就是些个人偏好的开发环境，用来写打靶的小工具小脚本什么的。vim 配置 ohmyzsh 这些就不用提了。<h3 id=bu-shu-qi-dong>部署启动</h3><pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>git clone https://ghproxy.com/github.com/aljavier/sqli-labs
</span><span style=color:#fabd2f>cd</span><span style=color:#fdf4c1> sqli-labs
</span><span style=color:#fdf4c1>docker-compose up -d
</span></code></pre><p>我额外干了点可能没必要的事情，因为注意到 <code>index.html</code>、<code>readme.md</code> 之类很多文件都有 <code>x</code> 权限位，这可能是因为在 Windows 上用 Git 提交导致的权限错误，所以我顺便 <code>find . -executable -type f -name '*.html' | xargs -I{} chmod -x</code> 把权限清理了一下。带<code>x</code>权限的文件比较多也不只是<code>html</code>，总之最后是全都去掉了<code>x</code>权限。<p>之所以说没必要是可能影响之后的注入利用，总之这一步随意。<h2 id=chu-tan>初探</h2><h3 id=zong-lan>总览</h3><p><img alt=image-20220509155939222 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509155939222.webp><p>UI设计有点拉。左上角是切换不同难度和重置数据库，可以看到除了 <code>Page-1(Basic Challenges)</code> 还有 3 个难度。<p>下面的脑图就是这个难度下的 <em>关卡</em> 了。<h3 id=less-1-error-based-string>Less-1 Error-Based string</h3><p>随意打开第一题。<p><img alt=image-20220509162045531 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509162045531.webp><p>提示输入数字ID作为参数，提示有点模糊，正确做法是在URL里添加<code>?id=1</code>这样的 query string。上一页有明确提示 <code>single quotes</code>，这里给一个<code>'</code>就会报错：<p><img alt=image-20220509162320625 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509162320625.webp><p>但奇妙的是这里看似是数字型注入，给<code>?id=1 and 1=1</code>正确返回。但如果多测一下<code>?id=1 and 1=0</code>就会发现依然是正确返回，所以造成这一结果应该是 php 5.x 的字符串转数字中丢掉了后面的<code>and 1=1</code>。<p><img alt=image-20220509162647659 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509162647659.webp><p>所以按字符型注入处理即可。确定要补<code>'</code>之后就可以继续了。这题主题是 Error Based，所以我们构造一个 Error Based 注入。<code>?id=1' and extractvalue(1,concat('~',version())) -- </code>。注意<code>--</code>后的空格，浏览器会自动删掉URL前后的空格字符，可以手动在末尾补一个URL编码的空格符<code>%20</code>。<p><img alt=image-20220509163203656 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509163203656.webp><p>到这就完成了利用。<h3 id=less-2-error-based-intiger>Less-2 Error-Based Intiger</h3><p>应该是想写 Integer。<p><img alt=image-20220509163431103 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509163431103.webp><p>初始提示一样，尝试<code>?id=1 and 1=1</code>和<code>?id=1 and 1=0</code>之后发现存在注入，提示 Error-Based，选择和上一题同样的 Payload 去掉<code>'</code>可破。<p><img alt=image-20220509163615943 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509163615943.webp><h3 id=less-3-error-based-single-quotes-with-twist>Less-3 Error-Based Single-quotes with twist</h3><p>一样的提示。<p><img alt=image-20220509163747743 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509163747743.webp><p>但这题有点不一样的地方，尝试<code>?id=1' and 1=1 --%20</code>会发现依然报 SQL 语法错误。<p><img alt=image-20220509164101687 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509164101687.webp><p>试了下<code>?id=1; -- %20</code>。<p><img alt=image-20220509165114088 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509165114088.webp><p>没辙了，看一眼参考答案（源码）。<p><img alt=image-20220509164941721 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509164941721.webp><p>所以是我少给了个<code>)</code>。这时候才后知后觉发现语法错误报错里已经有提示了，<code>near '; -- ') LIMIT 0,1</code>，这里有个右半括号。<p>所以把第一题的 payload 改一下，<code>?id=1') and extractvalue(1,concat('~',version())) --%20</code><p><img alt=image-20220509165259349 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509165259349.webp><p>这关就算 pass 了。<p>教训是不要忽视细节。<h3 id=less-4-error-based-double-quotes>Less-4 Error-Based Double Quotes</h3><p><img alt=image-20220509165419151 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509165419151.webp><p>提示 <code>DoubleQuotes</code>，MySQL 的字符串可以用双引号 <code>"</code>，这里试一下 Payload <code>?id=1" and 1=0</code>。<p><img alt=image-20220509165543942 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509165543942.webp><p>发现有错误，从错误信息来看有个<code>")</code>，我们稍微改下 paylaod 再加上注释符：<code>?id=1") and 1=0; --%20</code><p><img alt=image-20220509165724792 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509165724792.webp><p>成功，现在还是用 <code>extractvalue</code> 提取信息：<code>?id=1") and extractvalue(1,concat('~',version())); --%20</code><p><img alt=image-20220509165834583 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-1/image-20220509165834583.webp><p>成功。<h2 id=zong-jie>总结</h2><p>吸收的教训还是两个字，细心。<p>另外还有个关于 payload 的问题。error-based injection 需要错误回显里给出参数字段的值，满足这个条件的函数不多，我只知道 <code>updatexml</code> 和<code>extractvalue</code>是肯定ok的，前一篇 red tiger 的打靶笔记里记录了另外两种方法（BIGINT UNSIGNED溢出和<code>ST_LongFromGeoHash</code>，溢出法在 5.7好像不行了）但少有用起来。<p>在使用 <code>extractvalue</code> 这个 payload 过程里会有疑问，为什么要有一个<code>concat('~', version())</code> 而不是直接 <code>extractvalue(1,version())</code>？其实实测一下就会发现 dump 出来的数据不完整或者干脆不报错。原因也很简单，<code>extractvalue</code>是个<code>xml</code>函数，第二个参数是<code>xpath</code>。<code>xpath</code>的语法正好会允许很多格式的数据，比如单纯整数或单词，当成合法的<code>xpath</code>表达式。<p>比如上面的 Less-4 ，用 <code>?id=1") and extractvalue(1,database()); --%20</code>这个payload会发现页面不报错，因为<code>database()</code>返回的<code>security</code>正好可以当成<code>xpath</code>表达式被识别，虽然没从第一个参数里提取出任何东西，但也没触发MySQL错误，也就拿不到第二参数的内容了。<p>看似没用的<code>concat('~', col)</code>，但实际上起到一个重要作用。它添加的一个<code>~</code>让参数不论是什么格式，都不能当成<code>xpath</code>识别，也就让 MySQL 能稳定地抛出错误，让我们稳定地从错误信息里拿到<code>extractvalue</code>第二参数的内容。</article><p class=tags-data><a href=/tags/security>/security/</a> <a href=/tags/sqli>/sqli/</a> <a href=/tags/sqli-labs>/sqli-labs/</a></p><script data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg0ODYyMTg=" async crossorigin data-category=Announcements data-category-id=DIC_kwDOF8Bqys4Cegmn data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-mapping=pathname data-reactions-enabled=1 data-repo=nnnewb/nnnewb.github.io data-strict=0 data-theme=noborder_light id=giscus_script src=https://giscus.app/client.js></script></main><footer><hr><div id=footer-container><div><p style=text-align:center>Copyright © 2018-2024 weakptr <a href=mailto:weak_ptr@outlook.com>&lt;weak_ptr@outlook.com></a><p style=text-align:center>Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme, <a rel="noopener noreferrer" href=https://speyll.github.io/suCSS/ target=_blank>suCSS</a> framework & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a>, modified by <a rel="noopener noreferrer" href=https://github.com/nnnewb/ target=_blank>nnnewb</a>.<p style=text-align:center>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.</div></div></footer>