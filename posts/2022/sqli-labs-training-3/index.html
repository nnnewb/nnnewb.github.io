<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>sqli-labs 实验记录 #3</title><meta content="sqli-labs 实验记录 #3" name=title><meta content=一点点从这个世界上消失。 name=description><meta content=website property=og:type><meta content=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/ property=og:url><meta content="weakptr's blog" property=og:site_name><meta content="sqli-labs 实验记录 #3" property=og:title><meta content=一点点从这个世界上消失。 property=og:description><meta content=https://nnnewb.github.io/image/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/ property=twitter:url><meta content="sqli-labs 实验记录 #3" property=twitter:title><meta content=一点点从这个世界上消失。 property=twitter:description><meta content=https://nnnewb.github.io/image/favicon.ico property=twitter:image><link href=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/ rel=canonical><link rel="shortcut icon" href=https://nnnewb.github.io/image/favicon.ico type=image/x-icon><link href=https://nnnewb.github.io/css/reset.css rel=stylesheet><link href=https://nnnewb.github.io/css/pallete.css rel=stylesheet><link href=https://nnnewb.github.io/css/suCSS.css rel=stylesheet><link href=https://nnnewb.github.io/archive.css rel=stylesheet><link href=https://nnnewb.github.io/style.css rel=stylesheet><script defer src=https://nnnewb.github.io/js/script.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: false }
            ],
            // • rendering keys, e.g.:
            throwOnError: true
        });
    });</script><script src=https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js></script><script>document.addEventListener('DOMContentLoaded', function () {
        // 查找所有具有 'pre' 标签且类名为 'language-mermaid' 的元素
        const mermaidElements = document.getElementsByClassName('language-mermaid');
        for (let i = 0; i < mermaidElements.length; i++) {
            const el = mermaidElements.item(i);
            if (el.tagName === "PRE" && !el.classList.contains('mermaid')) {
                el.innerHTML = el.textContent;
                el.classList.add('mermaid');
            }
        }

        mermaid.initialize({ startOnLoad: true, theme: 'dark', });
    })</script><script>if (window.location.hostname.toLowerCase() !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?dbb9df33a2de52aede8bccd84a7493ad";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }</script><link href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Medium/result.css rel=stylesheet><link href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css rel=stylesheet><body><header><nav id=nav-bar><a href=/> 首页 </a>  /  <a href=/posts/> 文章 </a>  /  <a href=/categories/> 分类 </a>  /  <a href=/tags/> 标签 </a>  /  <a href=/search/> 搜索 </a>  /  <div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://nnnewb.github.io/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://nnnewb.github.io/click.ogg type=audio/ogg></audio></div></nav></header><main><h1>sqli-labs 实验记录 #3</h1><p class=author-line>作于：2022-05-11 16:36 ，预计阅读时间 7 分钟<article><h2 id=qian-yan>前言</h2><p>从 sqli-labs 第 11 题开始。后续注入点不再是 query string，还是先拿 sqlmap 解决。题目数量很多区别较小，所以重复的思路可能就略了。<h2 id=less-11>Less-11</h2><p>Error Based 而且注入点是 POST 表单。用<code>'</code>确认<code>password</code>字段也有注入后，尝试手工 bypass 验证：<code>' or 1=1;--</code> 注意注释符后跟一个空格，但不能在输入框写 <code>%20</code>，会被转义成<code>%%20</code>。<p><img alt=image-20220511113730087 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image-20220511113730087.webp><h2 id=less-12>Less-12</h2><p>用<code>"</code>测出引号类型后根据报错内容补一个右括号，最终 payload <code>") or 1=1;--</code> 注意空格。<p><img alt=image-20220511113913798 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image-20220511113913798.webp><h2 id=less-13>Less-13</h2><p>有报错，提示 double injection 。用<code>'</code>测出引号类型，根据错误信息补右括号，<code>') or 1=1;--</code> bypass 成功。<p>也可以用上一篇博客提到的<code>rand</code>+<code>group by</code>报错的方式。但我是真的越来越不懂 double injection 到底是不是特指某种注入技巧了，还是说就没共识大家对 double injection 各自解释？<p><img alt=image-20220511114447196 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image-20220511114447196.webp><h2 id=less-14>Less-14</h2><p>用<code>"</code>测出引号类型，根据报错不用补右括号，<code>" or 1=1;--</code> bypass 成功。<p><img alt=image-20220511114639716 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image-20220511114639716.webp><h2 id=less-15>Less-15</h2><p>布尔盲注，测试<code>'</code>报错，<code>' or 1=1;--</code> bypass 成功。<p>图就略了。<h2 id=less-16>Less-16</h2><p>时间盲注，测试<code>"</code>报错，<code>" or sleep(1);--</code>无效，补右括号，<code>") or sleep(1);--</code> 有效。<h2 id=less-17>Less-17</h2><p>这次的表单是更新密码，表单内容用户名和新密码，没有错误回显。<p>提示 update 注入。update 注入的 SQL 格式化参数的位置一般在 <code>UPDATE tbl SET col=input col2=input ... WHERE ...</code> <code>SET</code> 后面和 <code>WHERE</code> 后面。这里显然 <code>WHERE</code> 后面的是用户名 <code>SET</code> 后面的是新密码。因为没有明确的目标，越权把 admin 用户的密码改了拉倒。<p>先确认注入类型，尝试 <code>admin';-- </code>、<code>admin');-- </code>、<code>admin";-- </code>、<code>admin");-- </code>、<code>admin'));--</code>、<code>admin"));--</code>都无效。这就有点气人了。<p>再试试密码能不能注入，<code>password';--</code>，直接把后面的<code>where</code>全注释掉。<p><img alt=image-20220511144727654 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image-20220511144727654.webp><p>直连 MySQL 验证确认注入生效。<p><img alt=image-20220511144801988 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image-20220511144801988.webp><p>另外也可以用 error based 方式在密码这里注入，爆出 admin 的密码，子查询就行。<h2 id=less-18>Less-18</h2><p>提示 Header Injection，尝试正常密码登陆 <code>admin</code>、<code>password</code> 成功。<p><img alt=image-20220511145044686 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image-20220511145044686.webp><p>界面上分别是 IP 地址和 UA，没有更多提示，也没找到自定义 HTTP 头，所以初步怀疑注入点是在 UA 里。可以选择用 httpie 或者 curl 发个请求测试。我用 httpie 试下。<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>http --form POST </span><span style=color:#b8bb26>'http://localhost/Less-18/'</span><span style=color:#fdf4c1> uname=admin passwd=password submit=Submit </span><span style=color:#b8bb26>"User-Agent:sqli/1.0'"
</span></code></pre><p>返回<pre class=language-html data-lang=html style=color:#fdf4c1aa;background-color:#282828><code class=language-html data-lang=html><span style=color:#83a598>&lt;</span><span style=color:#8ec07c;font-weight:700>font </span><span style=color:#8ec07c>color= </span><span style=color:#b8bb26>"#0000ff"  </span><span style=color:#8ec07c>font size = </span><span style=color:#b8bb26>3 </span><span style=color:#83a598>></span><span>Your User Agent is: sqli/1.0'</span><span style=color:#83a598>&lt;/</span><span style=color:#8ec07c;font-weight:700>font</span><span style=color:#83a598>>&lt;</span><span style=color:#8ec07c;font-weight:700>br</span><span style=color:#83a598>></span><span>You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '172.19.0.1', 'admin')' at line 1</span><span style=color:#83a598>&lt;</span><span style=color:#8ec07c;font-weight:700>br</span><span style=color:#83a598>>&lt;</span><span style=color:#8ec07c;font-weight:700>br</span><span style=color:#83a598>>
</span></code></pre><p>确认存在注入。剩下的事情就很简单了，写个 req.txt 用 <code>sqlmap -r req.txt -p User-Agent -T users --dump</code>爆出用户名密码。<h2 id=less-19>Less-19</h2><p>依然是 Header Injection，提示 <code>Your Referer is ...</code>，注入点应该在 <code>Referer</code> 里，直接把 Less-18 的命令稍微改下。<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>http --form POST </span><span style=color:#b8bb26>'http://localhost/Less-19/'</span><span style=color:#fdf4c1> uname=admin passwd=password submit=Submit </span><span style=color:#b8bb26>"Referer:http://im.hacker/'"
</span></code></pre><p>返回<pre class=language-html data-lang=html style=color:#fdf4c1aa;background-color:#282828><code class=language-html data-lang=html><span style=color:#83a598>&lt;</span><span style=color:#8ec07c;font-weight:700>br</span><span style=color:#83a598>></span><span>Your IP ADDRESS is: 172.19.0.1</span><span style=color:#83a598>&lt;</span><span style=color:#8ec07c;font-weight:700>br</span><span style=color:#83a598>>&lt;</span><span style=color:#8ec07c;font-weight:700>font </span><span style=color:#8ec07c>color= </span><span style=color:#b8bb26>"#FFFF00" </span><span style=color:#8ec07c>font size = </span><span style=color:#b8bb26>3 </span><span style=color:#83a598>>&lt;/</span><span style=color:#8ec07c;font-weight:700>font</span><span style=color:#83a598>>&lt;</span><span style=color:#8ec07c;font-weight:700>font </span><span style=color:#8ec07c>color= </span><span style=color:#b8bb26>"#0000ff"  </span><span style=color:#8ec07c>font size = </span><span style=color:#b8bb26>3 </span><span style=color:#83a598>></span><span>Your Referer is: http://im.hacker/'</span><span style=color:#83a598>&lt;/</span><span style=color:#8ec07c;font-weight:700>font</span><span style=color:#83a598>>&lt;</span><span style=color:#8ec07c;font-weight:700>br</span><span style=color:#83a598>></span><span>You have an error in your SQL syntax; check  the manual that corresponds to your MySQL server version for the right syntax to use near '172.19.0.1')'  at line 1</span><span style=color:#83a598>&lt;</span><span style=color:#8ec07c;font-weight:700>br</span><span style=color:#83a598>>&lt;</span><span style=color:#8ec07c;font-weight:700>br</span><span style=color:#83a598>>&lt;</span><span style=color:#8ec07c;font-weight:700>img </span><span style=color:#8ec07c>src=</span><span style=color:#b8bb26>"../images/flag.jpg" </span><span style=color:#83a598>/>&lt;</span><span style=color:#8ec07c;font-weight:700>br</span><span style=color:#83a598>>
</span></code></pre><p>确认注入ok，接着用 sqlmap 就行。<h2 id=less-20>Less-20</h2><p>提示 Cookie Injection，但是无论登陆成功失败都没有设置 Cookie。尝试随便设置一个 cookie <code>id=...</code>，再刷新页面，并无效果，于是开始怀疑是不是说的 <code>PHPSESSID</code>，再次尝试<code>PHPSESSID=1'"</code>，依然没有作用。发愁。<p>看了眼 Less-20 的源码，发现代码里明确写了 <code>!isset($_COOKIE['uname'])</code>，再试一次<code>uname=admin'</code>。<p><img alt=image-20220511153246874 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image-20220511153246874.webp><p>有效果，问题变成了如何完成注入。审阅源码得知只有满足 <code>isset($_COOKIE['uname'])</code> 和 <code>!isset($_POST['submit'])</code> 的情况下才会进入带查询的分支。所以只需要在这个页面不用<code>ctrl+r</code>（因为会重新POST表单），点地址栏再回车就进入了带查询的页面。<p><img alt=image-20220511160609383 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image-20220511160609383.webp><p>可以看到下方有MySQL的错误信息，接下来只需要用 sqlmap 或者手工构造个 error based 爆破即可。<h2 id=less-21>Less-21</h2><p>依然是 Cookie 注入，但是是 <code>complex</code> 版本，我倒要看看有多复杂。直接上 Less-20 的 <code>uname=admin'</code>。<p><img alt=image-20220511161052493 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image-20220511161052493.webp><p>注意有个特殊的错误信息。<pre style=color:#fdf4c1aa;background-color:#282828><code><span>Issue with your mysql: Illegal mix of collations (gbk_chinese_ci,IMPLICIT) and (latin1_swedish_ci,COERCIBLE) for operation '='
</span></code></pre><p>谷歌搜索可知这是因为查询的字符集有差异，尝试比较<code>gbk_chinese_ci</code>和<code>latin1</code>。这里我们了解下<code>gbk</code>是宽字符集，定长 2 字节，而 <code>latin1</code> 是一个极为特殊的字符集，<code>ascii</code>包括了<code>u+0001~u+0080</code>，<code>latin1</code>正好包括了<code>u+0080~u+00ff</code>，也就是单字节除了<code>0x00</code>外全部都可以解释成 <code>ascii</code> 和 <code>latin1</code> 而不出现编码错误，经常被当成默认字符编码。<p>回到正题，测试中发现<code>'</code>没有报错，所以继续尝试<code>"</code>，依然没报错，问题变得奇怪起来了。直接开始审阅代码。<p><img alt=image-20220511162312174 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image-20220511162312174.webp><p>发现有个 <code>base64_decode</code>，把 <code>payload</code> 编码一下：<code>YWRtaW4nCg</code><p><img alt=image-20220511162411345 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image-20220511162411345.webp><p>报错成功。接下来手工构造一个 error based 注入或者 sqlmap 加上 base64 tamper 即可。<h2 id=less-22>Less-22</h2><p>21和22两题都没法从前端得到太多信息，还是直接看代码。<p><img alt=image-20220511163010736 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image-20220511163010736.webp><p>一个 <code>base64_decode</code> 加上 <code>""</code> 连接，我们编码一下 payload：<code>YWRtaW4iCg</code><p><img alt=image-20220511163108492 src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image-20220511163108492.webp><p>报错成功，接下来手工构造 error based 注入或者 sqlmap 都行，不重复了。<h2 id=zong-jie>总结</h2><p><img alt="sqli-labs page-1" src=https://nnnewb.github.io/posts/2022/sqli-labs-training-3/image.webp><p>至此，整个 sqli-labs page-1 的所有题目就都做完了。<p>自我感觉 sqli 的基础应该是掌握差不多了，也有了信心和耐心。考虑接下来是做 page-2 还是找 xss-labs ，打打 xss 的基础。或者一起来也行，预计 page-2 可能会稍难点，大概，做不过就试试 xss-labs。</article><p class=tags-data><a href=/tags/security>/security/</a> <a href=/tags/sqli>/sqli/</a> <a href=/tags/sqli-labs>/sqli-labs/</a></p><script data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg0ODYyMTg=" async crossorigin data-category=Announcements data-category-id=DIC_kwDOF8Bqys4Cegmn data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-mapping=pathname data-reactions-enabled=1 data-repo=nnnewb/nnnewb.github.io data-strict=0 data-theme=noborder_light id=giscus_script src=https://giscus.app/client.js></script></main><footer><hr><div id=footer-container><div><p style=text-align:center>Copyright © 2018-2024 weakptr <a href=mailto:weak_ptr@outlook.com>&lt;weak_ptr@outlook.com></a><p style=text-align:center>Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme, <a rel="noopener noreferrer" href=https://speyll.github.io/suCSS/ target=_blank>suCSS</a> framework & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a>, modified by <a rel="noopener noreferrer" href=https://github.com/nnnewb/ target=_blank>nnnewb</a>.<p style=text-align:center>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.</div></div></footer>