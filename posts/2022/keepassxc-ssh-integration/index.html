<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>尝鲜keepassxc的ssh集成</title><meta content=尝鲜keepassxc的ssh集成 name=title><meta content=一点点从这个世界上消失。 name=description><meta content=website property=og:type><meta content=https://nnnewb.github.io/posts/2022/keepassxc-ssh-integration/ property=og:url><meta content="weakptr's blog" property=og:site_name><meta content=尝鲜keepassxc的ssh集成 property=og:title><meta content=一点点从这个世界上消失。 property=og:description><meta content=https://nnnewb.github.io/image/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nnnewb.github.io/posts/2022/keepassxc-ssh-integration/ property=twitter:url><meta content=尝鲜keepassxc的ssh集成 property=twitter:title><meta content=一点点从这个世界上消失。 property=twitter:description><meta content=https://nnnewb.github.io/image/favicon.ico property=twitter:image><link href=https://nnnewb.github.io/posts/2022/keepassxc-ssh-integration/ rel=canonical><link rel="shortcut icon" href=https://nnnewb.github.io/image/favicon.ico type=image/x-icon><link href=https://nnnewb.github.io/css/reset.css rel=stylesheet><link href=https://nnnewb.github.io/css/pallete.css rel=stylesheet><link href=https://nnnewb.github.io/css/suCSS.css rel=stylesheet><link href=https://nnnewb.github.io/archive.css rel=stylesheet><link href=https://nnnewb.github.io/style.css rel=stylesheet><script defer src=https://nnnewb.github.io/js/script.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: false }
            ],
            // • rendering keys, e.g.:
            throwOnError: true
        });
    });</script><script src=https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js></script><script>document.addEventListener('DOMContentLoaded', function () {
        // 查找所有具有 'pre' 标签且类名为 'language-mermaid' 的元素
        const mermaidElements = document.getElementsByClassName('language-mermaid');
        for (let i = 0; i < mermaidElements.length; i++) {
            const el = mermaidElements.item(i);
            if (el.tagName === "PRE" && !el.classList.contains('mermaid')) {
                el.innerHTML = el.textContent;
                el.classList.add('mermaid');
            }
        }

        mermaid.initialize({ startOnLoad: true, theme: 'dark', });
    })</script><script>if (window.location.hostname.toLowerCase() !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?dbb9df33a2de52aede8bccd84a7493ad";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }</script><link href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Medium/result.css rel=stylesheet><link href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css rel=stylesheet><body><header><nav id=nav-bar><a href=/> 首页 </a>  /  <a href=/posts/> 文章 </a>  /  <a href=/categories/> 分类 </a>  /  <a href=/tags/> 标签 </a>  /  <a href=/search/> 搜索 </a>  /  <div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://nnnewb.github.io/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://nnnewb.github.io/click.ogg type=audio/ogg></audio></div></nav></header><main><h1>尝鲜keepassxc的ssh集成</h1><p class=author-line>作于：2022-04-21 10:27 ，预计阅读时间 7 分钟<article><h2 id=qian-yan>前言</h2><p>突发奇想，先前一直把密码存在 keepassxc 里，但 SSH 秘钥是存在 keepassxc 的备注里，用的时候还得先复制出来建个文件，虽然只用折腾一次但还是嫌麻烦。<p>于是想到 keepassxc 自带 SSH 集成，于是研究了下怎么用 SSH 集成在 keepassxc 里保存秘钥对，省掉复制出秘钥内容到文件里的过程，还更安全。<h2 id=guo-cheng>过程</h2><h3 id=ping-tai-he-xuan-xing>平台和选型</h3><p>首先确定 keepassxc 和 ssh 运行的平台，keepassxc 本体是支持 Windows/MacOS/Linux 三端的，ssh 在Windows上倒是有几种不同的选型。<p>在 Windows 10 Build 1809 版本之后，Windows 已经内置了 OpenSSH 软件，还在用 PuTTY 的可以省掉 PuTTY 了。<p>旧点的 Windows 可以选择 PuTTY 或者装一个基于 MinGW 的 OpenSSH，如 Git-SCM 自带的 OpenSSH 或者 MSYS2、MinGW64 一类。<h3 id=yuan-li>原理</h3><p>keepassxc 的 ssh 集成本质是主动往 ssh-agent 添加秘钥，ssh 命令从 ssh-agent 读到秘钥，尝试用秘钥连接服务器。表现出的效果就是和直接把秘钥放在 <code>.ssh/id_rsa</code> 也没什么区别。<p>keepassxc 还支持解锁自动添加和锁定时自动删除，还有超时自动删除，安全性会稍再好一点，可惜 Windows 自带的 OpenSSH 不支持使用秘钥时给用户确认（见 issue <a href=https://github.com/PowerShell/Win32-OpenSSH/issues/1056>#1056</a>），导致开启 keepassxc 的确认功能时会添加秘钥失败。<p>至于 ssh-agent 的原理就略过不提了，可以理解成一个秘钥代理，ssh 自动问 ssh-agent 有什么秘钥可用，就像保管钥匙的管家。<h3 id=pei-zhi-openssh>配置 OpenSSH</h3><p>参考 keepassxc 的文档，先启动 Windows 自带的 OpenSSH 的 ssh-agent 服务。<pre class=language-powershell data-lang=powershell style=color:#fdf4c1aa;background-color:#282828><code class=language-powershell data-lang=powershell><span>PS C:\Users\user</span><span style=color:#fe8019>> </span><span style=color:#fabd2f>Get-Service</span><span> ssh</span><span style=color:#fe8019>-</span><span>agent </span><span style=color:#fe8019>| </span><span style=color:#fabd2f>Set-Service </span><span style=color:#fe8019>-</span><span>StartupType Automatic
</span><span>PS C:\Users\user</span><span style=color:#fe8019>> </span><span style=color:#fabd2f>Start-Service</span><span> ssh</span><span style=color:#fe8019>-</span><span>agent
</span></code></pre><p>注意上面的命令需要 <strong>管理员权限</strong> 运行。<p>就是这样！<h3 id=pei-zhi-keepassxc>配置 keepassxc</h3><p>之后在 keepassxc 里打开 ssh 集成，选中 OpenSSH 作为代理。<p><img alt="sshagent application settings" src=https://nnnewb.github.io/posts/2022/keepassxc-ssh-integration/sshagent-application-settings.webp><p>然后添加一个常规的密码记录，在高级里添加秘钥文件，并在 SSH 里启用：<p><img alt="sshagent entry settings" src=https://nnnewb.github.io/posts/2022/keepassxc-ssh-integration/sshagent-entry-settings.webp><p>注意勾选 <code>Add key to agent when database is opened/unlocked</code> 和 <code>Remove key from agent when database is closed/locked</code>，这两个选项会让 keepassxc 解锁的情况下自动在后台添加 SSH 秘钥到 ssh-agent，同时当你关闭 keepassxc 之后 SSH 就无法再从 ssh-agent 拿到秘钥，体验会更自然。<p>如果不勾选这两个选项，也可以手动在设置了 SSH 代理的项目上右击添加到 ssh-agent。<p><img alt="sshagent context menu" src=https://nnnewb.github.io/posts/2022/keepassxc-ssh-integration/sshagent-context-menu.webp><p>这种方式添加到 ssh-agent 的秘钥不会自动从 ssh-agent 删除或自动添加，每次重启都要自己右键添加，比较麻烦。<h3 id=jian-cha>检查</h3><p>如何确认配置正确无误？<p>可以通过几个方面：<ol><li>在设置-SSH代理界面，顶部有个绿条，提示 ”SSH代理连接工作正常！“<li>在命令行运行<code>ssh-add -l</code>，会列出你刚添加的秘钥。<li>尝试<code>ssh</code>连接你的服务器，公钥登陆成功。</ol><p>如果 “SSH 代理连接工作正常” 没出现的话可能是 ssh-agent 服务没启动或者有问题，可以 <code>stop-service ssh-agent</code> 停止 <code>ssh-agent</code> 这个系统服务后再在命令行运行 <code>ssh-agent -d</code>，输出调试日志，看看具体什么问题。<p>如果<code>ssh-add -l</code>没有输出，也是一样，检查<code>ssh-agent</code>是否在运行，如果在运行但依然没有，用<code>-d</code>参数启动 ssh-agent 看看添加秘钥的步骤有什么问题。<p>如果 <code>ssh-add -l</code> 有输出了，但 ssh 连接依然问你要密码，有两种可能：<ol><li>你的 ssh 秘钥有密码保护，一般是 <code>ssh-keygen</code> 的时候设置的。<li>秘钥被拒绝了。</ol><p>有密码保护的秘钥 ssh 命令有提示，注意看 ssh 命令的输出就行。秘钥被拒绝的情况表面很难看出来，可以用 <code>-vvv</code> 参数再运行 ssh 命令，看命令输出。<p><img alt=image-20220421101423653 src=https://nnnewb.github.io/posts/2022/keepassxc-ssh-integration/image-20220421101423653.webp><p><img alt=image-20220421101509008 src=https://nnnewb.github.io/posts/2022/keepassxc-ssh-integration/image-20220421101509008.webp><p><img alt=image-20220421101612311 src=https://nnnewb.github.io/posts/2022/keepassxc-ssh-integration/image-20220421101612311.webp><p>如果 <code>will attempt key</code> 没有出现 <code>ssh-add -l</code> 列出的秘钥，还可能是因为 <code>.ssh/config</code> 里，给你要连接的 Host 设置了 <code>IdentitiesOnly yes</code>。这个设置项会强制 ssh 只使用本地的 <code>.ssh/id_rsa</code> 等私钥文件。<p>另外 <code>.ssh/config</code> 里可能还指定了别的验证方式也会导致不使用公钥，这就要靠自己检查 <code>.ssh/config</code> 来排错了。<h3 id=pei-zhi-git>配置 Git</h3><p>Windows 下还有个坑，在提交博客的时候才发现。 Git-SCM 默认使用的 SSH 命令不是 Windows 自带的 OpenSSH。这会导致 Git 在推送的时候不使用我们添加到 ssh-agent （Windows 自带的 OpenSSH 版 ssh-agent）的秘钥，而是用 Git-SCM 自带的 MinGW 版 OpenSSH，造成推送时提示 <code>Permission Denied (publickey)</code> 。<p>解决办法也很简单，<code>git config --global core.SshCommand "C:/Windows/System32/OpenSSH/ssh.exe"</code> 把 Windows 自带的 OpenSSH 设置成 Git 默认使用的 ssh 即可。需要注意 <strong>这里的路径用正斜杠<code>/</code>分隔，不要用反斜杠<code>\</code></strong> 。<h2 id=zong-jie>总结</h2><p>总的来说用 ssh-agent 配合 keepassxc 玩 ssh 还是很舒服的，特别是迁移起来的时候，只要同步和备份 keepassxc 的数据库就完事。<p>keepassxc 的附加文件也非常适合把 GPG 之类的秘钥备份起来，换工作机或者自己电脑重装迁移的时候都能省不少心思。</article><p class=tags-data><a href=/tags/keepassxc>/keepassxc/</a> <a href=/tags/ssh>/ssh/</a></p><script data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg0ODYyMTg=" async crossorigin data-category=Announcements data-category-id=DIC_kwDOF8Bqys4Cegmn data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-mapping=pathname data-reactions-enabled=1 data-repo=nnnewb/nnnewb.github.io data-strict=0 data-theme=noborder_light id=giscus_script src=https://giscus.app/client.js></script></main><footer><hr><div id=footer-container><div><p style=text-align:center>Copyright © 2018-2024 weakptr <a href=mailto:weak_ptr@outlook.com>&lt;weak_ptr@outlook.com></a><p style=text-align:center>Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme, <a rel="noopener noreferrer" href=https://speyll.github.io/suCSS/ target=_blank>suCSS</a> framework & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a>, modified by <a rel="noopener noreferrer" href=https://github.com/nnnewb/ target=_blank>nnnewb</a>.<p style=text-align:center>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.</div></div></footer>