<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>802和以太网协议概览</title><meta content=802和以太网协议概览 name=title><meta content=一点点从这个世界上消失。 name=description><meta content=website property=og:type><meta content=https://nnnewb.github.io/posts/2023/2023-03-16-802he-yi-tai-wang-xie-yi-gai-lan/ property=og:url><meta content="weakptr's blog" property=og:site_name><meta content=802和以太网协议概览 property=og:title><meta content=一点点从这个世界上消失。 property=og:description><meta content=https://nnnewb.github.io/image/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nnnewb.github.io/posts/2023/2023-03-16-802he-yi-tai-wang-xie-yi-gai-lan/ property=twitter:url><meta content=802和以太网协议概览 property=twitter:title><meta content=一点点从这个世界上消失。 property=twitter:description><meta content=https://nnnewb.github.io/image/favicon.ico property=twitter:image><link href=https://nnnewb.github.io/posts/2023/2023-03-16-802he-yi-tai-wang-xie-yi-gai-lan/ rel=canonical><link rel="shortcut icon" href=https://nnnewb.github.io/image/favicon.ico type=image/x-icon><link href=https://nnnewb.github.io/css/reset.css rel=stylesheet><link href=https://nnnewb.github.io/css/pallete.css rel=stylesheet><link href=https://nnnewb.github.io/css/suCSS.css rel=stylesheet><link href=https://nnnewb.github.io/archive.css rel=stylesheet><link href=https://nnnewb.github.io/style.css rel=stylesheet><script defer src=https://nnnewb.github.io/js/script.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: false }
            ],
            // • rendering keys, e.g.:
            throwOnError: true
        });
    });</script><script src=https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js></script><script>document.addEventListener('DOMContentLoaded', function () {
        // 查找所有具有 'pre' 标签且类名为 'language-mermaid' 的元素
        const mermaidElements = document.getElementsByClassName('language-mermaid');
        for (let i = 0; i < mermaidElements.length; i++) {
            const el = mermaidElements.item(i);
            if (el.tagName === "PRE" && !el.classList.contains('mermaid')) {
                el.innerHTML = el.textContent;
                el.classList.add('mermaid');
            }
        }

        mermaid.initialize({ startOnLoad: true, theme: 'dark', });
    })</script><script>if (window.location.hostname.toLowerCase() !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?dbb9df33a2de52aede8bccd84a7493ad";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }</script><link href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Medium/result.css rel=stylesheet><link href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css rel=stylesheet><body><header><nav id=nav-bar><a href=/> 首页 </a>  /  <a href=/posts/> 文章 </a>  /  <a href=/categories/> 分类 </a>  /  <a href=/tags/> 标签 </a>  /  <a href=/search/> 搜索 </a>  /  <div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://nnnewb.github.io/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://nnnewb.github.io/click.ogg type=audio/ogg></audio></div></nav></header><main><h1>802和以太网协议概览</h1><p class=author-line>作于：2023-03-16 23:36 ，预计阅读时间 7 分钟<article><h2 id=qian-yan>前言</h2><p>目前的工作内容除了后端增删改查外多了一些比较有意思的内容，主要是网络方面。搞了几个月，感觉有学到点东西。就当是整理自己的知识体系，后面准备写一系列笔记，关于 Linux/Windows 网络相关的东西，从运维到开发各方面吧。<h2 id=shu-ju-lian-lu-ceng-xie-yi>数据链路层协议</h2><h3 id=yi-xie-shu-yu>一些术语</h3><table><thead><tr><th>术语<th>解读<tbody><tr><td>MAC<td>Media Access Control addressing<tr><td>FCS<td>Frame Check Sequence (CRC)<tr><td>CRC<td>Cyclic Redundancy Check<tr><td>LPDU<td>An LLC frame is called LLC Protocol Data Unit (LPDU)<tr><td>DIX<td>Digital Equipment Corporation, Intel and Xerox</table><h3 id=ethernet-ii>Ethernet II</h3><p>区别于 IEEE 802.3 标准集里的以太网协议，Ethernet II 也称 DIX ethernet ，最初由迪吉多（Digital Equipment Corporation）、因特尔（Intel）、和施乐公司（Xerox）为主要参与者制定。和 IEEE 802.3 主要差别在于以太网帧头部的 Ether Type 字段的两个字节如何释义。Ethernet II 解释为 Ether Type，而 IEEE 802.3 解释为 Length 。<p><img alt="Ethernet II Frame" src=https://nnnewb.github.io/posts/2023/2023-03-16-802he-yi-tai-wang-xie-yi-gai-lan/2560px-Ethernet_Type_II_Frame_format.svg.webp><p>另外除了上面同位置字段的释义差别，还有就是在 Ethernet II 格式中 payload 部分的开头，IEEE 802.3 加入了 802.2 LLC 头。<h3 id=802-3-yi-tai-wang-xie-yi>802.3 以太网协议</h3><p>802.3 以太网帧格式比 Ethernet 2 更复杂一点。<p><img alt=802.3以太网帧格式 src=https://nnnewb.github.io/posts/2023/2023-03-16-802he-yi-tai-wang-xie-yi-gai-lan/802.3%E4%BB%A5%E5%A4%AA%E7%BD%91%E5%B8%A7%E6%A0%BC%E5%BC%8F.drawio.webp><p>帧头部分除 LENGTH/Ether Type 不同，都和 Ethernet II 没区别，主要关注 LLC 和 SNAP 这两部分。<h4 id=802-2-llc-logical-link-control>802.2 LLC - Logical Link Control</h4><p>802.2 LLC 直译过来就是逻辑链路控制。参考 <a href=https://www.cisco.com/c/en/us/support/docs/ibm-technologies/logical-link-control-llc/12247-45.html>Understanding Logic Link Control - Cisco</a> 这篇文章。历史上，IBM 最初把 LLC 设计成 IBM 令牌环网络的一个子层。<p>LLC如前面图中所示分为 <code>DSAP</code>（Destination Service Access Point）、<code>SSAP</code>（Source Service Access Point）和<code>CNTL</code>（Control）三个字段。<code>DSAP</code>和<code>SSAP</code>表示的是创建消息的网络层实体的逻辑地址，具体每个位怎么定义参考前面的链接。一般承载 IP 报文的 LPDU 里 <code>DSAP</code> 和 <code>SSAP</code> 都定义为 <code>0xAA</code> ，<code>CNTL</code> 则定义为 <code>03</code> （参考 《TCP/IP 详解卷一：协议》）。<p>平时不怎么会折腾这个字段，除非很深度玩 L2 设备或协议或者需要解析或者手写 Ethernet 帧的时候可能会需要注意下。目前没这需求，现学现卖即可。<h4 id=802-2-snap-sub-network-access-protocol>802.2 SNAP - Sub-Network Access Protocol</h4><p>802.2 SNAP 替代了 Ethernet II 帧格式里的 Ether Type 字段，加了个比较见鬼的 <code>ORG CODE</code> ，于是又变成了历史遗留问题。真就觉得自己公司千秋万代了呗。<p><code>ORG CODE</code> 参考 <a href=https://www.rfc-editor.org/rfc/rfc1340>RFC 1340 - ASSIGNED NUMBERS</a> 。一般就置 0 。<code>TYPE</code> 字段则和 Ethernet II 的 Ether Type 字段取值一样。取值可以参考 <a href=https://en.wikipedia.org/wiki/EtherType>Ether Type - Wikipedia</a> ，比如 IPv4 是 <code>0x0800</code>，ARP 是 <code>0x0806</code>，IPv6 是 <code>0x86DD</code> 。<h4 id=802-1q-vlanxie-yi>802.1Q VLAN协议</h4><p>802.1Q 协议和 802.3 以太网帧区别在于 Ether Type/Length 和 Source MAC 之间加入了一个 4 字节的 802.1Q Header 。<p><img alt="802.1Q Tagging" src=https://nnnewb.github.io/posts/2023/2023-03-16-802he-yi-tai-wang-xie-yi-gai-lan/2560px-Ethernet_802.1Q_Insert.svg.webp><p>802.1Q Header 中 TPID (Tag Protocol Identifier)占用原 Ether Type 位置，取值 <code>0x8100</code>。正好起到和 Ether Type 一样的作用。<p>随后的3比特表示 <a href=https://en.wikipedia.org/wiki/Class_of_service>802.1p class of service</a> ，理解为优先级。下一比特是 Drop Eligible Indicator，表示拥塞时是否允许丢弃包。这4个比特位都用于拥塞控制。<p>剩下12个比特位表示 VID，或者说 VLAN ID，用于区分 VLAN。<p>后面的 Ether Type 字段和 Payload 就和 802.3 Ethernet 没什么区别了，可以解析为 Ethernet II 也可以解析为 802.3 Ethernet。<h3 id=hub-ji-xian-qi>Hub 集线器</h3><p>集线器就像是把网线给串联起来，集线器上一台设备发出的以太网帧，所有设备都会收到。<p>就是这种设备，靠 802.3 CSMA/CD 也能支撑基本的数据链路层通信。<h3 id=l2-jiao-huan-ji>L2 交换机</h3><p>L2 交换机是在以太网帧这一层的交换，按照以太网帧头部中的控制字段来决定把帧转发到哪个网口。为了实现这个目的，L2交换机还得能“学习”到每个网口连接的设备 MAC 地址是什么，以便做转发动作。<p>L2 交换机和路由器的最大区别在于交换机是根据 MAC 地址做的转发，计算机在以 IP 协议访问局域网设备时，会通过 ARP 协议获取目的 MAC 地址，然后直接构造以太网帧发送。交换机可以直接把以太网帧送给对应的设备而无需经过路由器解析 IP 报文再封包以太网帧。可以说交换机性能决定了局域网传输的速度。<p>这篇文章介绍了交换机是怎么学习 MAC 地址的 <a href=https://www.computernetworkingnotes.com/ccna-study-guide/how-switch-learns-the-mac-addresses-explained.html>How Switch learns the MAC addresses Explained</a> 。<p>有些高级点的交换机还支持 VLAN 虚拟局域网，允许把交换机上几十个口再划分成更小的局域网以实现网络隔离。同时 VLAN 技术也让一张网卡一条网线接入多个局域网成为可能。<h2 id=zong-jie>总结</h2><p>一千来个字憋一两周，这工作要命，没时间看书没时间学习。</article><p class=tags-data><a href=/tags/network>/network/</a></p><script data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg0ODYyMTg=" async crossorigin data-category=Announcements data-category-id=DIC_kwDOF8Bqys4Cegmn data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-mapping=pathname data-reactions-enabled=1 data-repo=nnnewb/nnnewb.github.io data-strict=0 data-theme=noborder_light id=giscus_script src=https://giscus.app/client.js></script></main><footer><hr><div id=footer-container><div><p style=text-align:center>Copyright © 2018-2024 weakptr <a href=mailto:weak_ptr@outlook.com>&lt;weak_ptr@outlook.com></a><p style=text-align:center>Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme, <a rel="noopener noreferrer" href=https://speyll.github.io/suCSS/ target=_blank>suCSS</a> framework & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a>, modified by <a rel="noopener noreferrer" href=https://github.com/nnnewb/ target=_blank>nnnewb</a>.<p style=text-align:center>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.</div></div></footer>