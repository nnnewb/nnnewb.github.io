<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>Django 的各种关系字段详解</title><meta content="Django 的各种关系字段详解" name=title><meta content=一点点从这个世界上消失。 name=description><meta content=website property=og:type><meta content=https://nnnewb.github.io/posts/2019/2019-03-06-djangoguan-xi-zi-duan/ property=og:url><meta content="weakptr's blog" property=og:site_name><meta content="Django 的各种关系字段详解" property=og:title><meta content=一点点从这个世界上消失。 property=og:description><meta content=https://nnnewb.github.io/image/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nnnewb.github.io/posts/2019/2019-03-06-djangoguan-xi-zi-duan/ property=twitter:url><meta content="Django 的各种关系字段详解" property=twitter:title><meta content=一点点从这个世界上消失。 property=twitter:description><meta content=https://nnnewb.github.io/image/favicon.ico property=twitter:image><link href=https://nnnewb.github.io/posts/2019/2019-03-06-djangoguan-xi-zi-duan/ rel=canonical><link rel="shortcut icon" href=https://nnnewb.github.io/image/favicon.ico type=image/x-icon><link href=https://nnnewb.github.io/css/reset.css rel=stylesheet><link href=https://nnnewb.github.io/css/pallete.css rel=stylesheet><link href=https://nnnewb.github.io/css/suCSS.css rel=stylesheet><link href=https://nnnewb.github.io/archive.css rel=stylesheet><link href=https://nnnewb.github.io/style.css rel=stylesheet><script defer src=https://nnnewb.github.io/js/script.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: false }
            ],
            // • rendering keys, e.g.:
            throwOnError: true
        });
    });</script><script src=https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js></script><script>document.addEventListener('DOMContentLoaded', function () {
        // 查找所有具有 'pre' 标签且类名为 'language-mermaid' 的元素
        const mermaidElements = document.getElementsByClassName('language-mermaid');
        for (let i = 0; i < mermaidElements.length; i++) {
            const el = mermaidElements.item(i);
            if (el.tagName === "PRE" && !el.classList.contains('mermaid')) {
                el.innerHTML = el.textContent;
                el.classList.add('mermaid');
            }
        }

        mermaid.initialize({ startOnLoad: true, theme: 'dark', });
    })</script><script>if (window.location.hostname.toLowerCase() !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?dbb9df33a2de52aede8bccd84a7493ad";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }</script><link href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Medium/result.css rel=stylesheet><link href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css rel=stylesheet><body><header><nav id=nav-bar><a href=/> 首页 </a>  /  <a href=/posts/> 文章 </a>  /  <a href=/categories/> 分类 </a>  /  <a href=/tags/> 标签 </a>  /  <a href=/search/> 搜索 </a>  /  <div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://nnnewb.github.io/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://nnnewb.github.io/click.ogg type=audio/ogg></audio></div></nav></header><main><h1>Django 的各种关系字段详解</h1><p class=author-line>作于：2019-03-06 21:11 ，预计阅读时间 7 分钟<article><blockquote><p>参考资料如下<ul><li><a href=https://docs.djangoproject.com/zh-hans/2.1/ref/models/fields/>Django 文档 - Model field reference</a><li><a href=https://graycarl.me/2014/03/24/sqlalchemy-cascade-delete.html>SQLAlchemy 中的级联删除</a></ul></blockquote><h2 id=1-foreignkey>1. ForeignKey</h2><p><code>ForeignKey</code>用于多对一关系，直接对应到数据库外键的概念。使用<code>ForeignKey</code>需要指定引用的目标表，会自动关联到目标表的主键（一般是<code>id</code>字段）。<p>例子如下。<pre class=language-python data-lang=python style=color:#fdf4c1aa;background-color:#282828><code class=language-python data-lang=python><span style=color:#fa5c4b>from </span><span>django.db </span><span style=color:#fa5c4b>import </span><span>models
</span><span>
</span><span style=color:#fa5c4b>class </span><span style=color:#8ec07c>Child</span><span>(</span><span style=color:#8ec07c>models.Model</span><span>):
</span><span>    parent </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>models.ForeignKey(</span><span style=color:#b8bb26>'Parent'</span><span style=color:#fdf4c1>, on_delete</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>models.CASCADE, )
</span><span>    </span><span style=color:#928374;font-style:italic># ...
</span><span>
</span><span style=color:#fa5c4b>class </span><span style=color:#8ec07c>Parent</span><span>(</span><span style=color:#8ec07c>models.Model</span><span>):
</span><span>    </span><span style=color:#928374;font-style:italic># ...
</span><span>    </span><span style=color:#fa5c4b>pass
</span></code></pre><p>对比之 sqlalchemy，一行<code>parent=models.ForeignKey(...)</code>包含了 sqlalchemy 中的<code>ForeignKey</code>和<code>relationship</code>两部分内容。<h3 id=1-1-can-shu-on-delete>1.1 参数：on_delete</h3><p><code>on_delete</code>意为当<code>ForeignKey</code>引用的对象被删除时进行的操作。<p>有几个可以考虑的选项。<h4 id=1-1-1-models-cascade>1.1.1 models.CASCADE</h4><p><code>CASCADE</code>意为级联，<code>on_delete</code>设置为<code>CASCADE</code>时意为执行级联删除。依据文档，Django 会模仿 SQL 的<code>ON DELETE CASCADE</code>，对包含了<code>ForeignKey</code>的对象执行删除。<p>需要注意的是不会调用被级联删除对象上的<code>model.delete()</code>，但是会发送<a href=https://docs.djangoproject.com/zh-hans/2.1/ref/signals/#django.db.models.signals.pre_delete><code>pre_delete</code></a>和<a href=https://docs.djangoproject.com/zh-hans/2.1/ref/signals/#django.db.models.signals.post_delete><code>post_delete</code></a>信号。<h4 id=1-1-1-2-models-protect>1.1.1.2 models.PROTECT</h4><p><code>PROTECT</code>意为保护，<code>on_delete</code>设置为<code>PROTECT</code>意味着要阻止删除操作发生。删除关联的对象时，<code>ForeignKey</code>的<code>on_delete</code>设置为<code>PROTECT</code>会触发<code>ProtectedError</code>。<h4 id=1-1-1-3-models-set-null>1.1.1.3 models.SET_NULL</h4><p>如其名所述，如果这个<code>ForeignKey</code>是 nullable 的，则关联的对象删除时将外键设置为 null。<h4 id=1-1-1-4-models-set-default>1.1.1.4 models.SET_DEFAULT</h4><p>如其名所述，如果这个<code>ForeignKey</code>设置了<code>DEFAULT</code>，则关联的对象删除时设置这个外键为<code>DEFAULT</code>值。<h4 id=1-1-1-5-models-set>1.1.1.5 models.SET</h4><p>在关联的对象删除时，设置为一个指定的值。这个参数可以接受一个可以赋值给这个 ForeignKey 的对象或者一个可调用对象。<p>官方例子如下。<pre class=language-python data-lang=python style=color:#fdf4c1aa;background-color:#282828><code class=language-python data-lang=python><span style=color:#fa5c4b>from </span><span>django.conf </span><span style=color:#fa5c4b>import </span><span>settings
</span><span style=color:#fa5c4b>from </span><span>django.contrib.auth </span><span style=color:#fa5c4b>import </span><span>get_user_model
</span><span style=color:#fa5c4b>from </span><span>django.db </span><span style=color:#fa5c4b>import </span><span>models
</span><span>
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>get_sentinel_user</span><span>():
</span><span>    </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>get_user_model().objects.get_or_create(username</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>'deleted'</span><span style=color:#fdf4c1>)</span><span>[</span><span style=color:#d3869b>0</span><span>]
</span><span>
</span><span style=color:#fa5c4b>class </span><span style=color:#8ec07c>MyModel</span><span>(</span><span style=color:#8ec07c>models.Model</span><span>):
</span><span>    user </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>models.ForeignKey(
</span><span style=color:#fdf4c1>        settings.AUTH_USER_MODEL,
</span><span style=color:#fdf4c1>        on_delete</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>models.SET(get_sentinel_user),
</span><span style=color:#fdf4c1>    )
</span></code></pre><h4 id=1-1-1-6-models-do-nothing>1.1.1.6 models.DO_NOTHING</h4><p>应该不用多说了吧。Django 不会做多余的事情，但是如果后端的数据库服务有强制完整性约束，除非你在数据库一端自己定义了<code>ON DELETE</code>，否则会触发<code>IntegrityError</code>。<h3 id=1-2-can-shu-limited-choice-to>1.2 参数：limited_choice_to</h3><p>强制约束为 django.admin 或者 ModelForm 渲染时提供有限的可选项。<p>接受参数为<code>dict</code>或者<code>Q</code>对象、返回<code>Q</code>对象的可调用对象。<p>官方例子。<pre class=language-python data-lang=python style=color:#fdf4c1aa;background-color:#282828><code class=language-python data-lang=python><span>staff_member </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>models.ForeignKey(
</span><span style=color:#fdf4c1>    User,
</span><span style=color:#fdf4c1>    on_delete</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>models.CASCADE,
</span><span style=color:#fdf4c1>    limit_choices_to</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>{</span><span style=color:#b8bb26>'is_staff'</span><span style=color:#fdf4c1>: </span><span style=color:#d3869b>True</span><span style=color:#fdf4c1>},
</span><span style=color:#fdf4c1>)
</span></code></pre><p>Q 对象是什么玩意儿这个我搞明白了再说...<h3 id=1-3-can-shu-related-name>1.3 参数：related_name</h3><p>设置反向关联的字段名，和<code>sqlalchemy</code>的<code>backref</code>类似。<p>举例来说。<pre class=language-python data-lang=python style=color:#fdf4c1aa;background-color:#282828><code class=language-python data-lang=python><span style=color:#fa5c4b>class </span><span style=color:#8ec07c>Child</span><span>(</span><span style=color:#8ec07c>models.Model</span><span>):
</span><span>    parent </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>models.ForeignKey(</span><span style=color:#b8bb26>'Parent'</span><span style=color:#fdf4c1>)
</span><span>
</span><span style=color:#fa5c4b>class </span><span style=color:#8ec07c>Parent</span><span>(</span><span style=color:#8ec07c>models.Model</span><span>):
</span><span>    </span><span style=color:#fa5c4b>pass
</span><span>
</span><span style=color:#fdf4c1>Parent.child_set.all() </span><span style=color:#928374;font-style:italic># 未设置 related_name
</span><span style=color:#fdf4c1>Parent.children.all() </span><span style=color:#928374;font-style:italic># 设置 related_name=children
</span></code></pre><h3 id=1-4-can-shu-related-query-name>1.4 参数：related_query_name</h3><p>related_query_name 和 related_name 类似，设置反向引用查询时条件的前缀名。举例来说。<pre class=language-python data-lang=python style=color:#fdf4c1aa;background-color:#282828><code class=language-python data-lang=python><span style=color:#fa5c4b>class </span><span style=color:#8ec07c>Child</span><span>(</span><span style=color:#8ec07c>models.Model</span><span>):
</span><span>    parent </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>models.ForeignKey(</span><span style=color:#b8bb26>'Parent'</span><span style=color:#fdf4c1>)
</span><span>    name </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>models.CharField(max_length</span><span style=color:#fe8019>=</span><span style=color:#d3869b>4</span><span style=color:#fdf4c1>)
</span><span>
</span><span style=color:#fa5c4b>class </span><span style=color:#8ec07c>Parent</span><span>(</span><span style=color:#8ec07c>models.Model</span><span>):
</span><span>    </span><span style=color:#fa5c4b>pass
</span><span>
</span><span style=color:#fdf4c1>Parent.objects.filter(Child__name</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>'沙雕网友'</span><span style=color:#fdf4c1>) </span><span style=color:#928374;font-style:italic># 未设置 related_query_name
</span><span style=color:#fdf4c1>Parent.objects.filter(myboy__name</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>'沙雕网友'</span><span style=color:#fdf4c1>) </span><span style=color:#928374;font-style:italic># 设置 related_query_name=myboy
</span></code></pre><h3 id=1-5-can-shu-to-field>1.5 参数：to_field</h3><p>得到<code>ForeignKey</code>关联的模型的字段，默认是主键，如果指定的不是主键那么必须有<code>unique</code>约束才行。<h3 id=1-6-can-shu-db-constraint>1.6 参数：db_constraint</h3><p>要不要创建数据库层级的约束，也就是通过后端数据库服务确保数据完整性不受破坏。如果设置为 False 那么访问不存在的对象时会触发 DoesNotExists 异常。<h3 id=1-7-can-shu-swappable>1.7 参数：swappable</h3><p>用于处理“我有一个抽象类模型但是这个模型有一个外键”的情况，典型就是<code>AUTH_USER_MODEL</code>。<p>一般不用改到，这个属性控制了数据库迁移时如何处理这个外键关联的表，总之保持默认值就行了。<p>这个功能支持了使用自定义的用户模型替代 <code>django.auth.models.User</code> 之类的玩意儿。<h2 id=2-onetoonefield>2. OneToOneField</h2><p><code>OneToOneField</code> 基本就是一个加了<code>unique</code>约束的<code>ForeignKey</code>。使用上与 ForeignKey 略有不同。<p>首先是访问 <code>OneToOneField</code> 时，得到的不是 <code>QuerySet</code> 而是一个对象实例。<pre class=language-python data-lang=python style=color:#fdf4c1aa;background-color:#282828><code class=language-python data-lang=python><span style=color:#928374;font-style:italic># 优生优育政策（
</span><span style=color:#fa5c4b>class </span><span style=color:#8ec07c>Parent</span><span>(</span><span style=color:#8ec07c>models.Model</span><span>):
</span><span>    child </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>OneToOneField(</span><span style=color:#b8bb26>'Child'</span><span style=color:#fdf4c1>)
</span><span>
</span><span style=color:#fa5c4b>class </span><span style=color:#8ec07c>Child</span><span>(</span><span style=color:#8ec07c>models.Model</span><span>):
</span><span>    </span><span style=color:#fa5c4b>pass
</span><span>
</span><span>parent.child </span><span style=color:#928374;font-style:italic># => 得到一个 Child 实例
</span></code></pre><p>其次是反向引用的名字是模型名字小写。<pre class=language-python data-lang=python style=color:#fdf4c1aa;background-color:#282828><code class=language-python data-lang=python><span>child.parent </span><span style=color:#928374;font-style:italic># => 得到一个 Parent 实例
</span></code></pre><p>如果指定 <code>related_name</code> 那就和 <code>ForeignKey</code> 一个表现。<h2 id=3-manytomanyfield>3. ManyToManyField</h2><p>基本和<code>ForeignKey</code>相同。<h3 id=3-1-he-foreignkey-xiang-tong-de-can-shu>3.1 和 <code>ForeignKey</code> 相同的参数</h3><ul><li>related_name<li>related_query_name<li>limited_choices_to<li>db_constraint<li>swappable</ul><p>limited_choices_to 在指定自定义中间表的情况下无效。<h3 id=3-2-can-shu-symmetrical>3.2 参数：symmetrical</h3><p>用于处理一个表自己对自己的多对多引用对称性。<p>Django 的默认行为是，我是你的朋友，那么你就是我的朋友。<p>设置了这个参数则强迫 Django 改变这个行为，允许“被朋友”。<h3 id=3-3-can-shu-through>3.3 参数：through</h3><p>默认情况下，Django 会自行创建中间表，这个参数强制指定中间表。<p>默认中间表模型里包含三个字段。<ul><li>id<li>&lt;containing_model>_id<li>&lt;other_model>_id</ul><p>如果是自己和自己的多对多关系，则<ul><li>id<li>from_&lt;model>_id<li>to_&lt;model>_id</ul><h3 id=3-4-can-shu-through-fields>3.4 参数：through_fields</h3><p>当自行指定中间表，中间表又包含了多个外键时，指定关联的外键用。<p>举例。<pre class=language-python data-lang=python style=color:#fdf4c1aa;background-color:#282828><code class=language-python data-lang=python><span style=color:#fa5c4b>class </span><span style=color:#8ec07c>ModelA</span><span>(</span><span style=color:#8ec07c>models.Model</span><span>):
</span><span>    b </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>models.ManyToManyField(ModelB, through</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>'ModelC'</span><span style=color:#fdf4c1>)
</span><span>
</span><span style=color:#fa5c4b>class </span><span style=color:#8ec07c>ModelB</span><span>(</span><span style=color:#8ec07c>models.Model</span><span>):
</span><span>    </span><span style=color:#fa5c4b>pass
</span><span>
</span><span style=color:#fa5c4b>class </span><span style=color:#8ec07c>ModelC</span><span>(</span><span style=color:#8ec07c>models.Model</span><span>):
</span><span>    a</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>models.ForeignKey(</span><span style=color:#b8bb26>'ModelA'</span><span style=color:#fdf4c1>)
</span><span>    b</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>models.ForeignKey(</span><span style=color:#b8bb26>'ModelB'</span><span style=color:#fdf4c1>)
</span><span>    c</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>models.ForeignKey(</span><span style=color:#b8bb26>'ModelA'</span><span style=color:#fdf4c1>)
</span></code></pre><p>此时在中间表中<code>a</code>和<code>c</code>都是对<code>ModelA</code>的外键，产生了歧义，Django 无法自行决定用哪个外键来关联 AB 两个表。<p>这时提供参数。<pre class=language-python data-lang=python style=color:#fdf4c1aa;background-color:#282828><code class=language-python data-lang=python><span>b </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>models.ManyToManyField(</span><span style=color:#b8bb26>'ModelB'</span><span style=color:#fdf4c1>, through</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>'ModelC'</span><span style=color:#fdf4c1>, through_fields</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>(a, b))
</span></code></pre><p><code>ManyToManyField</code> 关联两个表总是不对称的关系（指我把你当兄弟，你却想当我爸爸这样的关系。此时“我”对“你”的“兄弟”关系就是单向的。），这就形成了<strong>来源</strong>和<strong>目标</strong>的概念。<p><code>through_fields</code> 的第一个元素总被认为是<strong>来源</strong>字段，第二个元素是<strong>目标</strong>字段。<h3 id=3-5-can-shu-db-table>3.5 参数：db_table</h3><p>指定 Django 创建的中间表的名字，默认根据两个表表名和 <code>ManyToManyField</code> 的名字决定。</article><p class=tags-data><a href=/tags/django>/django/</a> <a href=/tags/python>/python/</a></p><script data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg0ODYyMTg=" async crossorigin data-category=Announcements data-category-id=DIC_kwDOF8Bqys4Cegmn data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-mapping=pathname data-reactions-enabled=1 data-repo=nnnewb/nnnewb.github.io data-strict=0 data-theme=noborder_light id=giscus_script src=https://giscus.app/client.js></script></main><footer><hr><div id=footer-container><div><p style=text-align:center>Copyright © 2018-2024 weakptr <a href=mailto:weak_ptr@outlook.com>&lt;weak_ptr@outlook.com></a><p style=text-align:center>Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme, <a rel="noopener noreferrer" href=https://speyll.github.io/suCSS/ target=_blank>suCSS</a> framework & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a>, modified by <a rel="noopener noreferrer" href=https://github.com/nnnewb/ target=_blank>nnnewb</a>.<p style=text-align:center>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.</div></div></footer>