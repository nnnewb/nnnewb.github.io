<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>排查一个kubectl无反应的问题</title><meta content=排查一个kubectl无反应的问题 name=title><meta content=一点点从这个世界上消失。 name=description><meta content=website property=og:type><meta content=https://nnnewb.github.io/posts/2021/why-my-kubectl-not-responding/ property=og:url><meta content="weakptr's blog" property=og:site_name><meta content=排查一个kubectl无反应的问题 property=og:title><meta content=一点点从这个世界上消失。 property=og:description><meta content=https://nnnewb.github.io/image/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nnnewb.github.io/posts/2021/why-my-kubectl-not-responding/ property=twitter:url><meta content=排查一个kubectl无反应的问题 property=twitter:title><meta content=一点点从这个世界上消失。 property=twitter:description><meta content=https://nnnewb.github.io/image/favicon.ico property=twitter:image><link href=https://nnnewb.github.io/posts/2021/why-my-kubectl-not-responding/ rel=canonical><link rel="shortcut icon" href=https://nnnewb.github.io/image/favicon.ico type=image/x-icon><link href=https://nnnewb.github.io/css/reset.css rel=stylesheet><link href=https://nnnewb.github.io/css/pallete.css rel=stylesheet><link href=https://nnnewb.github.io/css/suCSS.css rel=stylesheet><link href=https://nnnewb.github.io/archive.css rel=stylesheet><link href=https://nnnewb.github.io/style.css rel=stylesheet><script defer src=https://nnnewb.github.io/js/script.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: false }
            ],
            // • rendering keys, e.g.:
            throwOnError: true
        });
    });</script><script src=https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js></script><script>document.addEventListener('DOMContentLoaded', function () {
        // 查找所有具有 'pre' 标签且类名为 'language-mermaid' 的元素
        const mermaidElements = document.getElementsByClassName('language-mermaid');
        for (let i = 0; i < mermaidElements.length; i++) {
            const el = mermaidElements.item(i);
            if (el.tagName === "PRE" && !el.classList.contains('mermaid')) {
                el.innerHTML = el.textContent;
                el.classList.add('mermaid');
            }
        }

        mermaid.initialize({ startOnLoad: true, theme: 'dark', });
    })</script><script>if (window.location.hostname.toLowerCase() !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?dbb9df33a2de52aede8bccd84a7493ad";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }</script><link href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Medium/result.css rel=stylesheet><link href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css rel=stylesheet><body><header><nav id=nav-bar><a href=/> 首页 </a>  /  <a href=/posts/> 文章 </a>  /  <a href=/categories/> 分类 </a>  /  <a href=/tags/> 标签 </a>  /  <a href=/search/> 搜索 </a>  /  <div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://nnnewb.github.io/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://nnnewb.github.io/click.ogg type=audio/ogg></audio></div></nav></header><main><h1>排查一个kubectl无反应的问题</h1><p class=author-line>作于：2021-12-27 15:21 ，预计阅读时间 8 分钟<article><p>懒得分段了，就当做是讲个故事吧。<p>背景大概是这样。<p>内网公共开发机上配置了 k3s 集群，同时后端开发工作也在这台开发机上进行（通过vscode remote-ssh）。因为公司太抠门，开发机只有117G硬盘容量，除去必要的开发工具、系统环境之类的东西，实际可用一直没超过50%，机器上又跑了很多东西，像是 gitlab-runner、docker的registry、MySQL、elasticsearch、开发集群服务等等，差不多每一两个星期都会出现 disk-pressure 的 taint，导致 pod 被 evicted。实话说能跑就很满足了，毕竟公司抠门到开发部门的上行带宽都贼小，如果把镜像推送到公网的registry去部署的话体验更差。<p>今天（周一）来公司之后调了下gitlab-ci，给一个前端项目做持续部署。因为前端对kubernetes这套不熟悉，也没有相关的服务器权限，总之就是很难让他们自己来。但是产品部门又喜欢提那种“按钮移到右上角”、“加个图片”之类的需求（对，我司还没有需求管理系统，开发就是个撸码的无情工具人），前端老是过来找我去部署下环境，就搞得摸鱼都摸不痛快。<p>所以，当当当~当~，整一个持续部署呗，反正是个纯前端项目，不用部署配套的后端代码，写个dockerfile再写个helm chart就差不多了，ci调了调构建镜像就完事，不过因为ci部署需要访问集群，所以又改了下<code>.kube/config</code>，删了之前尝试<code>csr</code>方式添加用户的时候加多的 user 和 context ，复制了一份挂载到 runner 容器里。<p>然后......问题就来了。<p>同事忽然告诉我办公室的服务挂了，于是下意识地打出<code>kgp</code>，卡住。<p>等了一会儿，还是卡住。<p>又等了一会儿，坐不住了。试了下<code>kubectl cluster-info</code>，继续卡住。<p>开始慌了，想起今天的机器有点卡，先看看 <code>free -h</code> 有没有内存泄漏之类的问题导致阻塞，结果发现并没有，于是继续看 <code>htop</code>，cpu使用率也比较正常。再看<code>df -h | grep -vE 'shm|overlay'</code>，发现硬盘使用率96%（估计硬盘主控想死的心都有了，揪着4%的可用空间想把PE数平均到各个区块恐怕不容易）。<p>找到问题后松了口气，十有八九是又出现 evicted 了。二话不说直接 <code>docker system df</code>，看到30多G的 build cache 顿时惊了，肯定不是go的构建缓存（手动挂载优化了），那就是 node_modules 又立奇功了。node_modules=黑洞果然不是吹的。<p>清理完使用率恢复到63%，但依然有种不安感萦绕于心，于是再次尝试<code>kgp</code>，卡住。<p>等了一会儿，喝口水，继续卡着。<p>又等了一会儿，淦。<p>想了想，<code>journalctl -r -u k3s</code>看看日志，并没有什么发现，倒是注意到很多<code>linkerd</code>之类的我们部门经理搞事的时候遗留下来的玩意儿在报错，service mesh 我不熟，但寻思应该不会影响 kubectl 吧，k3s 本体的 api-server 应该不归 linkerd 管。更何况 linkerd 本身就没配好。再翻了翻看到下面的内容。<pre style=color:#fdf4c1aa;background-color:#282828><code><span>    6 12月 25 21:16:07 office k3s[794]: I1225 13:16:07.685149     794 container_gc.go:85] attempting to delete unused containers
</span><span>    7 12月 25 21:16:07 office k3s[794]: I1225 13:16:07.687723     794 image_gc_manager.go:321] attempting to delete unused images
</span><span>    8 12月 25 21:16:07 office k3s[794]: I1225 13:16:07.782390     794 eviction_manager.go:351] eviction manager: able to reduce ephemeral-storage pressure without evicting pods.
</span><span>    9 12月 25 21:16:17 office k3s[794]: W1225 13:16:17.939242     794 eviction_manager.go:344] eviction manager: attempting to reclaim ephemeral-storage
</span><span>   10 12月 25 21:16:17 office k3s[794]: I1225 13:16:17.939267     794 container_gc.go:85] attempting to delete unused containers
</span><span>   11 12月 25 21:16:17 office k3s[794]: I1225 13:16:17.941771     794 image_gc_manager.go:321] attempting to delete unused images
</span><span>   12 12月 25 21:16:18 office k3s[794]: I1225 13:16:18.033724     794 eviction_manager.go:351] eviction manager: able to reduce ephemeral-storage pressure without evicting pods.
</span><span>   13 12月 25 21:16:28 office k3s[794]: W1225 13:16:28.214032     794 eviction_manager.go:344] eviction manager: attempting to reclaim ephemeral-storage
</span></code></pre><p>这个是老问题了，一直没去研究怎么解决。<pre style=color:#fdf4c1aa;background-color:#282828><code><span>  154 12月 25 21:21:55 office k3s[794]: I1225 13:21:55.021937     794 image_gc_manager.go:304] [imageGCManager]: Disk usage on image filesystem is at 95% which is over the high threshold (85%). Trying to free 182  155 12月 25 21:21:55 office k3s[794]: E1225 13:21:55.025140     794 kubelet.go:1292] Image garbage collection failed multiple times in a row: failed to garbage collect required amount of images. Wanted to free
</span></code></pre><p>这次搜了下，应该是 <code>docker system prune</code> 造成 <code>kubelet</code> 找不到可回收的镜像才报错（猜测），不过依然不能解释为啥 <code>kubectl</code> 没反应。于是继续翻了会儿日志，搜索错误，但始终没有什么结果。<p>但是同事还要干活，没辙了，先重启下服务器吧。群里说了一声要重启了，等了一会儿跑<code>sudo reboot</code>，重启完连接，继续<code>kgp</code>，卡住。<p>嗯......<p>早有预料。<p><code>journalctl -r -u k3s --boot</code> 看看重启后的日志，发现还是老一套的问题，<code>docker</code> 手动处理镜像和容器造成的和 kubernetes 的管理机制的冲突，各种找不到镜像或者容器的警告，还有一些错误和trace，但没有一个能解释为什么<code>kubectl</code>没有反应。。。<p>直到在<code>kubectl</code>的终端里按下了ctrl+c，在顺手<code>clear</code>之前看到了一行请输入用户名（eng）...<p>警觉。<p>忽然想起来，因为 <code>kubectl</code> 这破玩意儿是没有颜色输出的，用习惯了各种彩色输出的命令行工具，<code>kubectl</code>就格外不顺眼。所以在发现<code>kubecolors</code>后，我就直接把<code>kubectl</code>配置成了<code>kubecolor</code>的别名。<p>所以......难道是<code>kubecolor</code>的问题？<p><code>whereis kubectl</code>找到<code>kubectl</code>的绝对路径之后，尝试手动运行<code>/usr/local/bin/kubectl cluster-info</code>，再次出现了那个输入用户名的提示，顿时开始怀疑起<code>.kube/config</code>配置有问题，正好在出现问题之前改过了<code>.kube/config</code>，这里出问题的嫌疑就很吉尔大。<p>于是打开<code>.kube/config</code>，检查了一下集群的用户配置，发现果然，是我手欠把办公室集群的用户给删了。草。<p>急忙从<code>/etc/rancher/k3s/k3s.yaml</code>复制下用户证书配置，贴进去，再运行<code>kgp</code>果然屁事没有了。<p>所以总结如下。<ol><li>别被表面的问题迷惑。<li>自己犯傻的几率大于基础设施/常用工具犯傻的几率。<li>遇到问题解决步骤很重要，准确的方向可以省很多时间。 <ol><li>先确定故障表现和复现条件<li>确定故障点（出现在网络、网关还是应用、数据库），弄清楚是不是新问题<li>再排查相关配置是否正确，回忆是否有做过相关修改变更<li>再排查故障点日志，必要的时候参考下代码，毕竟有的时候日志没写清楚错误的上下文</ol></ol></article><p class=tags-data><a href=/tags/linuxyun-wei>/linux运维/</a> <a href=/tags/kubernetes>/kubernetes/</a></p><script data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg0ODYyMTg=" async crossorigin data-category=Announcements data-category-id=DIC_kwDOF8Bqys4Cegmn data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-mapping=pathname data-reactions-enabled=1 data-repo=nnnewb/nnnewb.github.io data-strict=0 data-theme=noborder_light id=giscus_script src=https://giscus.app/client.js></script></main><footer><hr><div id=footer-container><div><p style=text-align:center>Copyright © 2018-2024 weakptr <a href=mailto:weak_ptr@outlook.com>&lt;weak_ptr@outlook.com></a><p style=text-align:center>Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme, <a rel="noopener noreferrer" href=https://speyll.github.io/suCSS/ target=_blank>suCSS</a> framework & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a>, modified by <a rel="noopener noreferrer" href=https://github.com/nnnewb/ target=_blank>nnnewb</a>.<p style=text-align:center>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.</div></div></footer>