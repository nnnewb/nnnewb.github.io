<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>升级公司的 GitLab</title><meta content="升级公司的 GitLab" name=title><meta content=一点点从这个世界上消失。 name=description><meta content=website property=og:type><meta content=https://nnnewb.github.io/posts/2021/2021-07-15-sheng-ji-gong-si-de-gitlab/ property=og:url><meta content="weakptr's blog" property=og:site_name><meta content="升级公司的 GitLab" property=og:title><meta content=一点点从这个世界上消失。 property=og:description><meta content=https://nnnewb.github.io/image/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nnnewb.github.io/posts/2021/2021-07-15-sheng-ji-gong-si-de-gitlab/ property=twitter:url><meta content="升级公司的 GitLab" property=twitter:title><meta content=一点点从这个世界上消失。 property=twitter:description><meta content=https://nnnewb.github.io/image/favicon.ico property=twitter:image><link href=https://nnnewb.github.io/posts/2021/2021-07-15-sheng-ji-gong-si-de-gitlab/ rel=canonical><link rel="shortcut icon" href=https://nnnewb.github.io/image/favicon.ico type=image/x-icon><link href=https://nnnewb.github.io/css/reset.css rel=stylesheet><link href=https://nnnewb.github.io/css/pallete.css rel=stylesheet><link href=https://nnnewb.github.io/css/suCSS.css rel=stylesheet><link href=https://nnnewb.github.io/archive.css rel=stylesheet><link href=https://nnnewb.github.io/style.css rel=stylesheet><script defer src=https://nnnewb.github.io/js/script.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: false }
            ],
            // • rendering keys, e.g.:
            throwOnError: true
        });
    });</script><script src=https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js></script><script>document.addEventListener('DOMContentLoaded', function () {
        // 查找所有具有 'pre' 标签且类名为 'language-mermaid' 的元素
        const mermaidElements = document.getElementsByClassName('language-mermaid');
        for (let i = 0; i < mermaidElements.length; i++) {
            const el = mermaidElements.item(i);
            if (el.tagName === "PRE" && !el.classList.contains('mermaid')) {
                el.innerHTML = el.textContent;
                el.classList.add('mermaid');
            }
        }

        mermaid.initialize({ startOnLoad: true, theme: 'dark', });
    })</script><script>if (window.location.hostname.toLowerCase() !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?dbb9df33a2de52aede8bccd84a7493ad";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }</script><link href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Medium/result.css rel=stylesheet><link href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css rel=stylesheet><body><header><nav id=nav-bar><a href=/> 首页 </a>  /  <a href=/posts/> 文章 </a>  /  <a href=/categories/> 分类 </a>  /  <a href=/tags/> 标签 </a>  /  <a href=/search/> 搜索 </a>  /  <div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://nnnewb.github.io/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://nnnewb.github.io/click.ogg type=audio/ogg></audio></div></nav></header><main><h1>升级公司的 GitLab</h1><p class=author-line>作于：2021-07-15 16:02 ，预计阅读时间 7 分钟<article><p>公司目前跑的 gitlab 是很久以前部署的，当前版本 <em>8.4.2</em> 。升级目标是 <em>13.12.Z</em> 。部署方式是 docker 。</p><span id=continue-reading></span><p>宿主机配置不高，系统 <em>Ubuntu 15.04</em> 。眼下这个时间，这个Ubuntu版本，基本宣告没法用了。直接在线升级容易把引导搞挂，到时候还得亲自去实体机上折腾引导，麻烦。暂时不管宿主机。<h2 id=qing-kuang-gai-shu>情况概述</h2><p>因为 GitLab 版本实在太低了，以至于连一个能集成的 CI/CD 工具都找不到。即使 jenkins 都只能很勉强地动起来，偏偏 jenkins 还不能满足需要（也可能是我太菜，反正公司没人玩得转 jenkins）。<p>但开发需要 CI/CD 来解决持续构建和部署的问题，不得不考虑升级了。<h2 id=1-bei-fen>1. 备份</h2><p>什么都别说了，开干前最重要的事情就是备份，免得把自己玩死。<p>最常用的备份手段自然是 <code>tar</code> 。不过 gitlab 数据目录实在太大了，要是直接运行 <code>tar -czpf gitlab.tar.gz ./gitlab</code> 不知道跑多久，也不知道有没有卡死。<p>于是上技术手段：用 <code>pv</code> 显示个进度条。<p>pv 项目的首页在 <a href=http://www.ivarch.com/programs/pv.shtml>ivarch.com</a>。因为服务器还在跑<em>ubuntu 15.10</em>，现在连个能用的源都没啦。只好下载了源码，在 wsl 里编译好推上去。<p>最终命令如下。<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sudo tar cf - ./gitlab -P </span><span style=color:#fe8019>| </span><span style=color:#fdf4c1>pv -s $(sudo du -sb ./gitlab </span><span style=color:#fe8019>| </span><span style=color:#fdf4c1>awk </span><span style=color:#b8bb26>'{print $1}'</span><span style=color:#fdf4c1>) </span><span style=color:#fe8019>| </span><span style=color:#fdf4c1>gzip </span><span style=color:#fe8019>></span><span style=color:#fdf4c1> gitlab.tar.gz
</span></code></pre><p>为啥 sudo 呢，postgres 数据库和 redis 数据都没有读权限，没辙。<h2 id=2-sheng-ji-zong-ti-si-lu>2. 升级总体思路</h2><p>gitlab 的手册还是比较全面的。在<a href=https://docs.gitlab.com/ee/update/index.html#upgrading-to-a-new-major-version>upgrading to a new major version</a> 这篇文档提到的说法，跨大版本升级主要分三步：<ol><li>升级至当前大版本(<em>major version</em>)的最新小版本(<em>latest minor version</em>)<li>升级至目标大版本(<em>target major version</em>)的首个小版本(<em>first minor version</em>)<li>继续升级至更新的版本</ol><p>根据 <a href=https://docs.gitlab.com/ee/update/index.html#upgrades-from-versions-earlier-than-812>gitlab upgrading guide 的说法</a>，版本低于 <em>8.11.Z</em> 时，先更新到 <em>8.12.0</em> 是比较稳妥的方案。<p>so 开干。<h2 id=3-sheng-ji-zhi-8-12-0>3. 升级至 8.12.0</h2><p>由于部署方式是 docker（准确的说是 docker-compose），所以按照<a href=https://docs.gitlab.com/ee/install/docker.html#update-gitlab-using-docker-engine>Update GitLab Using Docker Engine</a> 的说法，我们先停止容器，然后直接修改镜像标签。<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>docker-compose stop
</span></code></pre><pre class=language-yaml data-lang=yaml style=color:#fdf4c1aa;background-color:#282828><code class=language-yaml data-lang=yaml><span style=color:#8ec07c;font-weight:700>gitlab</span><span>:
</span><span>  </span><span style=color:#8ec07c;font-weight:700>restart</span><span>: </span><span style=color:#b8bb26>always
</span><span>  </span><span style=color:#8ec07c;font-weight:700>image</span><span>: </span><span style=color:#b8bb26>sameersbn/gitlab:8.12.0 </span><span style=color:#928374;font-style:italic># &lt;= sameersbn/gitlab:8.4.2
</span></code></pre><p>再启动<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>docker-compose up -d
</span></code></pre><h3 id=gu-zhang-gitlab-secrets-otp-key-base-must-set>故障：GITLAB_SECRETS_OTP_KEY_BASE must set</h3><p>使用的镜像 <code>sameersbn/docker-gitlab</code> 需要这几个环境变量，<a href=https://github.com/sameersbn/docker-gitlab#quick-start>参考文档</a>完成设置。<h3 id=gu-zhang-you-must-enable-the-pg-trgm-extension>故障：You must enable the pg_trgm extension</h3><p>这个故障就比较奇怪了，但还是可以处理。<p>先设置一下 postgres 账号密码<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>docker exec -it gitlab_postgresql_1 psql -U postgres
</span></code></pre><p>然后<pre class=language-sql data-lang=sql style=color:#fdf4c1aa;background-color:#282828><code class=language-sql data-lang=sql><span>\password postgres
</span></code></pre><p>输入新密码，按 ctrl+d 退出。<p>再用随便啥连接上去，运行 <code>create extension pg_trgm;</code> 就完事了。<p>最后就是重启下容器，gitlab 自动迁移完成后即可访问。<h2 id=4-sheng-ji-zhi-v8-17-4>4. 升级至 v8.17.4</h2><p>原本应该升级到 v8.17.7，但 <code>sameersbn/docker-gitlab</code> 没提供这个版本的镜像，只能先升级到 v8.17.4 ，求老天保佑别折腾出问题。<p>老规矩改了 docker-compose ，然后 up 。<p>直接成功，没有错误。<h2 id=5-sheng-ji-zhi-v9-5-5>5. 升级至 v9.5.5</h2><p>老规矩，还是缺少镜像，原本应该升级到 v9.5.10。<p>改了 docker-compose 再 up。<p>成功。<h2 id=6-sheng-ji-zhi-v10-8-4>6. 升级至 v10.8.4</h2><p>原本应该升级 v10.8.7 。懒得说了。改了 compose 再 up 。<h3 id=gu-zhang-this-probably-isn-t-the-expected-value-for-this-secret>故障：This probably isn't the expected value for this secret</h3><p>错误内容<pre style=color:#fdf4c1aa;background-color:#282828><code><span>This probably isn't the expected value for this secret. To keep using a literal Erb string in config/secrets.yml, replace &amp;lt;%with&amp;lt;%%.
</span></code></pre><p>不知道为什么，重启了一次容器后就恢复了。<p>可以参考下<a href=https://github.com/sameersbn/docker-gitlab/issues/1625>这个</a>。<h2 id=7-sheng-ji-zhi-v11-11-3>7. 升级至 v11.11.3</h2><p>根据 v12 的升级指引，<blockquote><p>In 12.0.0 we made various database related changes. These changes require that users first upgrade to the latest 11.11 patch release.</blockquote><p>必须先升级到 v11.11.Z 版本，再升级 v12.0.Z 才能完成数据库迁移。<p>于是先升级到 v11.11.3 (也是因为没有 v11.11.8 的镜像)。<p>成功。<h2 id=8-sheng-ji-zhi-v12-0-4>8. 升级至 v12.0.4</h2><p>根据 12.0 升级指引，先升级到 12.0.Z 版本来完成 11->12 的迁移，再继续升级。<p>成功。<h2 id=9-sheng-ji-zhi-v12-1-6>9. 升级至 v12.1.6</h2><p>根据 12.1 升级指引，在升级到 12.10.Z 之前，必须先升级到 12.1.Z 。<blockquote><p>If you are planning to upgrade from 12.0.Z to 12.10.Z, it is necessary to perform an intermediary upgrade to 12.1.Z before upgrading to 12.10.Z to avoid issues like #215141.</blockquote><p>成功。<h2 id=10-sheng-ji-zhi-v12-10-6-1>10. 升级至 v12.10.6-1</h2><p>缺少最新的 12.10.Z 镜像，先升级到能升级到的 12.10.Z 最高版本。<p>成功。<h2 id=11-sheng-ji-zhi-v13-0-6>11. 升级至 v13.0.6</h2><p>这个版本对 postgres 数据库版本有要求，故升级 postgresql 到 9.6.4 版本。镜像自动完成了数据迁移。<p>之后启动 gitlab 完成升级。<p>成功。<h2 id=12-sheng-ji-zhi-v13-12-4>12. 升级至 v13.12.4</h2><p>这个版本对 postgres 数据库版本又有要求，最低在 11 以上，故升级 postgresql 到 11-20200524 (sameersbn/postgresql)。<p>同时，需要安装插件 <code>btree_gist</code>，故连接 postgresql 数据库创建。<pre class=language-sql data-lang=sql style=color:#fdf4c1aa;background-color:#282828><code class=language-sql data-lang=sql><span>create extension if not </span><span style=color:#fe8019>exists</span><span> btree_gist;
</span></code></pre><p>之后启动 gitlab 完成升级。<h2 id=13-zong-jie>13. 总结</h2><p>由于 gitlab 设计良好，升级基本没有太大难度。按照文档的升级路线逐个版本升级即可。<p>也是我运气好，在升级 10.8.Z 版本的时候遇到的问题重启后自己消失了，不然光是这个问题可能就要折腾很久。<p>最终 gitlab 版本停留在 13.12.Z ，14.0 虽然已经发布了，但出于稳定考虑还是先不升级。</article><p class=tags-data><a href=/tags/linuxyun-wei>/linux运维/</a></p><script data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg0ODYyMTg=" async crossorigin data-category=Announcements data-category-id=DIC_kwDOF8Bqys4Cegmn data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-mapping=pathname data-reactions-enabled=1 data-repo=nnnewb/nnnewb.github.io data-strict=0 data-theme=noborder_light id=giscus_script src=https://giscus.app/client.js></script></main><footer><hr><div id=footer-container><div><p style=text-align:center>Copyright © 2018-2024 weakptr <a href=mailto:weak_ptr@outlook.com>&lt;weak_ptr@outlook.com></a><p style=text-align:center>Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme, <a rel="noopener noreferrer" href=https://speyll.github.io/suCSS/ target=_blank>suCSS</a> framework & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a>, modified by <a rel="noopener noreferrer" href=https://github.com/nnnewb/ target=_blank>nnnewb</a>.<p style=text-align:center>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.</div></div></footer>