<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>MySQL XA 事务和分布式事务处理模型：2阶段提交</title><meta content="MySQL XA 事务和分布式事务处理模型：2阶段提交" name=title><meta content=一点点从这个世界上消失。 name=description><meta content=website property=og:type><meta content=https://nnnewb.github.io/posts/2021/mysql-xa-distributed-transaction-processing-model-2pc/ property=og:url><meta content="weakptr's blog" property=og:site_name><meta content="MySQL XA 事务和分布式事务处理模型：2阶段提交" property=og:title><meta content=一点点从这个世界上消失。 property=og:description><meta content=https://nnnewb.github.io/image/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://nnnewb.github.io/posts/2021/mysql-xa-distributed-transaction-processing-model-2pc/ property=twitter:url><meta content="MySQL XA 事务和分布式事务处理模型：2阶段提交" property=twitter:title><meta content=一点点从这个世界上消失。 property=twitter:description><meta content=https://nnnewb.github.io/image/favicon.ico property=twitter:image><link href=https://nnnewb.github.io/posts/2021/mysql-xa-distributed-transaction-processing-model-2pc/ rel=canonical><link rel="shortcut icon" href=https://nnnewb.github.io/image/favicon.ico type=image/x-icon><link href=https://nnnewb.github.io/css/reset.css rel=stylesheet><link href=https://nnnewb.github.io/css/pallete.css rel=stylesheet><link href=https://nnnewb.github.io/css/suCSS.css rel=stylesheet><link href=https://nnnewb.github.io/archive.css rel=stylesheet><link href=https://nnnewb.github.io/style.css rel=stylesheet><script defer src=https://nnnewb.github.io/js/script.js></script><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y rel=stylesheet><script crossorigin defer integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js></script><script crossorigin defer integrity=sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js></script><script crossorigin defer integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            // customised options
            // • auto-render specific keys, e.g.:
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: false }
            ],
            // • rendering keys, e.g.:
            throwOnError: true
        });
    });</script><script src=https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js></script><script>document.addEventListener('DOMContentLoaded', function () {
        // 查找所有具有 'pre' 标签且类名为 'language-mermaid' 的元素
        const mermaidElements = document.getElementsByClassName('language-mermaid');
        for (let i = 0; i < mermaidElements.length; i++) {
            const el = mermaidElements.item(i);
            if (el.tagName === "PRE" && !el.classList.contains('mermaid')) {
                el.innerHTML = el.textContent;
                el.classList.add('mermaid');
            }
        }

        mermaid.initialize({ startOnLoad: true, theme: 'dark', });
    })</script><script>if (window.location.hostname.toLowerCase() !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?dbb9df33a2de52aede8bccd84a7493ad";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }</script><link href=https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Medium/result.css rel=stylesheet><link href=https://chinese-fonts-cdn.deno.dev/packages/maple-mono-cn/dist/MapleMono-CN-Regular/result.css rel=stylesheet><body><header><nav id=nav-bar><a href=/> 首页 </a>  /  <a href=/posts/> 文章 </a>  /  <a href=/categories/> 分类 </a>  /  <a href=/tags/> 标签 </a>  /  <a href=/search/> 搜索 </a>  /  <div><input id=theme-toggle style=display:none type=checkbox><label for=theme-toggle id=theme-toggle-label><svg class=icons id=theme-icon><use href=https://nnnewb.github.io/icons.svg#lightMode></use></svg></label><audio id=theme-sound><source src=https://nnnewb.github.io/click.ogg type=audio/ogg></audio></div></nav></header><main><h1>MySQL XA 事务和分布式事务处理模型：2阶段提交</h1><p class=author-line>作于：2021-07-09 09:29 ，预计阅读时间 10 分钟<article><p>关于 MySQL XA 事务和 2PC（两阶段提交）分布式事务处理模型（<em>Distributed Transaction Processing, DTP Model</em>）的学习笔记。</p><span id=continue-reading></span><h2 id=shi-wu>事务</h2><h3 id=fen-bu-shi-shi-wu-xa>分布式事务XA</h3><h4 id=jie-shao>介绍</h4><p>MySQL内建分布式事务支持（<code>XA</code>），参考文档列出如下<ul><li>[MySQL Manual - XA](<a href=https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_xa>MySQL :: MySQL 8.0 Reference Manual :: MySQL Glossary</a>)<li>[MySQL Manual - XA Transaction](<a href=https://dev.mysql.com/doc/refman/8.0/en/xa.html>MySQL :: MySQL 8.0 Reference Manual :: 13.3.8 XA Transactions</a>)<li>[MySQL Manual - XA Transaction Statements](<a href=https://dev.mysql.com/doc/refman/8.0/en/xa-statements.html>MySQL :: MySQL 8.0 Reference Manual :: 13.3.8.1 XA Transaction SQL Statements</a>)<li>[MySQL Manual - XA Transaction State](<a href=https://dev.mysql.com/doc/refman/8.0/en/xa-states.html>MySQL :: MySQL 8.0 Reference Manual :: 13.3.8.2 XA Transaction States</a>)</ul><p>XA 事务在 InnoDB 引擎中可用。MySQL XA 事务实现基于 X/Open CAE 文档 《Distributed Transaction Processing: The XA Specification》。这份文档由 <em>Open Group</em> 发布，可以在 http://www.opengroup.org/public/pubs/catalog/c193.htm 访问。当前 XA 实现的局限可以在 <a href=https://dev.mysql.com/doc/refman/8.0/en/xa-restrictions.html>Section 13.3.8.3, “Restrictions on XA Transactions”</a> 查看。<p>...<p>XA 事务是全局事务关联的一组事务性动作，要么全部成功，要么全部回滚。本质上，这是让 ACID 属性“提升了一层”，让多个ACID事务可以作为一个全局操作的一部分执行，使得这个全局操作也具备ACID属性。（对于非分布式事务，应用如果对读敏感，则<code>SERIALIZABLE</code>更推荐。<code>REPEATABLE READ</code> 在分布式事务中并不是很有效。）<h4 id=shi-wu-mo-xing>事务模型</h4><p><img alt=DTM src=https://nnnewb.github.io/posts/2021/mysql-xa-distributed-transaction-processing-model-2pc/./DTM.webp><p>其中：<ul><li>**AP：**用户程序<li>**RMs：**数据库<li>**TM：**事务管理器</ul><p>用户程序不用介绍。<p>根据 Open Group 在 Distributed Transaction Processing Model 中的定义，一个典型的 RM 可以是一个支持事务的数据库（DBMS）。<p>TM 则是协调整个二阶段提交过程的中介。AP从TM获得XID，完成 <code>XA START</code> 到 <code>XA END</code> ，然后告知 TM 就绪。TM提取本次事务的所有XID，向RMs发出<code>XA PREPARE</code>请求，如果失败则对每个 XID 发出 <code>XA ROLLBACK</code> ，成功则继续发出 <code>XA COMMIT</code> 。<p>需注意的是，<code>XA PREPARE</code> 失败可以通知其他事务回滚，但<code>XA COMMIT</code> 失败则只能等待数据库恢复，再行重试。<code>XA PREPARE</code>一旦成功，则<code>XA COMMIT</code> 一定成功（或者说必须成功）。<p>TM 实现要求自身崩溃后必须能清理恢复，防止出现XA事务死锁。<ul><li>继续 PREPARE 需要提交的事务<li>继续 ROLLBACK 未完成 ROLLBACK 的事务<li>继续 COMMIT 未能 COMMIT 的事务 <ul><li>未能 COMMIT 成功则需要重试直到成功</ul></ul><p>几个 TM 角色（或整套方案）的实现：<ul><li><a href=https://github.com/seata/seata/>seata/seata: Seata is an easy-to-use, high-performance, open source distributed transaction solution. (github.com)</a><li><a href="https://open.unionpay.com/tjweb/product/detail?proId=43">UPSQL Proxy-技术产品- 中国银联开放平台 (unionpay.com)</a><li><a href=https://cloud.tencent.com/product/dcdb/>分布式数据库TDSQL MySQL版_企业级分布式数据库解决方案 - 腾讯云 (tencent.com)</a></ul><h4 id=ji-ben-yong-fa>基本用法</h4><pre class=language-sql data-lang=sql style=color:#fdf4c1aa;background-color:#282828><code class=language-sql data-lang=sql><span>XA {START|</span><span style=color:#fa5c4b>BEGIN</span><span>} xid [</span><span style=color:#fa5c4b>JOIN</span><span>|RESUME]
</span><span>
</span><span>XA </span><span style=color:#fa5c4b>END</span><span> xid [SUSPEND [FOR MIGRATE]]
</span><span>
</span><span>XA PREPARE xid
</span><span>
</span><span>XA </span><span style=color:#fa5c4b>COMMIT</span><span> xid [ONE PHASE]
</span><span>
</span><span>XA </span><span style=color:#fa5c4b>ROLLBACK</span><span> xid
</span><span>
</span><span>XA RECOVER [</span><span style=color:#fabd2f>CONVERT</span><span> XID]
</span></code></pre><p>其中 <code>XA START</code> 后跟随的 <code>JOIN</code>和<code>RESUME</code>子句没有任何效果。<p><code>XA END</code> 后跟随的 <code>SUSPEND</code> 和 <code>FOR MIGRATE</code> 子句也没有任何效果。<p>任何<code>XA</code>语句都以<code>XA</code>关键字开头，大多<code>XA</code>语句都需要<code>xid</code>值。<code>xid</code> 是 <strong>XA事务的标识符</strong> ，它确定语句应用到哪个XA事务上。<p><code>xid</code>值可以由客户端指定或 MySQL 服务器生成。<p>一个<code>xid</code>值有一到三个部分：<pre style=color:#fdf4c1aa;background-color:#282828><code><span>xid: gtrid [, bqual [, formatID ]]
</span></code></pre><p><code>gtrid</code> 是<strong>全局事务标识符</strong> ，<code>bqual</code> 是<strong>分支修饰符</strong>，<code>formatID</code>是一个标记 <code>gtrid</code> 和 <code>bqual</code> 格式的数字。<p><code>gtrid</code> 和 <code>bqual</code> 必须是字符串字面量，最多不超过 64 <strong>字节</strong> 长。<code>gtrid</code> 和 <code>bqual</code> 可以以多种方式指定，可以用引号包围的字符串（<code>'ab'</code>）；十六进制字符串（<code>X'6162'</code>，<code>0x6162</code>）；或者二进制值（<code>b'nnn'</code>）。<p><code>formatID</code> 必须是一个无符号整数。<p><code>gtrid</code> 和 <code>bqual</code> 值在 MySQL 服务器的底层 XA 支持程序中被解释为字节。不过，服务器在解释包含XA语句的SQL时，可能设置了特定字符集。安全起见，最好将 <code>gtrid</code> 和 <code>bqual</code> 写作十六进制字符串形式。<p><code>xid</code> 值通常是由事务管理器生成。一个事务管理器产生的<code>xid</code>必须与另一个事务管理器产生的<code>xid</code>不同。一个给定的事务管理器必须能在 <code>XA RECOVER</code> 返回的 <code>xid</code> 列表中识别出属于自己的 <code>xid</code> 。<p><code>XA START xid</code> 以指定的 <code>xid</code> 开启一个新 XA 事务。每个 XA 事务必须包含一个唯一的 <code>xid</code> ，<code>xid</code> 不能正在被另一个 XA 事务使用。唯一性通过 <code>gtrid</code> 与 <code>bqual</code> 评估。该 XA 事务的后续 XA 语句都必须指定<code>XA START</code>中指定的 <code>xid</code>。如果使用XA语句但没有指定一个对应XA事务的<code>xid</code>，则产生一个错误。<p>多个XA事务可以是同一个全局事务的组成部分。在同一个全局事务中所有XA事务的<code>xid</code>必须使用同一个 <code>gtrid</code> 值。因此，<code>gtrid</code> 必须全局唯一以避免混淆。全局事务中XA事务<code>xid</code> 的 <code>bqual</code> 部分必须互不相同。（要求 <code>bqual</code> 不同是当前MySQL实现的限制，并不是XA规范的一部分。）<p><code>XA RECOVER</code> 语句返回 MySQL 服务器中处于 <code>PREPARED</code> 状态的 XA 事务信息。输出中每一行都是一个服务器上的 XA 事务，不论是哪个客户端启动的事务。<p>执行 <code>XA RECOVER</code> 需要 <code>XA_RECOVER_ADMIN</code> 特权。这个特权需求是为了防止用户发现其他不属于自己的事务<code>xid</code>，不影响XA事务的正常提交和回滚。<p><code>XA RECOVER</code> 输出类似下面这样<pre class=language-sql data-lang=sql style=color:#fdf4c1aa;background-color:#282828><code class=language-sql data-lang=sql><span>mysql</span><span style=color:#fe8019>></span><span> XA RECOVER;
</span><span style=color:#fe8019>+</span><span style=color:#928374;font-style:italic>----------+--------------+--------------+--------+
</span><span>| formatID | gtrid_length | bqual_length | data   |
</span><span style=color:#fe8019>+</span><span style=color:#928374;font-style:italic>----------+--------------+--------------+--------+
</span><span>|        </span><span style=color:#d3869b>7</span><span> |            </span><span style=color:#d3869b>3</span><span> |            </span><span style=color:#d3869b>3</span><span> | abcdef |
</span><span style=color:#fe8019>+</span><span style=color:#928374;font-style:italic>----------+--------------+--------------+--------+
</span></code></pre><p>其中：<ul><li><code>formatID</code> 是 <code>xid</code> 中的 <code>formatID</code> 部分<li><code>gtrid_length</code> 是 <code>xid</code> 中 <code>gtrid</code> 部分的长度（字节单位）<li><code>bqual_length</code> 是 <code>xid</code> 中 <code>bqual</code> 部分的长度（字节单位）</ul><p>XID值可能包含不可打印的字符。<code>XA RECOVER</code> 允许一个可选的 <code>CONVERT XID</code> 子句，以便客户端可以请求十六进制格式的 XID 值。<h4 id=shi-wu-zhuang-tai>事务状态</h4><p>一个 XA 事务经历以下状态<ol><li>使用<code>XA START</code>启动的XA事务，进入<code>ACTIVE</code>状态。<li>一个处于<code>ACTIVE</code>状态的XA事务，可以发出SQL语句填充事务，然后发出<code>XA END</code>语句。<code>XA END</code>语句令XA事务进入<code>IDLE</code>状态。<li>一个处于<code>IDLE</code>状态的XA事务，可以发出<code>XA PREPARE</code>语句或<code>XA COMMIT ... ONE PHASE</code>语句。 <ul><li><code>XA PREPARE</code> 语句令XA事务进入<code>PREPARED</code> 状态。<code>XA RECOVER</code> 语句此时可以发现并列出此事务的 XID。<code>XA RECOVER</code> 可以列出所有处于 <code>PREPARED</code> 状态的 XA 事务的 XID。<li><code>XA COMMIT ... ONE PHASE</code> 准备并提交XA事务。<code>xid</code>不会列出在<code>XA RECOVER</code>中，因为XA事务实际在执行语句后就结束了。</ul><li>一个处于<code>PREPARED</code>状态的XA事务，可以发出<code>XA COMMIT</code>语句来提交并结束XA事务，或发出<code>XA ROLLBACK</code>来回滚并结束事务。</ol><p>下面是一个简单的XA事务例子，作为一个全局事务，插入一个行。<pre class=language-sql data-lang=sql style=color:#fdf4c1aa;background-color:#282828><code class=language-sql data-lang=sql><span>mysql</span><span style=color:#fe8019>></span><span> XA START </span><span style=color:#b8bb26>'xatest'</span><span>;
</span><span>Query OK, </span><span style=color:#d3869b>0</span><span> rows affected (</span><span style=color:#d3869b>0</span><span>.</span><span style=color:#d3869b>00</span><span> sec)
</span><span>
</span><span>mysql</span><span style=color:#fe8019>> </span><span style=color:#fa5c4b>INSERT INTO</span><span> mytable (i) </span><span style=color:#fa5c4b>VALUES</span><span>(</span><span style=color:#d3869b>10</span><span>);
</span><span>Query OK, </span><span style=color:#d3869b>1</span><span> row affected (</span><span style=color:#d3869b>0</span><span>.</span><span style=color:#d3869b>04</span><span> sec)
</span><span>
</span><span>mysql</span><span style=color:#fe8019>></span><span> XA </span><span style=color:#fa5c4b>END </span><span style=color:#b8bb26>'xatest'</span><span>;
</span><span>Query OK, </span><span style=color:#d3869b>0</span><span> rows affected (</span><span style=color:#d3869b>0</span><span>.</span><span style=color:#d3869b>00</span><span> sec)
</span><span>
</span><span>mysql</span><span style=color:#fe8019>></span><span> XA PREPARE </span><span style=color:#b8bb26>'xatest'</span><span>;
</span><span>Query OK, </span><span style=color:#d3869b>0</span><span> rows affected (</span><span style=color:#d3869b>0</span><span>.</span><span style=color:#d3869b>00</span><span> sec)
</span><span>
</span><span>mysql</span><span style=color:#fe8019>></span><span> XA </span><span style=color:#fa5c4b>COMMIT </span><span style=color:#b8bb26>'xatest'</span><span>;
</span><span>Query OK, </span><span style=color:#d3869b>0</span><span> rows affected (</span><span style=color:#d3869b>0</span><span>.</span><span style=color:#d3869b>00</span><span> sec)
</span></code></pre><p>在给定客户端连接的上下文中，XA事务和本地事务彼此互斥。举例来说，如果<code>XA START</code>发出并启动了一个XA事务，此时不能再启动一个本地事务直到XA事务被提交或回滚。反过来说，如果一个本地事务已经通过<code>START TRANSACTION</code>启动，则不能执行任何XA语句直到本地事务被提交或回滚。<p>如果一个XA事务在<code>ACTIVE</code>状态，则不能发出任何产生隐式提交的语句（如 <code>create table</code>），因为这违反了XA协议，导致不能回滚XA事务。尝试执行这类语句会导致一个错误：<pre style=color:#fdf4c1aa;background-color:#282828><code><span>ERROR 1399 (XAE07): XAER_RMFAIL: The command cannot be executed
</span><span>when global transaction is in the ACTIVE state
</span></code></pre><h4 id=xa-shi-wu-shi-yan>XA 事务实验</h4><p>准备数据库<pre class=language-sql data-lang=sql style=color:#fdf4c1aa;background-color:#282828><code class=language-sql data-lang=sql><span style=color:#fa5c4b>create database </span><span>if not exists </span><span style=color:#8ec07c>test</span><span>;
</span><span style=color:#fa5c4b>create table </span><span>if not exists </span><span style=color:#8ec07c>test123</span><span> (
</span><span>  </span><span style=color:#b8bb26>`id` </span><span style=color:#fa5c4b>bigint primary key</span><span> auto_increment,
</span><span>  </span><span style=color:#b8bb26>`name` </span><span style=color:#fa5c4b>varchar</span><span>(</span><span style=color:#d3869b>64</span><span>) </span><span style=color:#fe8019>not </span><span style=color:#d3869b>null
</span><span>);
</span></code></pre><p>启动一个 XA 事务，插入表，最后提交。<pre class=language-sql data-lang=sql style=color:#fdf4c1aa;background-color:#282828><code class=language-sql data-lang=sql><span>xa start </span><span style=color:#b8bb26>'this-is-gtrid'</span><span>,</span><span style=color:#b8bb26>'this-is-bqual'</span><span>;
</span><span style=color:#fa5c4b>insert into</span><span> test123(name) </span><span style=color:#fa5c4b>values</span><span>(</span><span style=color:#b8bb26>'distributed transaction!'</span><span>);
</span><span>xa </span><span style=color:#fa5c4b>end </span><span style=color:#b8bb26>'this-is-gtrid'</span><span>,</span><span style=color:#b8bb26>'this-is-bqual'</span><span>;
</span><span>
</span><span style=color:#928374;font-style:italic>-- 准备
</span><span>xa prepare </span><span style=color:#b8bb26>'this-is-gtrid'</span><span>,</span><span style=color:#b8bb26>'this-is-bqual'</span><span>;
</span><span>
</span><span style=color:#928374;font-style:italic>-- 应该看到上一步 prepare 的 xa 事务
</span><span>xa recover;
</span><span>
</span><span style=color:#928374;font-style:italic>-- 提交 xa 事务。
</span><span>xa </span><span style=color:#fa5c4b>commit </span><span style=color:#b8bb26>'this-is-gtrid'</span><span>,</span><span style=color:#b8bb26>'this-is-bqual'</span><span>;
</span><span style=color:#928374;font-style:italic>-- 或者 rollback
</span><span style=color:#928374;font-style:italic>-- xa rollback 'this-is-gtrid','this-is-bqual';
</span></code></pre><p>执行完成后，可以发现表中多了一条记录<pre class=language-sql data-lang=sql style=color:#fdf4c1aa;background-color:#282828><code class=language-sql data-lang=sql><span style=color:#fa5c4b>select </span><span style=color:#fdf4c1>* </span><span style=color:#fa5c4b>from</span><span> test123;
</span></code></pre></article><p class=tags-data><a href=/tags/mysql>/mysql/</a></p><script data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg0ODYyMTg=" async crossorigin data-category=Announcements data-category-id=DIC_kwDOF8Bqys4Cegmn data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-mapping=pathname data-reactions-enabled=1 data-repo=nnnewb/nnnewb.github.io data-strict=0 data-theme=noborder_light id=giscus_script src=https://giscus.app/client.js></script></main><footer><hr><div id=footer-container><div><p style=text-align:center>Copyright © 2018-2024 weakptr <a href=mailto:weak_ptr@outlook.com>&lt;weak_ptr@outlook.com></a><p style=text-align:center>Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme, <a rel="noopener noreferrer" href=https://speyll.github.io/suCSS/ target=_blank>suCSS</a> framework & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a>, modified by <a rel="noopener noreferrer" href=https://github.com/nnnewb/ target=_blank>nnnewb</a>.<p style=text-align:center>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.</div></div></footer>